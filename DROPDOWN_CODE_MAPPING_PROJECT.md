# 드롭다운 코드-값 매핑 시스템 리팩토링 프로젝트

**프로젝트 시작일**: 2025-08-23  
**프로젝트 상태**: 🚧 진행중  
**우선순위**: ⭐⭐⭐⭐⭐ 최우선

---

## 📋 목차
1. [프로젝트 배경 및 목적](#프로젝트-배경-및-목적)
2. [핵심 요구사항](#핵심-요구사항)
3. [시스템 설계](#시스템-설계)
4. [개발 로드맵](#개발-로드맵)
5. [현재 진행상황](#현재-진행상황)
6. [기술적 핵심사항](#기술적-핵심사항)
7. [리스크 및 대응방안](#리스크-및-대응방안)
8. [테스트 계획](#테스트-계획)

---

## 🎯 프로젝트 배경 및 목적

### 배경
현재 시스템은 드롭다운 옵션을 단순 JSON 배열로 저장하고 있어 다음과 같은 문제점이 있음:
- 표시 값 변경 시 기존 데이터 불일치
- 다국어 지원 어려움
- 데이터 일관성 보장 어려움
- 현업 담당자의 잦은 값 변경 요구에 대응 어려움

### 목적
**코드-값 매핑 방식**으로 전환하여:
- 코드는 불변, 표시 값만 변경 가능
- 기존 데이터 무결성 유지
- 유연한 값 변경 대응
- 향후 다국어 지원 기반 마련

---

## 📌 핵심 요구사항

### 사용자 요구사항
1. **엑셀형 편집 인터페이스**
   - 행 추가/삭제 쉬운 UI
   - 드래그 앤 드롭으로 순서 변경
   - 실시간 편집 가능

2. **코드-값 분리 관리**
   - 코드: 시스템 내부 사용 (예: STS001, STS002)
   - 값: 화면 표시용 (예: 진행중, 완료)
   - 값 변경 시 기존 데이터 자동 반영

3. **현업 친화적 관리 도구**
   - 비개발자도 쉽게 값 변경 가능
   - 변경 이력 추적
   - 실수 방지 장치

### 시스템 요구사항
1. **데이터 마이그레이션**
   - 기존 JSON 방식 → 코드 매핑 방식
   - 무중단 전환
   - 롤백 가능

2. **성능**
   - 대량 데이터에서도 빠른 조회
   - 효율적인 캐싱

3. **확장성**
   - 다른 모듈에도 적용 가능
   - API 표준화

---

## 🏗️ 시스템 설계

### 데이터베이스 설계

#### 기존 구조
```sql
-- accident_column_config 테이블
dropdown_options TEXT  -- JSON: ["진행중", "완료", "취소"]
```

#### 새로운 구조
```sql
-- dropdown_option_codes 테이블
CREATE TABLE dropdown_option_codes (
    id INTEGER PRIMARY KEY,
    column_key TEXT,        -- 컬럼 식별자
    option_code TEXT,       -- 코드 (불변)
    option_value TEXT,      -- 표시 값 (변경 가능)
    display_order INTEGER,  -- 표시 순서
    is_active INTEGER,      -- 활성화 여부
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    UNIQUE(column_key, option_code)
);
```

### API 설계

#### 1. 코드 조회
```
GET /api/dropdown-codes/{column_key}
Response: [
    {"code": "STS001", "value": "진행중", "order": 1},
    {"code": "STS002", "value": "완료", "order": 2}
]
```

#### 2. 코드 저장/수정
```
POST /api/dropdown-codes
Body: {
    "column_key": "column3",
    "codes": [
        {"code": "STS001", "value": "처리중"},
        {"code": "STS002", "value": "완료"}
    ]
}
```

### UI 구조
```
┌─────────────────────────────────────────┐
│           관리자 페이지 헤더              │
├──────────────┬──────────────────────────┤
│              │                          │
│  컬럼 목록   │    코드 편집기           │
│              │  ┌─────┬──────┬──────┐  │
│  ▶ 처리상태  │  │코드 │표시값│ 삭제 │  │
│    진행상태  │  ├─────┼──────┼──────┤  │
│    사고유형  │  │STS001│진행중│  🗑   │  │
│              │  │STS002│완료  │  🗑   │  │
│              │  └─────┴──────┴──────┘  │
│              │     [+ 행 추가]          │
└──────────────┴──────────────────────────┘
```

---

## 🗺️ 개발 로드맵

### Phase 1: 기초 구축 ✅ (완료)
- [x] DB 스키마 설계 및 테이블 생성
- [x] 기본 API 엔드포인트 구현
- [x] 초기 데이터 마이그레이션 스크립트
- [x] 관리자 UI V3 개발

### Phase 2: 핵심 기능 구현 🚧 (진행중)
- [ ] 드롭다운 코드 CRUD 완성
- [ ] 엑셀형 편집기 고도화
- [ ] 변경 이력 추적 기능
- [ ] 권한 관리 (편집 권한)

### Phase 3: 시스템 통합 📅 (예정)
- [ ] 사고 등록 페이지 연동
- [ ] 사고 조회 페이지 연동
- [ ] 협력사 페이지 연동
- [ ] 기존 데이터 완전 마이그레이션

### Phase 4: 고급 기능 🔮 (계획)
- [ ] 일괄 변경 기능
- [ ] 엑셀 임포트/익스포트
- [ ] 다국어 지원 준비
- [ ] 버전 관리 시스템

### Phase 5: 최적화 및 배포 🚀 (미정)
- [ ] 성능 최적화
- [ ] 캐싱 전략 구현
- [ ] 운영 환경 마이그레이션
- [ ] 모니터링 체계 구축

---

## 📊 현재 진행상황

### ✅ Phase 1: 기초 구축 (완료)
1. **데이터베이스**
   - `dropdown_option_codes` 테이블 생성 ✅
   - 인덱스 설정 완료 ✅
   - 초기 데이터 마이그레이션 (처리상태 4개 옵션) ✅

2. **백엔드**
   - `/api/dropdown-codes/<column_key>` GET 엔드포인트 ✅
   - `/api/dropdown-codes` POST 엔드포인트 ✅
   - 라우트 설정 (v2, v3) ✅

3. **프론트엔드**
   - V2: 기본 데모 UI ✅
   - V3: 완전한 코드 편집기 UI ✅
   - 드래그 앤 드롭 기능 ✅

### ✅ Phase 2: 핵심 기능 구현 (완료 - 2025-08-23)
1. **드롭다운 코드 CRUD 완성** ✅
   - Enhanced 버전 UI 개발
   - 전체 선택/일괄 삭제
   - 값 유효성 검증
   - 중복 체크
   - 자동 코드 생성

2. **엑셀형 편집기 고도화** ✅
   - 검색 기능
   - 통계 패널
   - 토스트 알림
   - 키보드 단축키 (Ctrl+S, Ctrl+A)
   - 자동 저장 (5분)
   - 가져오기/내보내기 (JSON)

3. **변경 이력 추적 기능** ✅
   - `dropdown_code_audit` 테이블 생성
   - 모든 CRUD 작업 로깅
   - IP 주소, User-Agent 기록
   - 통계 뷰 생성
   - `/api/dropdown-codes/<column_key>/history` API
   - `/api/dropdown-codes/audit-summary` API

### ✅ Phase 3: 시스템 통합 (완료 - 2025-08-23)
- [x] 사고 등록 페이지 연동
- [x] 사고 조회 페이지 연동
- [x] 협력사 기준정보 페이지 연동
- [x] 기존 데이터 완전 마이그레이션 (13건 성공)
- [x] DictAsAttr 객체 처리 버그 수정

### 🚧 Phase 4: 고급 기능 (진행 예정)
- [ ] 엑셀 임포트/익스포트
- [ ] 일괄 변경 기능 
- [ ] 다국어 지원 준비
- [ ] 버전 관리 시스템

---

## 🔧 기술적 핵심사항

### 1. 코드 생성 규칙
```python
# 형식: {COLUMN_KEY}_{순번}
# 예시: COLUMN3_001, COLUMN3_002
code = f"{column_key.upper()}_{str(index).zfill(3)}"
```

### 2. 마이그레이션 전략
```python
# 기존 JSON → 코드 매핑
["진행중", "완료"] → [
    {"code": "COLUMN3_001", "value": "진행중"},
    {"code": "COLUMN3_002", "value": "완료"}
]
```

### 3. 트랜잭션 처리
```python
# 코드 업데이트 시 트랜잭션 사용
BEGIN TRANSACTION
1. 기존 코드 비활성화
2. 새 코드 삽입/업데이트
3. 순서 재정렬
COMMIT
```

### 4. 캐싱 전략 (계획)
```python
# Redis 또는 메모리 캐시 활용
cache_key = f"dropdown_codes:{column_key}"
cache_ttl = 3600  # 1시간
```

### 5. 성능 고려사항
- 인덱스: `column_key`, `is_active`
- 조인 최소화
- 배치 처리

---

## ⚠️ 리스크 및 대응방안

### 리스크 1: 기존 데이터 무결성
**위험**: 마이그레이션 중 데이터 손실  
**대응**: 
- 백업 필수
- 단계적 마이그레이션
- 롤백 스크립트 준비

### 리스크 2: 성능 저하
**위험**: 조인 증가로 인한 쿼리 성능 저하  
**대응**:
- 적절한 인덱싱
- 캐싱 적용
- 비정규화 고려

### 리스크 3: 사용자 혼란
**위험**: UI 변경으로 인한 사용자 적응 어려움  
**대응**:
- 교육 자료 제공
- 단계적 전환
- 이전 버전 유지

### 리스크 4: 코드 중복
**위험**: 수동 코드 입력 시 중복 발생  
**대응**:
- 자동 코드 생성
- 유니크 제약조건
- 실시간 검증

---

## 🧪 테스트 계획

### 단위 테스트
- [ ] 코드 생성 로직
- [ ] 마이그레이션 함수
- [ ] API 엔드포인트

### 통합 테스트
- [ ] 사고 등록 → 코드 저장
- [ ] 코드 변경 → 화면 반영
- [ ] 대량 데이터 처리

### 시나리오 테스트
1. **신규 컬럼 추가**
   - 드롭다운 컬럼 생성
   - 코드 옵션 설정
   - 사고 페이지 확인

2. **기존 값 변경**
   - "진행중" → "처리중" 변경
   - 기존 데이터 확인
   - 리포트 확인

3. **순서 변경**
   - 드래그 앤 드롭
   - 저장 및 확인

### 성능 테스트
- [ ] 1000개 옵션 처리
- [ ] 동시 사용자 10명
- [ ] 응답 시간 측정

---

## 📝 주요 파일 목록

### 신규 생성
- `/templates/admin-accident-columns-v2.html` - 데모 UI
- `/templates/admin-accident-columns-v3.html` - 실제 구현 UI
- `/init_dropdown_codes.py` - 마이그레이션 스크립트
- `/migrations/add_dropdown_code_mapping.sql` - DB 스키마

### 수정된 파일
- `/app.py` - API 엔드포인트 추가
- `/templates/admin-accident-columns.html` - 기존 관리 페이지

---

## 📌 중요 결정사항

1. **코드 형식**: `{COLUMN_KEY}_{번호}` 채택
   - 이유: 가독성과 유니크성 보장

2. **soft delete 사용**: `is_active` 플래그 활용
   - 이유: 이력 추적 및 복구 가능

3. **트랜잭션 단위**: 컬럼별 일괄 처리
   - 이유: 일관성 보장

4. **UI 라이브러리**: Sortable.js 사용
   - 이유: 가볍고 의존성 없음

---

## 🔗 참고 링크

### 테스트 URL
- 기존: http://127.0.0.1:5000/admin/accident-columns
- V2 데모: http://127.0.0.1:5000/admin/accident-columns-v2
- V3 실제: http://127.0.0.1:5000/admin/accident-columns-v3

### 관련 문서
- [개발 가이드라인](./development_guidelines.md)
- [데이터베이스 설계서](./database_design.md)

---

## 📅 일정 관리

### 2025-08-23 (금)
- [x] 초기 요구사항 분석
- [x] DB 설계 및 구현
- [x] 기본 API 개발
- [x] UI V3 개발

### 2025-08-26 (월) 예정
- [ ] 사고 페이지 연동 시작
- [ ] 데이터 검증 로직 구현
- [ ] 에러 처리 개선

### 2025-08-27 (화) 예정  
- [ ] 통합 테스트
- [ ] 버그 수정
- [ ] 성능 측정

---

## 💡 개선 아이디어

1. **일괄 편집 모드**
   - 여러 컬럼 동시 편집
   - 템플릿 적용

2. **코드 자동 매핑**
   - AI 기반 유사값 매칭
   - 자동 번역

3. **시각화**
   - 사용 빈도 차트
   - 변경 이력 그래프

4. **협업 기능**
   - 변경 요청 워크플로우
   - 승인 프로세스

---

**마지막 업데이트**: 2025-08-23 오후