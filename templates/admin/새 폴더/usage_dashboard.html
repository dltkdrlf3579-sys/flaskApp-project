{% extends 'base.html' %}

{% block title %}사용현황{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
    <style>
        .dashboard-container {
            padding: 20px;
            background: #f8f9fa;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: 400px;
        }

        .data-table {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #dee2e6;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .status-info {
            display: inline-block;
            margin-left: 20px;
            padding: 5px 10px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .time-badge {
            background: #007bff;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.85em;
        }
    </style>

    <div class="dashboard-container">
        <h2>
            사용현황
            <span class="status-info">현재 활성 사용자: <strong id="active-users">0</strong>명</span>
        </h2>

        <!-- 차트 영역 -->
        <div class="charts-row">
            <div class="chart-container">
                <h4>포탈 접속 월별 트렌드</h4>
                <canvas id="monthly-trend-chart"></canvas>
            </div>

            <div class="chart-container">
                <h4>챗봇 사용 트렌드 (최근 7일)</h4>
                <canvas id="chatbot-trend-chart"></canvas>
            </div>
        </div>

        <!-- 최근 사용자 접속 현황 테이블 -->
        <div class="data-table">
            <h4>최근 사용자 접속 현황</h4>
            <table>
                <thead>
                    <tr>
                        <th>로그인ID</th>
                        <th>사용자명</th>
                        <th>부서명</th>
                        <th>접속시간</th>
                        <th>접속메뉴</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody id="recent-access-tbody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px;">데이터 로딩 중...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let monthlyTrendChart, chatbotTrendChart;

        function initCharts() {
            // 월별 트렌드 차트
            const monthlyCtx = document.getElementById('monthly-trend-chart').getContext('2d');
            monthlyTrendChart = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '순 사용자 수',
                        data: [],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 10
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // 챗봇 트렌드 차트
            const chatbotCtx = document.getElementById('chatbot-trend-chart').getContext('2d');
            chatbotTrendChart = new Chart(chatbotCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '사용 횟수',
                        data: [],
                        backgroundColor: '#28a745',
                        borderColor: '#28a745',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 10
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr || dateTimeStr === '-') return '-';

            const date = new Date(dateTimeStr);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000); // 초 단위 차이

            if (diff < 60) return '방금 전';
            if (diff < 3600) return `${Math.floor(diff / 60)}분 전`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}시간 전`;

            // 날짜와 시간 표시
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');

            return `${year}-${month}-${day} ${hour}:${minute}`;
        }

        function loadDashboardData() {
            fetch('/api/admin/dashboard-stats')
                .then(response => response.json())
                .then(data => {
                    console.log('Dashboard data:', data);

                    // 활성 사용자 수 업데이트
                    document.getElementById('active-users').textContent = data.active_users || 0;

                    // 월별 트렌드 차트 업데이트
                    if (data.monthly_trend && monthlyTrendChart) {
                        monthlyTrendChart.data.labels = data.monthly_trend.map(item => item.month);
                        monthlyTrendChart.data.datasets[0].data = data.monthly_trend.map(item => item.users);
                        monthlyTrendChart.update();
                    }

                    // 챗봇 트렌드 차트 업데이트
                    if (data.chatbot_trend && chatbotTrendChart) {
                        chatbotTrendChart.data.labels = data.chatbot_trend.map(item => {
                            const date = new Date(item.date);
                            return `${date.getMonth() + 1}/${date.getDate()}`;
                        });
                        chatbotTrendChart.data.datasets[0].data = data.chatbot_trend.map(item => item.count);
                        chatbotTrendChart.update();
                    }

                    // 최근 접속 현황 테이블 업데이트
                    const tbody = document.getElementById('recent-access-tbody');
                    tbody.innerHTML = '';

                    if (data.recent_access && data.recent_access.length > 0) {
                        data.recent_access.forEach(access => {
                            const row = document.createElement('tr');
                            const actionBadgeColor = access.action_type === '수정' ? 'warning' : 'info';

                            row.innerHTML = `
                                <td><strong>${access.login_id}</strong></td>
                                <td>${access.user_name}</td>
                                <td>${access.dept_name}</td>
                                <td><span class="time-badge">${formatDateTime(access.access_time)}</span></td>
                                <td>${access.menu_name}</td>
                                <td><span class="badge bg-${actionBadgeColor}">${access.action_type}</span></td>
                            `;
                            tbody.appendChild(row);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">접속 기록이 없습니다</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('대시보드 데이터 로드 실패:', error);
                    document.getElementById('recent-access-tbody').innerHTML =
                        '<tr><td colspan="6" style="text-align: center; color: red;">데이터 로드 실패</td></tr>';
                });
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            loadDashboardData();

            // 30초마다 자동 새로고침
            setInterval(loadDashboardData, 30000);
        });
    </script>
{% endblock %}