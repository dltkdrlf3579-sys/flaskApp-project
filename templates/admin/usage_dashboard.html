{% extends 'base.html' %}

{% block title %}사용 현황{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .usage-dashboard {
    padding: 32px 24px 48px;
    max-width: 1200px;
    margin: 0 auto;
  }
  .usage-hero {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: #fff;
    border-radius: 18px;
    padding: 28px 32px;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 20px 45px rgba(99, 102, 241, 0.3);
    margin-bottom: 32px;
  }
  .usage-hero h1 {
    font-size: 24px;
    font-weight: 700;
    margin: 0 0 6px;
  }
  .usage-hero p {
    margin: 0;
    opacity: 0.8;
    font-size: 14px;
  }
  .usage-meta {
    text-align: right;
  }
  .usage-meta-label {
    display: block;
    font-size: 12px;
    opacity: 0.7;
    letter-spacing: 0.1em;
  }
  .usage-meta-value {
    font-size: 16px;
    font-weight: 600;
    margin-top: 4px;
  }
  .chart-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 24px;
  }
  .chart-card {
    background: #fff;
    border-radius: 18px;
    padding: 24px;
    box-shadow: 0 18px 35px rgba(15, 23, 42, 0.08);
    border: 1px solid rgba(99, 102, 241, 0.08);
    position: relative;
    overflow: hidden;
  }
  .chart-card::after {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(145deg, rgba(99,102,241,0.06), rgba(91,33,182,0.04));
    pointer-events: none;
  }
  .chart-card-header {
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-bottom: 18px;
    z-index: 1;
  }
  .chart-card h3 {
    font-size: 17px;
    font-weight: 600;
    margin: 0;
    color: #312e81;
  }
  .chart-subtitle {
    font-size: 12px;
    color: #6366f1;
    opacity: 0.9;
    margin-top: 4px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .chart-subtitle i {
    font-size: 10px;
  }
  .chart-wrapper {
    position: relative;
    height: 320px;
    z-index: 1;
  }
  .empty-state {
    margin-top: 40px;
    text-align: center;
    font-size: 14px;
    color: #64748b;
    padding: 24px;
    border-radius: 12px;
    background: rgba(148, 163, 184, 0.12);
  }
  @media (max-width: 768px) {
    .usage-hero {
      flex-direction: column;
      align-items: flex-start;
      gap: 16px;
    }
    .usage-meta {
      text-align: left;
    }
    .chart-wrapper {
      height: 260px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="usage-dashboard">
  <div class="usage-hero">
    <div>
      <h1>사용 현황</h1>
      <p>월별 트렌드를 통해 포털과 챗봇 사용 흐름을 확인해 보세요.</p>
    </div>
    <div class="usage-meta">
      <span class="usage-meta-label">UPDATED</span>
      <span class="usage-meta-value" id="usage-updated">-</span>
    </div>
  </div>

  <div class="chart-grid">
    <div class="chart-card">
      <div class="chart-card-header">
        <div>
          <h3>포털 월별 트렌드</h3>
          <span class="chart-subtitle" id="portal-total">총 0건</span>
        </div>
      </div>
      <div class="chart-wrapper">
        <canvas id="portalTrendChart"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-card-header">
        <div>
          <h3>챗봇 월별 트렌드</h3>
          <span class="chart-subtitle" id="chatbot-total">총 0건</span>
        </div>
      </div>
      <div class="chart-wrapper">
        <canvas id="chatbotTrendChart"></canvas>
      </div>
    </div>
  </div>

  <div class="empty-state" id="usage-empty" hidden>조회된 데이터가 없습니다. config.ini의 USAGE_DASHBOARD 쿼리를 확인해 주세요.</div>
</div>

<script>
  const usageCharts = {};

  function createGradient(ctx, baseColor) {
    const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
    const rgba = hexToRgba(baseColor, 0.12);
    gradient.addColorStop(0, rgba);
    gradient.addColorStop(1, hexToRgba(baseColor, 0.01));
    return gradient;
  }

  function hexToRgba(hex, alpha) {
    const normalized = hex.replace('#', '');
    const bigint = parseInt(normalized, 16);
    const r = (bigint >> 16) & 255;
    const g = (bigint >> 8) & 255;
    const b = bigint & 255;
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  }

  function formatLabel(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    if (Number.isNaN(date.getTime())) {
      return dateStr;
    }
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    return `${year}-${month}`;
  }

  function formatTimestamp(value) {
    if (!value) return '-';
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) {
      return value;
    }
    return date.toLocaleString('ko-KR', { hour12: false });
  }

  function ensureLineChart(canvasId, label, color, dataPoints) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const labels = dataPoints.map(item => formatLabel(item.date));
    const values = dataPoints.map(item => Number(item.count || 0));
    const gradient = createGradient(ctx, color);

    if (usageCharts[canvasId]) {
      const chart = usageCharts[canvasId];
      chart.data.labels = labels;
      const dataset = chart.data.datasets[0];
      dataset.data = values;
      dataset.backgroundColor = gradient;
      dataset.label = label;
      chart.update();
      return;
    }

    usageCharts[canvasId] = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label,
          data: values,
          borderColor: color,
          backgroundColor: gradient,
          borderWidth: 2,
          fill: true,
          tension: 0.35,
          pointRadius: 3,
          pointHoverRadius: 5,
          pointBackgroundColor: '#ffffff',
          pointBorderColor: color,
          pointBorderWidth: 1.5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: items => (items[0] ? items[0].label : ''),
              label: item => `${item.dataset.label}: ${Number(item.parsed.y || 0).toLocaleString()}건`
            }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: {
              color: '#475569',
              maxRotation: 0,
              padding: 10
            }
          },
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(99, 102, 241, 0.08)',
              drawBorder: false
            },
            ticks: {
              color: '#475569',
              precision: 0
            }
          }
        }
      }
    });
  }

  function sumCounts(items) {
    return items.reduce((acc, item) => acc + Number(item.count || 0), 0);
  }

  function loadUsageDashboard() {
    fetch('/api/admin/usage-dashboard')
      .then(response => response.json())
      .then(data => {
        const portalTrend = Array.isArray(data.portal_trend) ? data.portal_trend : [];
        const chatbotTrend = Array.isArray(data.chatbot_trend) ? data.chatbot_trend : [];

        ensureLineChart('portalTrendChart', '포털 이용 건수', '#6366f1', portalTrend);
        ensureLineChart('chatbotTrendChart', '챗봇 이용 건수', '#0ea5e9', chatbotTrend);

        document.getElementById('portal-total').textContent = `총 ${sumCounts(portalTrend).toLocaleString()}건`;
        document.getElementById('chatbot-total').textContent = `총 ${sumCounts(chatbotTrend).toLocaleString()}건`;
        document.getElementById('usage-updated').textContent = formatTimestamp(data.updated_at);

        const emptyState = document.getElementById('usage-empty');
        const hasData = portalTrend.length > 0 || chatbotTrend.length > 0;
        emptyState.hidden = hasData;
      })
      .catch(error => {
        console.error('사용 현황 데이터를 불러오지 못했습니다:', error);
        const emptyState = document.getElementById('usage-empty');
        emptyState.hidden = false;
        emptyState.textContent = '데이터를 불러오는 중 오류가 발생했습니다.';
      });
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadUsageDashboard();
    setInterval(loadUsageDashboard, 60000);
  });
</script>
{% endblock %}
