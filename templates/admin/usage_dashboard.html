{% extends 'base.html' %}

{% block title %}사용 현황{% endblock %}

{% block style %}
.dashboard-container {
  padding: 24px;
  background: #f5f7fb;
  border-radius: 18px;
  box-shadow: inset 0 0 0 1px rgba(148,163,184,0.15);
}
.section-title {
  font-size: 16px;
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 8px;
}
.section-subtitle {
  font-size: 13px;
  color: #64748b;
  margin-bottom: 18px;
}
.charts-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}
.chart-container {
  background: #fff;
  border-radius: 16px;
  padding: 20px 22px;
  box-shadow: 0 16px 30px rgba(15,23,42,0.12);
  border: 1px solid rgba(148,163,184,0.18);
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.chart-wrapper {
  position: relative;
  min-height: 280px;
}
.log-table {
  background: #fff;
  border-radius: 16px;
  padding: 20px 22px;
  box-shadow: 0 16px 30px rgba(15,23,42,0.09);
  border: 1px solid rgba(148,163,184,0.18);
}
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  padding: 10px 12px;
  font-size: 13px;
  border-bottom: 1px solid rgba(226,232,240,0.9);
  text-align: left;
}
th {
  background: #f8fafc;
  color: #475569;
  font-weight: 600;
}
tbody tr:last-child td {
  border-bottom: none;
}
.log-empty {
  padding: 24px 12px;
  text-align: center;
  font-size: 13px;
  color: #6b7280;
}
{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div class="dashboard-container">
  <div class="charts-row">
    <div class="chart-container">
      <div class="section-title">포털 월별 이용 트렌드</div>
      <div class="section-subtitle">월별 이용량 변화 추이</div>
      <div class="chart-wrapper">
        <canvas id="portalTrendChart"></canvas>
      </div>
    </div>
    <div class="chart-container">
      <div class="section-title">챗봇 월별 이용 트렌드</div>
      <div class="section-subtitle">월별 응답 건수 변화</div>
      <div class="chart-wrapper">
        <canvas id="chatbotTrendChart"></canvas>
      </div>
    </div>
  </div>

  <div class="log-table">
    <div class="section-title">최근 사용자 접속 현황</div>
    <div class="section-subtitle">최근 접근 기록을 최대 20건까지 보여줍니다.</div>
    <table>
      <thead>
        <tr>
          <th>로그인ID</th>
          <th>사용자명</th>
          <th>부서명</th>
          <th>접속시간</th>
          <th>접속메뉴</th>
          <th>작업</th>
        </tr>
      </thead>
      <tbody id="usage-log-body">
        <tr><td colspan="6" class="log-empty">데이터를 불러오는 중...</td></tr>
      </tbody>
    </table>
  </div>

  <div class="log-empty" id="usage-empty" hidden>포털·챗봇 데이터가 없습니다. config.ini의 USAGE_DASHBOARD 쿼리를 확인해 주세요.</div>
</div>

<script>
  const charts = {};

  function hexToRgba(hex, alpha) {
    const normalized = hex.replace('#', '');
    const bigint = parseInt(normalized, 16);
    const r = (bigint >> 16) & 255;
    const g = (bigint >> 8) & 255;
    const b = bigint & 255;
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  }

  function makeGradient(ctx, color) {
    const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
    gradient.addColorStop(0, hexToRgba(color, 0.28));
    gradient.addColorStop(1, hexToRgba(color, 0.03));
    return gradient;
  }

  function formatLabel(dateStr) {
    if (!dateStr) return '-';
    const parts = dateStr.split('-');
    if (parts.length >= 2) {
      return `${parts[0]}-${parts[1]}`;
    }
    return dateStr;
  }

  function formatTimestamp(value) {
    if (!value) return '-';
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) {
      return value;
    }
    return date.toLocaleString('ko-KR', { hour12: false });
  }

  function ensureChart(id, type, color, dataPoints) {
    const canvas = document.getElementById(id);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const labels = dataPoints.map(item => formatLabel(item.date));
    const values = dataPoints.map(item => Number(item.count || 0));

    if (charts[id]) {
      const chart = charts[id];
      chart.data.labels = labels;
      chart.data.datasets[0].data = values;
      if (type === 'line') {
        chart.data.datasets[0].backgroundColor = makeGradient(ctx, color);
      }
      chart.update();
      return;
    }

    const dataset = {
      label: type === 'line' ? '이용건수' : '응답건수',
      data: values,
      borderColor: color,
      backgroundColor: type === 'line' ? makeGradient(ctx, color) : hexToRgba(color, 0.55),
      borderWidth: 2,
      fill: type === 'line',
      tension: 0.3,
      pointRadius: 3,
      pointBackgroundColor: '#fff',
      pointBorderColor: color,
      pointBorderWidth: 1.5
    };

    if (type === 'bar') {
      dataset.borderWidth = 1.5;
      dataset.borderRadius = 8;
      dataset.pointRadius = 0;
    }

    charts[id] = new Chart(ctx, {
      type,
      data: {
        labels,
        datasets: [dataset]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: item => `${item.dataset.label}: ${Number(item.parsed.y || 0).toLocaleString()}건`
            }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { color: '#475569' }
          },
          y: {
            beginAtZero: true,
            grid: {
              color: hexToRgba('#94a3b8', 0.35),
              drawBorder: false
            },
            ticks: { color: '#475569', precision: 0 }
          }
        }
      }
    });
  }

  function loadUsageCharts() {
    fetch('/api/admin/usage-dashboard')
      .then(res => res.json())
      .then(data => {
        const portalTrend = Array.isArray(data.portal_trend) ? data.portal_trend : [];
        const chatbotTrend = Array.isArray(data.chatbot_trend) ? data.chatbot_trend : [];

        const hasData = portalTrend.length > 0 || chatbotTrend.length > 0;
        document.getElementById('usage-empty').hidden = hasData;

        ensureChart('portalTrendChart', 'line', '#6366f1', portalTrend);
        ensureChart('chatbotTrendChart', 'bar', '#0ea5e9', chatbotTrend);
      })
      .catch(err => {
        console.error('사용 현황 데이터를 불러오지 못했습니다:', err);
        document.getElementById('usage-empty').hidden = false;
      });
  }

  function loadAuditLogs() {
    fetch('/api/admin/audit-logs?per_page=20')
      .then(res => res.json())
      .then(data => {
        const logs = Array.isArray(data.logs) ? data.logs : [];
        const tbody = document.getElementById('usage-log-body');
        if (!tbody) return;

        if (!logs.length) {
          tbody.innerHTML = '<tr><td colspan="6" class="log-empty">최근 접속 기록이 없습니다.</td></tr>';
          return;
        }

        tbody.innerHTML = logs.map(log => {
          const loginId = log.login_id || '-';
          const userName = log.user_name || '-';
          const deptName = log.dept_name || '-';
          const accessTime = formatTimestamp(log.created_at);
          const menuName = log.menu_name || log.menu_code || log.request_path || '-';
          const action = log.action_type || '-';
          return `<tr>
            <td>${loginId}</td>
            <td>${userName}</td>
            <td>${deptName}</td>
            <td>${accessTime}</td>
            <td>${menuName}</td>
            <td>${action}</td>
          </tr>`;
        }).join('');
      })
      .catch(err => {
        console.error('감사 로그를 불러오지 못했습니다:', err);
        const tbody = document.getElementById('usage-log-body');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="6" class="log-empty">데이터 로드 실패</td></tr>';
        }
      });
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadUsageCharts();
    loadAuditLogs();
    // 자동 새로고침은 필요 시 수동 갱신으로 대체
    // setInterval(loadUsageCharts, 60000);
    // setInterval(loadAuditLogs, 60000);
  });
</script>
{% endblock %}
