<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©”ë‰´ë³„ ê¶Œí•œ ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .main-header {
            background: var(--primary-gradient);
            color: white;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .menu-tabs {
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 2rem;
        }

        .menu-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            color: #6c757d;
            font-weight: 500;
            position: relative;
            transition: all 0.3s;
        }

        .menu-tab.active {
            color: #667eea;
        }

        .menu-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #667eea;
        }

        .user-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

        .user-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .role-selector {
            display: inline-flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .role-btn {
            padding: 5px 12px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .role-btn:hover {
            border-color: #667eea;
        }

        .role-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* ì—­í• ë³„ ìƒ‰ìƒ */
        .role-btn.admin.active { background: #dc3545; border-color: #dc3545; }
        .role-btn.manager.active { background: #6f42c1; border-color: #6f42c1; }
        .role-btn.user1.active { background: #0d6efd; border-color: #0d6efd; }
        .role-btn.user2.active { background: #17a2b8; border-color: #17a2b8; }
        .role-btn.partner.active { background: #6c757d; border-color: #6c757d; }
        .role-btn.viewer.active { background: #198754; border-color: #198754; }
        .role-btn.none.active { background: #ffc107; border-color: #ffc107; color: #000; }

        .permission-summary {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .legend-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .legend-item {
            display: inline-block;
            margin: 5px 15px 5px 0;
        }

        .legend-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 5px;
        }

        .search-filter {
            margin-bottom: 20px;
        }

        .batch-actions {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .user-details {
            flex: 1;
        }

        .current-role {
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="main-header">
        <div class="container-fluid">
            <h2><i class="bi bi-shield-lock"></i> ë©”ë‰´ë³„ ê¶Œí•œ ê´€ë¦¬</h2>
            <p class="mb-0">ê° ì‚¬ìš©ìì˜ ë©”ë‰´ë³„ ì—­í• ì„ ì„¤ì •í•©ë‹ˆë‹¤</p>
        </div>
    </div>

    <div class="container-fluid">
        <!-- ë²”ë¡€ -->
        <div class="legend-box">
            <strong>ì—­í• ë³„ ê¶Œí•œ:</strong>
            <div class="mt-2">
                <div class="legend-item">
                    <span class="legend-badge" style="background: #dc3545; color: white;">Admin</span>
                    ëª¨ë“  CRUD ê°€ëŠ¥
                </div>
                <div class="legend-item">
                    <span class="legend-badge" style="background: #6f42c1; color: white;">Manager</span>
                    ëª¨ë“  CRU ê°€ëŠ¥
                </div>
                <div class="legend-item">
                    <span class="legend-badge" style="background: #0d6efd; color: white;">User1</span>
                    CR ê°€ëŠ¥, ë³¸ì¸ ê¸€ë§Œ U
                </div>
                <div class="legend-item">
                    <span class="legend-badge" style="background: #17a2b8; color: white;">User2</span>
                    ë¶€ì„œ ê´€ë ¨ ê¸€ë§Œ CRU
                </div>
                <div class="legend-item">
                    <span class="legend-badge" style="background: #6c757d; color: white;">Partner</span>
                    ìê¸° íšŒì‚¬ ê¸€ë§Œ CRU
                </div>
                <div class="legend-item">
                    <span class="legend-badge" style="background: #198754; color: white;">Viewer</span>
                    ì½ê¸°ë§Œ ê°€ëŠ¥
                </div>
                <div class="legend-item">
                    <span class="legend-badge" style="background: #ffc107; color: #000;">None</span>
                    ì ‘ê·¼ ë¶ˆê°€
                </div>
            </div>
        </div>

        <!-- ë©”ë‰´ íƒ­ -->
        <div class="menu-tabs d-flex">
            <button class="menu-tab active" data-menu="accident" onclick="switchMenu('accident')">
                <i class="bi bi-exclamation-triangle"></i> ì‚¬ê³  ê´€ë¦¬
            </button>
            <button class="menu-tab" data-menu="safety" onclick="switchMenu('safety')">
                <i class="bi bi-shield-check"></i> ì•ˆì „ì§€ì‹œì„œ
            </button>
            <button class="menu-tab" data-menu="follow_sop" onclick="switchMenu('follow_sop')">
                <i class="bi bi-list-check"></i> Follow SOP
            </button>
            <button class="menu-tab" data-menu="full_process" onclick="switchMenu('full_process')">
                <i class="bi bi-diagram-3"></i> Full Process
            </button>
            <button class="menu-tab" data-menu="partner" onclick="switchMenu('partner')">
                <i class="bi bi-building"></i> í˜‘ë ¥ì‚¬
            </button>
            <button class="menu-tab" data-menu="change_request" onclick="switchMenu('change_request')">
                <i class="bi bi-arrow-repeat"></i> ë³€ê²½ ê´€ë¦¬
            </button>
        </div>

        <!-- ê²€ìƒ‰ í•„í„° -->
        <div class="search-filter row">
            <div class="col-md-4">
                <input type="text" class="form-control" id="userSearch" placeholder="ğŸ” ì‚¬ìš©ì ê²€ìƒ‰ (ì‚¬ë²ˆ, ì´ë¦„, ë¶€ì„œ)">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="deptFilter">
                    <option value="">ì „ì²´ ë¶€ì„œ</option>
                    <option value="ITë¶€ì„œ">ITë¶€ì„œ</option>
                    <option value="ìƒì‚°ê´€ë¦¬ë¶€ì„œ">ìƒì‚°ê´€ë¦¬ë¶€ì„œ</option>
                    <option value="í’ˆì§ˆê´€ë¦¬ë¶€ì„œ">í’ˆì§ˆê´€ë¦¬ë¶€ì„œ</option>
                    <option value="ì•ˆì „ê´€ë¦¬ë¶€ì„œ">ì•ˆì „ê´€ë¦¬ë¶€ì„œ</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="roleFilter">
                    <option value="">í˜„ì¬ ì—­í•  í•„í„°</option>
                    <option value="admin">Admin</option>
                    <option value="manager">Manager</option>
                    <option value="user1">User1</option>
                    <option value="user2">User2</option>
                    <option value="partner">Partner</option>
                    <option value="viewer">Viewer</option>
                    <option value="none">None (ê¶Œí•œ ì—†ìŒ)</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" onclick="applyFilter()">
                    <i class="bi bi-funnel"></i> í•„í„° ì ìš©
                </button>
            </div>
        </div>

        <!-- ì‚¬ìš©ì ëª©ë¡ -->
        <div id="userList" class="mt-3">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
        </div>
    </div>

    <!-- ì €ì¥ ë²„íŠ¼ -->
    <div class="batch-actions">
        <button class="btn btn-lg btn-success" onclick="saveAllChanges()">
            <i class="bi bi-check-circle"></i> ë³€ê²½ì‚¬í•­ ì €ì¥
        </button>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let currentMenu = 'accident';
        let userMenuRoles = {};  // ë³€ê²½ì‚¬í•­ ì €ì¥
        let originalRoles = {};  // ì›ë³¸ ë°ì´í„°

        // í˜ì´ì§€ ë¡œë“œì‹œ
        $(document).ready(function() {
            loadUsers();
        });

        function loadUsers() {
            // API í˜¸ì¶œí•˜ì—¬ ì‚¬ìš©ì ëª©ë¡ ë° ë©”ë‰´ë³„ ì—­í•  ì¡°íšŒ
            $.ajax({
                url: '/api/menu-roles/all',
                method: 'GET',
                success: function(data) {
                    originalRoles = data;
                    userMenuRoles = JSON.parse(JSON.stringify(data)); // ê¹Šì€ ë³µì‚¬
                    renderUserList();
                },
                error: function() {
                    // í…ŒìŠ¤íŠ¸ ë°ì´í„°
                    const testData = {
                        'EMP001': {
                            name: 'í™ê¸¸ë™',
                            department: 'ITë¶€ì„œ',
                            company: null,
                            menu_roles: {
                                'accident': 'admin',
                                'safety': 'manager',
                                'follow_sop': 'viewer',
                                'full_process': 'viewer',
                                'partner': 'none',
                                'change_request': 'manager'
                            }
                        },
                        'EMP002': {
                            name: 'ê¹€ì² ìˆ˜',
                            department: 'í’ˆì§ˆê´€ë¦¬ë¶€ì„œ',
                            company: null,
                            menu_roles: {
                                'accident': 'user1',
                                'safety': 'user1',
                                'follow_sop': 'viewer',
                                'full_process': 'viewer',
                                'partner': 'none',
                                'change_request': 'user2'
                            }
                        },
                        'PARTNER001': {
                            name: 'ì´ì˜í¬',
                            department: null,
                            company: 'Aí˜‘ë ¥ì‚¬',
                            menu_roles: {
                                'accident': 'none',
                                'safety': 'none',
                                'follow_sop': 'none',
                                'full_process': 'none',
                                'partner': 'partner',
                                'change_request': 'partner'
                            }
                        }
                    };
                    originalRoles = testData;
                    userMenuRoles = JSON.parse(JSON.stringify(testData));
                    renderUserList();
                }
            });
        }

        function renderUserList() {
            const userList = $('#userList');
            userList.empty();

            Object.keys(userMenuRoles).forEach(emp_id => {
                const user = userMenuRoles[emp_id];
                const currentRole = user.menu_roles[currentMenu] || 'none';

                const userCard = $(`
                    <div class="user-card" data-emp="${emp_id}">
                        <div class="user-info">
                            <div class="user-details">
                                <strong>${emp_id}</strong> - ${user.name}
                                <br>
                                <small class="text-muted">
                                    ${user.department || user.company || 'ì†Œì† ì—†ìŒ'}
                                </small>
                            </div>
                            <div>
                                <span class="current-role" style="background: ${getRoleColor(currentRole)}; color: ${currentRole === 'none' ? '#000' : 'white'}">
                                    í˜„ì¬: ${currentRole.toUpperCase()}
                                </span>
                            </div>
                        </div>
                        <div class="role-selector" data-emp="${emp_id}">
                            <button class="role-btn admin ${currentRole === 'admin' ? 'active' : ''}"
                                    onclick="setRole('${emp_id}', 'admin')">Admin</button>
                            <button class="role-btn manager ${currentRole === 'manager' ? 'active' : ''}"
                                    onclick="setRole('${emp_id}', 'manager')">Manager</button>
                            <button class="role-btn user1 ${currentRole === 'user1' ? 'active' : ''}"
                                    onclick="setRole('${emp_id}', 'user1')">User1</button>
                            <button class="role-btn user2 ${currentRole === 'user2' ? 'active' : ''}"
                                    onclick="setRole('${emp_id}', 'user2')">User2</button>
                            <button class="role-btn partner ${currentRole === 'partner' ? 'active' : ''}"
                                    onclick="setRole('${emp_id}', 'partner')">Partner</button>
                            <button class="role-btn viewer ${currentRole === 'viewer' ? 'active' : ''}"
                                    onclick="setRole('${emp_id}', 'viewer')">Viewer</button>
                            <button class="role-btn none ${currentRole === 'none' ? 'active' : ''}"
                                    onclick="setRole('${emp_id}', 'none')">None</button>
                        </div>
                        <div class="permission-summary">
                            ${getPermissionSummary(currentRole)}
                        </div>
                    </div>
                `);

                userList.append(userCard);
            });
        }

        function switchMenu(menu) {
            currentMenu = menu;
            $('.menu-tab').removeClass('active');
            $(`.menu-tab[data-menu="${menu}"]`).addClass('active');
            renderUserList();
        }

        function setRole(emp_id, role) {
            userMenuRoles[emp_id].menu_roles[currentMenu] = role;

            // UI ì—…ë°ì´íŠ¸
            const card = $(`.user-card[data-emp="${emp_id}"]`);
            card.find('.role-btn').removeClass('active');
            card.find(`.role-btn.${role}`).addClass('active');

            // í˜„ì¬ ì—­í•  í‘œì‹œ ì—…ë°ì´íŠ¸
            card.find('.current-role').text(`í˜„ì¬: ${role.toUpperCase()}`);
            card.find('.current-role').css({
                'background': getRoleColor(role),
                'color': role === 'none' ? '#000' : 'white'
            });

            // ê¶Œí•œ ìš”ì•½ ì—…ë°ì´íŠ¸
            card.find('.permission-summary').html(getPermissionSummary(role));

            // ë³€ê²½ í‘œì‹œ
            if (originalRoles[emp_id].menu_roles[currentMenu] !== role) {
                card.css('border-left', '4px solid #ffc107');
            } else {
                card.css('border-left', '');
            }
        }

        function getPermissionSummary(role) {
            const summaries = {
                'admin': 'âœ… ëª¨ë“  CRUD ê¶Œí•œ',
                'manager': 'âœ… ìƒì„±/ì½ê¸°/ìˆ˜ì • ê°€ëŠ¥ (ì‚­ì œëŠ” ê°œë³„ ì„¤ì •)',
                'user1': 'ğŸ“ ìƒì„±/ì½ê¸° ê°€ëŠ¥, ë³¸ì¸ ê¸€ë§Œ ìˆ˜ì •',
                'user2': 'ğŸ¢ ë¶€ì„œ ê´€ë ¨ ê¸€ë§Œ ìƒì„±/ì½ê¸°/ìˆ˜ì •',
                'partner': 'ğŸ­ ìê¸° íšŒì‚¬ ê¸€ë§Œ ìƒì„±/ì½ê¸°/ìˆ˜ì •',
                'viewer': 'ğŸ‘ï¸ ì½ê¸°ë§Œ ê°€ëŠ¥',
                'none': 'ğŸš« ì ‘ê·¼ ë¶ˆê°€'
            };
            return summaries[role] || '';
        }

        function getRoleColor(role) {
            const colors = {
                'admin': '#dc3545',
                'manager': '#6f42c1',
                'user1': '#0d6efd',
                'user2': '#17a2b8',
                'partner': '#6c757d',
                'viewer': '#198754',
                'none': '#ffc107'
            };
            return colors[role] || '#6c757d';
        }

        function saveAllChanges() {
            const changes = [];

            // ë³€ê²½ëœ í•­ëª©ë§Œ ì°¾ê¸°
            Object.keys(userMenuRoles).forEach(emp_id => {
                const user = userMenuRoles[emp_id];
                const original = originalRoles[emp_id];

                Object.keys(user.menu_roles).forEach(menu => {
                    if (user.menu_roles[menu] !== original.menu_roles[menu]) {
                        changes.push({
                            emp_id: emp_id,
                            menu_code: menu,
                            role: user.menu_roles[menu]
                        });
                    }
                });
            });

            if (changes.length === 0) {
                alert('ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // API í˜¸ì¶œ
            $.ajax({
                url: '/api/menu-roles/batch-update',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({changes: changes}),
                success: function() {
                    alert(`${changes.length}ê°œ ê¶Œí•œì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    originalRoles = JSON.parse(JSON.stringify(userMenuRoles));
                    $('.user-card').css('border-left', '');
                },
                error: function() {
                    alert('ê¶Œí•œ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }

        function applyFilter() {
            const searchText = $('#userSearch').val().toLowerCase();
            const deptFilter = $('#deptFilter').val();
            const roleFilter = $('#roleFilter').val();

            $('.user-card').each(function() {
                const card = $(this);
                const emp_id = card.data('emp');
                const user = userMenuRoles[emp_id];

                let show = true;

                // ê²€ìƒ‰ì–´ í•„í„°
                if (searchText) {
                    const text = `${emp_id} ${user.name} ${user.department || ''} ${user.company || ''}`.toLowerCase();
                    if (!text.includes(searchText)) show = false;
                }

                // ë¶€ì„œ í•„í„°
                if (deptFilter && user.department !== deptFilter) show = false;

                // ì—­í•  í•„í„°
                if (roleFilter && user.menu_roles[currentMenu] !== roleFilter) show = false;

                card.toggle(show);
            });
        }

        // ê²€ìƒ‰ ì‹¤ì‹œê°„ ì ìš©
        $('#userSearch').on('keyup', applyFilter);
    </script>
</body>
</html>