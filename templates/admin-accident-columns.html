{% extends "base.html" %}
{% block title %}사고 컬럼 관리 - 관리자{% endblock %}
{% block content %}
<style>
.admin-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.admin-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px 0;
    margin: -20px -20px 30px -20px;
    border-radius: 8px;
}

.admin-header h1 {
    margin: 0;
    font-size: 28px;
    font-weight: 600;
}

.admin-header p {
    margin: 5px 0 0 0;
    opacity: 0.9;
}
        
        .column-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: move;
            transition: all 0.3s ease;
        }
        
        .column-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .column-card.dragging {
            opacity: 0.5;
        }
        
        .column-order {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            background: #f0f0f0;
            border-radius: 50%;
            margin-right: 10px;
            font-weight: 600;
        }
        
        .column-info {
            flex: 1;
        }
        
        .column-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .column-meta {
            font-size: 13px;
            color: #666;
        }
        
        .column-type {
            display: inline-block;
            padding: 2px 8px;
            background: #e0e0e0;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .column-type.type-text { background: #e3f2fd; color: #1976d2; }
        .column-type.type-dropdown { background: #f3e5f5; color: #7b1fa2; }
        .column-type.type-date { background: #fff3e0; color: #f57c00; }
        .column-type.type-popup_person { background: #e8f5e9; color: #388e3c; }
        .column-type.type-popup_company { background: #fce4ec; color: #c2185b; }
        
        .column-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            color: #666;
            transition: all 0.2s;
        }
        
        .btn-icon:hover {
            background: #f0f0f0;
            border-radius: 4px;
        }
        
        .btn-icon.btn-edit:hover { color: #1976d2; }
        .btn-icon.btn-delete:hover { color: #d32f2f; }
        
        .add-column-btn {
            background: white;
            border: 2px dashed #ddd;
            color: #666;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .add-column-btn:hover {
            border-color: #667eea;
            color: #667eea;
            background: #f8f9ff;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        
        .inactive-column {
            opacity: 0.6;
            background: #f5f5f5;
        }
        
        .inactive-column .column-name {
            text-decoration: line-through;
            color: #999;
        }
        
        .toggle-active {
            cursor: pointer;
        }
        
        .to-delete {
            background: #ffe8e8 !important;
            border: 2px dashed #d32f2f;
        }
    </style>

<div class="admin-container">
    <div class="admin-header">
        <div class="container">
            <h1><i class="bi bi-gear-fill"></i> 사고 컬럼 관리</h1>
        </div>
    </div>
    
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>컬럼 목록</h5>
                    <span class="text-muted">드래그하여 순서 변경 가능</span>
                </div>
                
                <div id="columnList">
                    <!-- 동적으로 로드됨 -->
                </div>
                
                <div class="add-column-btn" onclick="showAddModal()">
                    <i class="bi bi-plus-circle"></i> 새 컬럼 추가
                </div>
                
                <div class="mt-3 d-flex justify-content-end gap-2">
                    <button class="btn btn-secondary" onclick="resetChanges()">
                        <i class="bi bi-arrow-clockwise"></i> 초기화
                    </button>
                    <button class="btn btn-success" onclick="saveAllChanges()">
                        <i class="bi bi-check-circle"></i> 전체 변경사항 저장
                    </button>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- 컬럼 추가/수정 모달 -->
    <div class="modal fade" id="columnModal" tabindex="-1">
        <div class="modal-dialog" style="margin-top: 100px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">컬럼 추가</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="columnForm">
                        <input type="hidden" id="columnId">
                        
                        <div class="mb-3">
                            <label class="form-label">컬럼명 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="columnName" required 
                                   oninput="validateColumnName(this)"
                                   placeholder="예: 사고날짜, 발생위치">
                            <small class="text-muted">화면에 표시될 이름 (숫자로만 구성 불가)</small>
                            <div class="invalid-feedback" id="columnNameError"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">컬럼 키 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="columnKey" pattern="[a-z][a-z0-9_]*" required
                                   oninput="validateColumnKey(this)"
                                   placeholder="예: accident_date">
                            <small class="text-muted" style="display: block;">
                                <strong>반드시 컬럼명을 영어로 번역해주세요! (예: 사고날짜 → accident_date)</strong><br>
                                영문 소문자로 시작, 영문 소문자/숫자/언더스코어만 사용
                            </small>
                            <div class="invalid-feedback" id="columnKeyError"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">입력 타입 <span class="text-danger">*</span></label>
                            <select class="form-select" id="columnType" onchange="toggleOptionsField(); toggleTableField(); checkTypeChange();">
                                <option value="" disabled selected>타입을 선택하세요</option>
                                <option value="text">텍스트</option>
                                <option value="dropdown">드롭다운</option>
                                <option value="date">날짜</option>
                                <option value="table">테이블</option>
                            </select>
                            <div id="typeChangeWarning" class="alert alert-warning mt-2" style="display: none; font-size: 13px; padding: 8px 12px;">
                                <i class="bi bi-exclamation-triangle"></i> 타입 변경 시 기존 데이터가 삭제될 수 있습니다.
                            </div>
                        </div>
                        
                        <!-- 테이블 설정 영역 -->
                        <div class="mb-3" id="tableConfigField" style="display: none;">
                            <label class="form-label">테이블 설정</label>
                            <div class="d-flex gap-2 align-items-center">
                                <input type="text" class="form-control" id="selectedTableDisplay" readonly placeholder="테이블을 선택하세요">
                                <button type="button" class="btn btn-outline-primary" onclick="openTableConfigModal()">
                                    설정
                                </button>
                            </div>
                            <input type="hidden" id="selectedTableConfig" value="">
                            <div id="tableColumnsPreview" class="mt-2" style="display: none;">
                                <!-- 테이블 컬럼 미리보기 영역 -->
                            </div>
                        </div>
                        
                        <div class="mb-3" id="tableSelectField" style="display: none;">
                            <label class="form-label">테이블 선택</label>
                            <select class="form-select" id="tableSelect" onchange="updateMappingFields()">
                                <option value="">-- 선택 --</option>
                                <option value="employees">담당자 (employees)</option>
                                <option value="companies">업체 (companies)</option>
                                <option value="departments">부서 (departments)</option>
                            </select>
                            
                            <div id="mappingFields" style="display: none; margin-top: 15px;">
                                <label class="form-label">연관 컬럼 매핑</label>
                                <div class="alert alert-info" style="font-size: 13px;">
                                    <i class="bi bi-info-circle"></i> 선택 시 자동으로 채워질 컬럼들을 설정합니다.
                                </div>
                                <div id="mappingContainer">
                                    <!-- 동적으로 생성됨 -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3" id="optionsField" style="display: none;">
                            <label class="form-label">드롭다운 옵션</label>
                            <div class="alert alert-info" style="font-size: 13px;">
                                <i class="bi bi-info-circle"></i> 드롭다운 옵션은 코드 관리 페이지에서 설정합니다.
                            </div>
                            
                            <!-- 현재 옵션 미리보기 -->
                            <div id="optionPreview" class="mb-3" style="display: none;">
                                <h6>현재 설정된 옵션:</h6>
                                <table class="table table-sm table-bordered">
                                    <thead>
                                        <tr>
                                            <th width="40%">코드</th>
                                            <th>표시값</th>
                                        </tr>
                                    </thead>
                                    <tbody id="optionPreviewBody">
                                    </tbody>
                                </table>
                            </div>
                            
                            <button type="button" class="btn btn-primary w-100" onclick="openCodeEditor()">
                                <i class="bi bi-code-square"></i> 코드 편집기 열기
                            </button>
                            <input type="hidden" id="dropdownOptions" />
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="isActive" checked>
                            <label class="form-check-label" for="isActive">
                                활성화
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">취소</button>
                    <button type="button" class="btn btn-primary" onclick="saveColumnToQueue()">입력 완료</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 테이블 설정 모달 -->
<div class="modal fade" id="tableConfigModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="margin-top: 100px; max-width: 900px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">테이블 설정</h5>
                <button type="button" class="btn-close" onclick="closeTableConfigModal()"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- 왼쪽: 테이블 목록 -->
                    <div class="col-md-4">
                        <h6 class="mb-3">테이블 선택</h6>
                        <div class="list-group" id="tableList">
                            <!-- 테이블 목록이 JavaScript로 동적 생성됨 -->
                        </div>
                    </div>
                    
                    <!-- 오른쪽: 미리보기 -->
                    <div class="col-md-8">
                        <h6 class="mb-3">생성될 컬럼 미리보기</h6>
                        <div id="tablePreview" style="border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; min-height: 300px; background-color: #f8f9fa;">
                            <div class="text-muted text-center" style="padding: 50px 0;">
                                <i class="bi bi-table" style="font-size: 48px;"></i>
                                <p class="mt-3">왼쪽에서 테이블을 선택하세요</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeTableConfigModal()">취소</button>
                <button type="button" class="btn btn-primary" onclick="confirmTableSelection()" id="confirmTableBtn" disabled>선택 완료</button>
            </div>
        </div>
    </div>
</div>

<script>
let columns = [];
let pendingColumns = []; // 모든 변경사항을 담는 단순 배열
let editingId = null;
        
        // 컬럼명 실시간 유효성 검사
        function validateColumnName(input) {
            const value = input.value.trim();
            const errorDiv = document.getElementById('columnNameError');
            
            if (/^\d+$/.test(value)) {
                input.classList.add('is-invalid');
                errorDiv.textContent = '숫자로만 구성된 컬럼명은 사용할 수 없습니다.';
                errorDiv.style.display = 'block';
                return false;
            } else if (value && !/[가-힣a-zA-Z]/.test(value)) {
                input.classList.add('is-invalid');
                errorDiv.textContent = '최소 하나 이상의 한글 또는 영문자를 포함해야 합니다.';
                errorDiv.style.display = 'block';
                return false;
            } else {
                input.classList.remove('is-invalid');
                errorDiv.style.display = 'none';
                return true;
            }
        }
        
        // 컬럼 키 실시간 유효성 검사
        function validateColumnKey(input) {
            const value = input.value.trim();
            const errorDiv = document.getElementById('columnKeyError');
            
            if (value && !/^[a-z][a-z0-9_]*$/.test(value)) {
                input.classList.add('is-invalid');
                errorDiv.textContent = '영문 소문자로 시작하고, 영문 소문자/숫자/언더스코어만 사용 가능합니다.';
                errorDiv.style.display = 'block';
                return false;
            } else {
                input.classList.remove('is-invalid');
                errorDiv.style.display = 'none';
                return true;
            }
        }
        
        // 페이지 로드 시 초기화
        window.onload = function() {
            // 모든 백드롭 제거 (이전 세션에서 남은 것들)
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                backdrop.remove();
            });
            
            // body 스타일 초기화
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
            
            // 컬럼 목록 로드
            loadColumns();
        };
        
        function loadColumns() {
            fetch('/api/accident-columns')
                .then(response => response.json())
                .then(data => {
                    // 모든 컬럼을 표시 (비활성 포함)
                    const allData = data;
                    
                    // 원본 저장
                    columns = allData;
                    // 작업용 복사본 생성 (플래그 초기화)
                    pendingColumns = allData.map(col => {
                        // 테이블 정보 복원 (DB에 저장된 경우)
                        const column = {
                            ...col,
                            _isNew: false,
                            _modified: false,
                            _toDelete: false
                        };
                        
                        // 메타데이터에서 테이블 정보 복원
                        if (col.table_group) column._tableGroup = col.table_group;
                        if (col.table_type) column._tableType = col.table_type;
                        if (col.table_name) column._tableName = col.table_name;
                        
                        return column;
                    });
                    
                    console.log('로드된 전체 컬럼:', pendingColumns.length, '개');
                    console.log('활성 컬럼:', pendingColumns.filter(c => c.is_active).length, '개');
                    console.log('비활성 컬럼:', pendingColumns.filter(c => !c.is_active).length, '개');
                    renderColumns();
                })
                .catch(error => {
                    console.error('컬럼 로드 오류:', error);
                });
        }
        
        function renderColumns() {
            const container = document.getElementById('columnList');
            container.innerHTML = '';
            
            pendingColumns.forEach((column, index) => {
                // 삭제된 컬럼이나 숨겨진 컬럼은 표시하지 않음
                if (column._deleted || column._hidden) return;
                
                const card = document.createElement('div');
                // 비활성 컬럼에 투명도 추가
                const inactiveClass = !column.is_active ? 'inactive-column' : '';
                const deletedClass = column._toDelete ? 'to-delete' : '';
                card.className = `column-card d-flex align-items-center ${inactiveClass} ${deletedClass}`;
                card.dataset.id = column.id;
                
                // 상태 배지 결정 (삭제예정은 배지 표시 안함)
                let statusBadge = '';
                if (!column._toDelete) {
                    if (column._isNew) {
                        statusBadge = '<span class="badge bg-success ms-2">추가</span>';
                    } else if (column._modified) {
                        statusBadge = '<span class="badge bg-warning ms-2">변경</span>';
                    }
                }
                
                card.innerHTML = `
                    <span class="column-order">${index + 1}</span>
                    <div class="column-info">
                        <div class="column-name">
                            ${column.column_name}
                            ${statusBadge}
                            ${!column.is_active ? '<span class="badge bg-secondary ms-2">비활성</span>' : ''}
                        </div>
                        <div class="column-meta">
                            <span class="column-type type-${column.column_type}">${getTypeLabel(column.column_type)}</span>
                            <span class="text-muted">키: ${column.column_key}</span>
                            ${column.dropdown_options ? (() => {
                                try {
                                    let optCount = 0;
                                    if (typeof column.dropdown_options === 'string') {
                                        try {
                                            const parsed = JSON.parse(column.dropdown_options);
                                            optCount = Array.isArray(parsed) ? parsed.length : 1;
                                        } catch (e) {
                                            optCount = 1;
                                        }
                                    } else if (Array.isArray(column.dropdown_options)) {
                                        optCount = column.dropdown_options.length;
                                    }
                                    return ``;
                                } catch (e) {
                                    return '';
                                }
                            })() : ''}
                        </div>
                    </div>
                    <div class="column-actions">
                        <button class="btn-icon btn-edit" onclick="editColumn('${column.id}')" ${column._toDelete ? 'disabled' : ''}>
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn-icon btn-delete" onclick="deleteColumn('${column.id}')" ${column._toDelete ? 'disabled' : ''}>
                            <i class="bi bi-trash"></i>
                        </button>
                        <div class="form-check form-switch toggle-active">
                            <input class="form-check-input" type="checkbox" ${column.is_active ? 'checked' : ''} 
                                onchange="toggleActive('${column.id}', this.checked)" ${column._toDelete ? 'disabled' : ''}>
                        </div>
                    </div>
                `;
                
                // 삭제 예정인 경우 특별 처리
                if (column._toDelete) {
                    card.style.opacity = '0.2';
                    card.style.backgroundColor = '#ffebee';
                    card.style.position = 'relative';
                    
                    // 삭제예정 라벨 추가
                    const deleteLabel = document.createElement('div');
                    deleteLabel.style.cssText = `
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        color: #dc3545;
                        font-size: 24px;
                        font-weight: bold;
                        text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
                        z-index: 10;
                        pointer-events: none;
                    `;
                    deleteLabel.textContent = '삭제예정';
                    card.appendChild(deleteLabel);
                }
                
                container.appendChild(card);
            });
            
            // Sortable 초기화
            new Sortable(container, {
                animation: 150,
                ghostClass: 'dragging',
                onEnd: function(evt) {
                    updateOrder();
                }
            });
        }
        
        function getTypeLabel(type) {
            const labels = {
                'text': '텍스트',
                'dropdown': '드롭다운',
                'date': '날짜',
                'table': '테이블',
                'table_select': '테이블 선택',
                'popup_person': '담당자',
                'popup_company': '업체',
                'popup_contractor': '협력사 근로자',
                'popup_department': '부서',
                'popup_building': '건물',
                'linked_dept': '연결-부서',
                'linked_text': '연결-텍스트'
            };
            return labels[type] || type;
        }
        
        function showAddModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = '컬럼 추가';
            document.getElementById('columnForm').reset();
            document.getElementById('columnKey').disabled = false;
            
            // 타입 선택 드롭다운 초기화 - placeholder 선택
            const typeSelect = document.getElementById('columnType');
            typeSelect.value = '';  // placeholder 옵션으로 설정
            typeSelect.dataset.originalType = '';
            
            // 테이블 설정 초기화
            document.getElementById('selectedTableDisplay').value = '';
            document.getElementById('selectedTableConfig').value = '';
            document.getElementById('tableColumnsPreview').innerHTML = '';
            document.getElementById('tableColumnsPreview').style.display = 'none';
            selectedTableType = null;
            
            document.getElementById('isActive').checked = true;
            document.getElementById('typeChangeWarning').style.display = 'none';
            document.getElementById('dropdownOptions').value = '';  // 드롭다운 옵션 초기화
            toggleOptionsField();
            toggleTableField();
            
            // 기존 모달 인스턴스가 있으면 재사용, 없으면 새로 생성
            const modalElement = document.getElementById('columnModal');
            let modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (!modalInstance) {
                modalInstance = new bootstrap.Modal(modalElement);
            }
            modalInstance.show();
        }
        
        function editColumn(id) {
            // ID를 문자열/숫자 모두 처리 가능하도록
            const column = pendingColumns.find(c => String(c.id) === String(id));
            if (!column || column._toDelete) return;
            
            editingId = id;
            document.getElementById('modalTitle').textContent = '컬럼 수정';
            document.getElementById('columnId').value = id;
            document.getElementById('columnName').value = column.column_name;
            document.getElementById('columnKey').value = column.column_key;
            document.getElementById('columnKey').disabled = !column._isNew;
            
            // 테이블 타입 관련 처리
            const typeSelectEl = document.getElementById('columnType');
            const isPopup = column.column_type && column.column_type.startsWith('popup_');
            const isLinked = column.column_type && column.column_type.startsWith('linked_');
            const looksTable = isPopup || isLinked || column.input_type === 'table' || column._tableType || column.table_type;
            if (column._tableGroup || looksTable) {
                // 테이블 그룹으로 판단되면 강제로 'table'로 고정
                typeSelectEl.value = 'table';
                // 테이블 그룹은 타입 변경 불가
                typeSelectEl.disabled = true;
                
                // popup 타입들은 타입 변경 불가
                if (column.column_type === 'popup_person' || 
                    column.column_type === 'popup_company' || 
                    column.column_type === 'popup_contractor') {
                    typeSelectEl.disabled = true;
                }
                
                // 테이블 설정 정보 복원
                if (column._tableType) {
                    document.getElementById('selectedTableConfig').value = column._tableType;
                    selectedTableType = column._tableType;
                }
                if (column._tableName) {
                    document.getElementById('selectedTableDisplay').value = column._tableName;
                }
                
                // 테이블 설정 영역 표시 (테이블로 생성된 컬럼인 경우)
                if (document.getElementById('tableConfigField')) {
                    document.getElementById('tableConfigField').style.display = 'block';
                    
                    // 미리보기 업데이트
                    const config = tableColumnMappings[column._tableType];
                    if (config) {
                        let previewHtml = `<small class="text-muted">연결된 테이블: </small>`;
                        previewHtml += `<span class="badge bg-info">${config.name}</span>`;
                        if (column.column_type && column.column_type.startsWith('popup_')) {
                            previewHtml += `<small class="text-warning ms-2">(팝업 타입 - 타입 변경 불가)</small>`;
                        }
                        document.getElementById('tableColumnsPreview').innerHTML = previewHtml;
                        document.getElementById('tableColumnsPreview').style.display = 'block';
                    }
                }
            } else if (column.column_type === 'linked_text' || column.column_type === 'linked_dept') {
                // linked 타입은 강제로 타입 설정하고 변경 불가능하게
                typeSelectEl.value = column.column_type;
                
                // linked 타입은 타입 변경 불가능
                typeSelectEl.disabled = true;
                
                // 타입 변경 경고 숨기기
                document.getElementById('typeChangeWarning').style.display = 'none';
                
                // linked 컬럼도 테이블 정보 유지
                if (column._tableType) {
                    document.getElementById('selectedTableConfig').value = column._tableType;
                    selectedTableType = column._tableType;
                    document.getElementById('selectedTableDisplay').value = column._tableName || '';
                    
                    // 테이블 설정 영역 표시
                    document.getElementById('tableConfigField').style.display = 'block';
                    
                    // 미리보기 업데이트
                    const config = tableColumnMappings[column._tableType];
                    if (config) {
                        let previewHtml = `<small class="text-muted">연결된 테이블: </small>`;
                        previewHtml += `<span class="badge bg-info">${config.name}</span>`;
                        previewHtml += `<small class="text-warning ms-2">(Linked 컬럼 - 타입 변경 불가)</small>`;
                        document.getElementById('tableColumnsPreview').innerHTML = previewHtml;
                        document.getElementById('tableColumnsPreview').style.display = 'block';
                    }
                } else {
                    // 테이블 정보가 없어도 linked 타입 표시
                    let previewHtml = `<small class="text-warning">⚠️ Linked 컬럼 - 타입 변경 불가</small>`;
                    document.getElementById('tableColumnsPreview').innerHTML = previewHtml;
                    document.getElementById('tableColumnsPreview').style.display = 'block';
                    document.getElementById('tableConfigField').style.display = 'block';
                }
            } else {
                const resolvedType = (column.column_type === 'table' || column.input_type === 'table' || column._tableType || column.table_type) ? 'table' : column.column_type;
                typeSelectEl.value = resolvedType || '';
                // 일반 컬럼은 타입 변경 가능
                typeSelectEl.disabled = false;
                if (resolvedType === 'table') {
                    document.getElementById('tableConfigField').style.display = 'block';
                }
            }
            
            typeSelectEl.dataset.originalType = typeSelectEl.value || column.column_type || '';
            document.getElementById('isActive').checked = column.is_active;
            
            // 드롭다운 타입일 때 옵션 처리
            if (column.column_type === 'dropdown') {
                // 미리보기 로드
                loadOptionPreview(column.column_key);
                
                // 기존 옵션 처리 (호환성 유지)
                if (column.dropdown_options) {
                    try {
                        let options;
                        if (typeof column.dropdown_options === 'string') {
                            try {
                                options = JSON.parse(column.dropdown_options);
                            } catch (e) {
                                options = [column.dropdown_options];
                            }
                        } else {
                            options = column.dropdown_options;
                        }
                        
                        if (Array.isArray(options)) {
                            document.getElementById('dropdownOptions').value = JSON.stringify(options);
                        } else {
                            document.getElementById('dropdownOptions').value = String(options);
                        }
                    } catch (e) {
                        console.error('드롭다운 옵션 처리 오류:', e);
                        document.getElementById('dropdownOptions').value = '';
                    }
                } else {
                    document.getElementById('dropdownOptions').value = '';
                }
            } else {
                document.getElementById('dropdownOptions').value = '';
                document.getElementById('optionPreview').style.display = 'none';
            }
            
            toggleOptionsField();
            
            // linked 타입이 아닌 경우에만 toggleTableField 호출
            if (column.column_type !== 'linked_text' && column.column_type !== 'linked_dept') {
                toggleTableField();
            }
            
            const modalElement = document.getElementById('columnModal');
            let modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (!modalInstance) {
                modalInstance = new bootstrap.Modal(modalElement);
            }
            modalInstance.show();
        }
        
        function toggleOptionsField() {
            const type = document.getElementById('columnType').value;
            document.getElementById('optionsField').style.display = 
                type === 'dropdown' ? 'block' : 'none';
            document.getElementById('tableSelectField').style.display = 
                type === 'table_select' ? 'block' : 'none';
        }
        
        function toggleTableField() {
            const type = document.getElementById('columnType').value;
            document.getElementById('tableConfigField').style.display = 
                type === 'table' ? 'block' : 'none';
        }
        
        function updateMappingFields() {
            const tableSelect = document.getElementById('tableSelect').value;
            const mappingContainer = document.getElementById('mappingContainer');
            const mappingFields = document.getElementById('mappingFields');
            
            if (!tableSelect) {
                mappingFields.style.display = 'none';
                return;
            }
            
            mappingFields.style.display = 'block';
            
            // 테이블별 매핑 필드 정의
            const tableFields = {
                'employees': [
                    {field: 'employee_id', label: '직원 ID'},
                    {field: 'employee_name', label: '직원명'},
                    {field: 'department', label: '부서'},
                    {field: 'position', label: '직급'},
                    {field: 'phone', label: '연락처'}
                ],
                'companies': [
                    {field: 'company_name', label: '업체명'},
                    {field: 'business_number', label: '사업자번호'},
                    {field: 'representative', label: '대표자'},
                    {field: 'contact', label: '연락처'},
                    {field: 'address', label: '주소'}
                ],
                'departments': [
                    {field: 'dept_code', label: '부서코드'},
                    {field: 'dept_name', label: '부서명'},
                    {field: 'manager', label: '부서장'}
                ]
            };
            
            const fields = tableFields[tableSelect] || [];
            
            let html = '';
            fields.forEach(field => {
                html += `
                    <div class="row mb-2">
                        <div class="col-5">
                            <input type="text" class="form-control form-control-sm" 
                                   value="${field.label}" readonly>
                        </div>
                        <div class="col-1 text-center pt-1">→</div>
                        <div class="col-6">
                            <select class="form-select form-select-sm mapping-select" 
                                    data-source="${field.field}">
                                <option value="">매핑 안함</option>
                                <option value="create_new">새 컬럼 자동 생성</option>
                                <optgroup label="기존 컬럼">
                                    <!-- 기존 컬럼 목록 동적 추가 -->
                                </optgroup>
                            </select>
                        </div>
                    </div>
                `;
            });
            
            mappingContainer.innerHTML = html;
            
            // 기존 컬럼 목록 추가
            updateExistingColumns();
        }
        
        function updateExistingColumns() {
            // 현재 활성 컬럼 목록을 매핑 선택 옵션에 추가
            const selects = document.querySelectorAll('.mapping-select');
            selects.forEach(select => {
                const optgroup = select.querySelector('optgroup');
                let options = '';
                pendingColumns.forEach(col => {
                    if (!col._toDelete && col.column_type === 'text') {
                        options += `<option value="${col.column_key}">${col.column_name}</option>`;
                    }
                });
                optgroup.innerHTML = options;
            });
        }
        
        function checkTypeChange() {
            const currentType = document.getElementById('columnType').value;
            const originalType = document.getElementById('columnType').dataset.originalType;
            const warning = document.getElementById('typeChangeWarning');
            
            if (editingId && originalType && originalType !== currentType) {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        }
        
        function saveColumnToQueue() {
            const columnName = document.getElementById('columnName').value.trim();
            const columnKey = document.getElementById('columnKey').value.trim();
            const columnTypeElement = document.getElementById('columnType');
            const columnType = columnTypeElement.value;
            const originalType = columnTypeElement.dataset.originalType;
            const isActive = document.getElementById('isActive').checked;
            
            // 디버깅: disabled 상태에서도 값이 제대로 읽히는지 확인
            console.log('Column Type:', columnType, 'Disabled:', columnTypeElement.disabled);
            
            if (!columnName || !columnKey) {
                alert('컬럼명과 컬럼 키는 필수 입력 항목입니다.');
                return;
            }
            
            if (!columnType || columnType === '') {
                // linked 타입이나 popup 타입이 아닌 경우에만 타입 선택 요구
                if (!columnTypeElement.disabled) {
                    alert('타입을 선택해주세요.');
                    columnTypeElement.focus();
                    return;
                }
            }
            
            // 컬럼명 유효성 검사 - 숫자로만 구성된 이름 금지
            if (/^\d+$/.test(columnName)) {
                alert('❌ 컬럼명은 숫자로만 구성될 수 없습니다.\n\n예시:\n✅ 사고날짜, 발생일자, accident_date\n❌ 123123, 2024');
                document.getElementById('columnName').focus();
                return;
            }
            
            // 컬럼명이 한글자 이상의 문자를 포함하는지 검사
            if (!/[가-힣a-zA-Z]/.test(columnName)) {
                alert('❌ 컬럼명은 최소 하나 이상의 한글 또는 영문자를 포함해야 합니다.');
                document.getElementById('columnName').focus();
                return;
            }
            
            // 컬럼 키 유효성 검사 - 영문으로 시작해야 함
            if (!/^[a-z][a-z0-9_]*$/.test(columnKey)) {
                alert('❌ 컬럼 키는 영문 소문자로 시작해야 하며, 영문 소문자, 숫자, 언더스코어(_)만 사용 가능합니다.\n\n예시:\n✅ accident_date, date1, issue_type\n❌ 123_date, Date, accident-date');
                document.getElementById('columnKey').focus();
                return;
            }
            
            // 타입 변경 시 경고
            if (editingId && originalType && originalType !== columnType) {
                const column = pendingColumns.find(c => String(c.id) === String(editingId));
                if (column && !column._isNew) {
                    if (!confirm('⚠️ 주의: 타입을 변경하실 경우 기존 데이터가 전부 삭제될 수 있으니 신중히 변경 부탁드립니다.\n\n정말 타입을 변경하시겠습니까?')) {
                        return;
                    }
                }
            }

            // 링크드 컬럼 편집 시, 본체(첫 번째 popup_*) 컬럼이 없으면 자동 생성
            if (editingId) {
                const existingColumn = pendingColumns.find(c => String(c.id) === String(editingId));
                if (existingColumn && existingColumn.column_type && existingColumn.column_type.startsWith('linked_')) {
                    let detected = null;
                    for (const [tKey, cfg] of Object.entries(tableColumnMappings)) {
                        for (let i = 1; i < cfg.columns.length; i++) {
                            const cdef = cfg.columns[i];
                            if (cdef.type === existingColumn.column_type && existingColumn.column_key.endsWith(cdef.key_suffix)) {
                                detected = { tableType: tKey, config: cfg, suffix: cdef.key_suffix };
                                break;
                            }
                        }
                        if (detected) break;
                    }
                    if (detected) {
                        const baseKey = existingColumn.column_key.slice(0, -detected.suffix.length);
                        const baseExists = pendingColumns.some(c => !c._toDelete && c.column_key === baseKey);
                        if (!baseExists) {
                            const baseOrder = Math.max(0, (pendingColumns.filter(c => c.tab === selectedSection && !c._toDelete).map(c => c.column_order).reduce((a,b)=>Math.max(a,b), -1)) + 1);
                            let baseName = columnName;
                            const lastToken = detected.config.columns.find(c=>c.key_suffix===detected.suffix)?.name.split(' ').slice(-1)[0] || '';
                            if (lastToken && baseName.endsWith(' ' + lastToken)) {
                                baseName = baseName.slice(0, -(' ' + lastToken).length);
                            }
                            const baseType = detected.config.columns[0].type;
                            const newId = Date.now() + Math.floor(Math.random()*1000);
                            const newBase = {
                                id: newId,
                                column_name: baseName,
                                column_key: baseKey,
                                column_type: baseType,
                                tab: selectedSection,
                                is_active: isActive,
                                column_order: baseOrder,
                                _isNew: true,
                                _tableGroup: baseKey,
                                _tableType: detected.tableType,
                                _tableName: detected.config.name
                            };
                            pendingColumns.push(newBase);
                            console.log('자동 생성된 본체 컬럼:', newBase);
                        }
                    }
                }
            }
            
            let dropdownOptions = null;
            if (columnType === 'dropdown') {
                const optionsText = document.getElementById('dropdownOptions').value;
                if (optionsText) {
                    dropdownOptions = optionsText.split('\n').filter(o => o.trim());
                }
            }
            
            if (editingId) {
                // 기존 컬럼 수정
                const index = pendingColumns.findIndex(c => String(c.id) === String(editingId));
                if (index !== -1) {
                    const existingColumn = pendingColumns[index];
                    
                    // 테이블 컬럼 타입 보존/복원 로직
                    const suffixes = ['_id','_dept','_bizno','_code','_company'];
                    const isLinkedField = suffixes.some(s => (columnKey || '').endsWith(s));
                    const baseKeyHints = { 'incharged_person': 'person', 'incharge': 'department', 'company_1cha': 'company', 'company_2cha': 'company' };
                    const keyHint = baseKeyHints[existingColumn.column_key] || baseKeyHints[columnKey] || null;
                    let siblingType = null;
                    const baseKey = (function(k){ let b=k||''; suffixes.forEach(s=>{ if(b.endsWith(s)) b=b.slice(0,-s.length);}); return b; })(columnKey || existingColumn.column_key || '');
                    const siblings = (pendingColumns||[]).filter(c => String(c.id)!==String(existingColumn.id));
                    if (siblings.some(c => c.column_key === baseKey + '_bizno')) siblingType = 'company';
                    else if (siblings.some(c => c.column_key === baseKey + '_code')) siblingType = 'department';
                    else if (siblings.some(c => c.column_key === baseKey + '_dept')) siblingType = 'person';
                    else if (siblings.some(c => c.column_key === baseKey + '_company')) siblingType = 'contractor';
                    const looksLikeTable = (
                        (existingColumn.column_type && (existingColumn.column_type.startsWith('popup_') || existingColumn.column_type.startsWith('linked_')))
                        || existingColumn.input_type === 'table'
                        || !!existingColumn._tableType
                        || !!existingColumn.table_type
                    );
                    const tableTypeGuess = existingColumn._tableType || keyHint || siblingType || (looksLikeTable ? (existingColumn._tableType || null) : null);
                    let newType = existingColumn._tableGroup ? existingColumn.column_type : columnType;
                    if (!isLinkedField && (!newType || newType === 'text') && tableTypeGuess) {
                        const popupMap = { person:'popup_person', department:'popup_department', company:'popup_company', building:'popup_building', contractor:'popup_contractor' };
                        newType = popupMap[tableTypeGuess] || newType || 'text';
                    }
                    pendingColumns[index] = {
                        ...existingColumn,
                        column_name: columnName,
                        column_key: columnKey,
                        column_type: newType,
                        is_active: isActive,
                        dropdown_options: dropdownOptions,
                        _modified: !existingColumn._isNew, // 새 컬럼이 아니면 수정됨 표시
                        // 테이블 관련 정보 유지/보강
                        _tableGroup: existingColumn._tableGroup || baseKey,
                        _tableType: existingColumn._tableType || tableTypeGuess || null,
                        _tableName: existingColumn._tableName
                    };
                }
            } else {
                // 새 컬럼 추가
                if (columnType === 'table') {
                    // 테이블 타입: 선택된 테이블 설정 확인
                    const selectedTable = document.getElementById('selectedTableConfig').value;
                    if (!selectedTable) {
                        alert('테이블을 선택해주세요.');
                        return;
                    }
                    
                    const config = tableColumnMappings[selectedTable];
                    if (!config) {
                        alert('선택된 테이블 설정을 찾을 수 없습니다.');
                        return;
                    }
                    
                    // 여러 개의 컬럼 생성
                    const baseOrder = pendingColumns.length;
                    const createdColumns = [];
                    
                    config.columns.forEach((col, index) => {
                        const newId = Date.now() + index;
                        const colName = index === 0 ? columnName : `${columnName} ${col.name.split(' ').slice(-1)[0]}`;
                        const colKey = columnKey + col.key_suffix;
                        
                        const newColumn = {
                            id: newId,
                            column_name: colName,
                            column_key: colKey,
                            column_type: col.type,
                            is_active: isActive,
                            dropdown_options: col.type === 'dropdown' ? ['옵션1', '옵션2', '옵션3'] : null,
                            column_order: baseOrder + index,
                            _isNew: true,
                            _tableGroup: columnKey, // 그룹 표시용
                            _tableType: selectedTable, // 테이블 타입 저장
                            _tableName: config.name // 테이블 이름 저장
                        };
                        
                        pendingColumns.push(newColumn);
                        createdColumns.push(colName);
                        console.log(`테이블 컬럼 생성 [${index + 1}/${config.columns.length}]:`, newColumn);
                    });
                    
                    // 생성된 컬럼 목록 표시
                    alert(`✅ ${config.name} 테이블 컬럼 ${createdColumns.length}개가 생성되었습니다:\n\n${createdColumns.join('\n')}\n\n"전체 변경사항 저장" 버튼을 눌러야 최종 반영됩니다.`);
                    
                } else {
                    // 일반 타입
                    const newId = Date.now();
                    const newColumn = {
                        id: newId,
                        column_name: columnName,
                        column_key: columnKey,
                        column_type: columnType,
                        is_active: isActive,
                        dropdown_options: dropdownOptions,
                        column_order: pendingColumns.length,
                        _isNew: true
                    };
                    pendingColumns.push(newColumn);
                    
                    alert('변경사항이 저장 대기중입니다.\n"전체 변경사항 저장" 버튼을 눌러야 최종 반영됩니다.');
                }
            }
            
            
            forceCloseModal();
            renderColumns();
        }
        
        function forceCloseModal() {
            const modalElement = document.getElementById('columnModal');
            
            // 타입 드롭다운 다시 활성화 (다음 사용을 위해)
            document.getElementById('columnType').disabled = false;
            
            // Bootstrap 모달 인스턴스 제거
            const modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (modalInstance) {
                modalInstance.dispose();
            }
            
            // 모달 관련 모든 요소 강제 제거
            modalElement.classList.remove('show');
            modalElement.style.display = 'none';
            modalElement.setAttribute('aria-hidden', 'true');
            modalElement.removeAttribute('aria-modal');
            modalElement.removeAttribute('role');
            
            // 모든 백드롭 제거
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                backdrop.remove();
            });
            
            // body 상태 초기화
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
            
            // 폼 초기화
            document.getElementById('columnForm').reset();
            const dropdownOptionsDiv = document.getElementById('dropdownOptionsDiv');
            if (dropdownOptionsDiv) {
                dropdownOptionsDiv.style.display = 'none';
            }
        }
        
        function closeModal() {
            forceCloseModal();
        }
        
        function deleteColumn(id) {
            const index = pendingColumns.findIndex(c => String(c.id) === String(id));
            if (index !== -1) {
                if (pendingColumns[index]._isNew) {
                    // 새로 추가한 컬럼은 바로 제거
                    pendingColumns.splice(index, 1);
                } else {
                    // 기존 컬럼은 삭제 예정 표시 (soft delete)
                    pendingColumns[index]._toDelete = true;
                    // 화면에서 즉시 숨기기 위해 추가 플래그
                    pendingColumns[index]._hidden = true;
                }
            }
            
            renderColumns();
        }
        
        function toggleActive(id, isActive) {
            const index = pendingColumns.findIndex(c => String(c.id) === String(id));
            if (index !== -1 && !pendingColumns[index]._toDelete) {
                pendingColumns[index].is_active = isActive;
                if (!pendingColumns[index]._isNew) {
                    pendingColumns[index]._modified = true;
                }
                // 비활성화는 삭제가 아님을 명확히 함
                console.log(`컬럼 ${id} ${isActive ? '활성화' : '비활성화'} 처리`);
                renderColumns();
            }
        }
        
        function updateOrder() {
            const cards = document.querySelectorAll('.column-card');
            const newOrder = [];
            
            cards.forEach((card) => {
                const id = card.dataset.id; // parseInt 제거
                const column = pendingColumns.find(c => String(c.id) === String(id));
                if (column) {
                    newOrder.push(column);
                }
            });
            
            // pendingColumns를 새 순서로 업데이트
            pendingColumns = newOrder;
            
            // 순서 변경도 수정으로 표시
            pendingColumns.forEach((col, index) => {
                if (col.column_order !== index && !col._isNew) {
                    col._modified = true;
                }
                col.column_order = index;
            });
            
            renderColumns();
        }
        
        async function saveAllChanges() {
            // 변경사항이 있는지 확인
            const hasChanges = pendingColumns.some(c => c._isNew || c._modified || c._toDelete);
            
            if (!hasChanges) {
                alert('변경사항이 없습니다.');
                return;
            }
            
            if (!confirm('모든 변경사항을 저장하시겠습니까?')) {
                return;
            }
            
            try {
                let successCount = 0;
                let errorCount = 0;
                
                for (const column of pendingColumns) {
                    if (column._toDelete && !column._isNew) {
                        // 기존 컬럼 soft delete 처리 (is_deleted = 1)
                        console.log('Soft delete 처리 중:', column.id, column.column_name);
                        const response = await fetch(`/api/accident-columns/${column.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ is_deleted: 1 })
                        });
                        const result = await response.json();
                        console.log('Soft delete 응답:', result);
                        
                        if (response.ok) {
                            successCount++;
                            console.log('Soft delete 성공:', column.id, column.column_name);
                        } else {
                            errorCount++;
                            console.error('Soft delete 실패:', column.id, result.message);
                        }
                    } else if (column._isNew && !column._toDelete) {
                        // 새 컬럼 추가
                        const data = {
                            column_name: column.column_name,
                            column_key: column.column_key,
                            column_type: column.column_type,
                            is_active: column.is_active ? 1 : 0,
                            dropdown_options: column.dropdown_options,
                            column_order: column.column_order,
                            // 테이블 그룹인 경우 input_type 설정
                            input_type: (column.column_type === 'table') ? 'table' : null,
                            // 테이블 정보도 저장 (메타데이터로)
                            table_group: column._tableGroup || null,
                            table_type: column._tableType || null,
                            table_name: column._tableName || null
                        };
                        console.log('추가 처리 중:', data);
                        const response = await fetch('/api/accident-columns', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(data)
                        });
                        if (response.ok) {
                            successCount++;
                        } else {
                            errorCount++;
                            console.error('추가 실패:', data);
                        }
                    } else if (column._modified && !column._toDelete) {
                        // 기존 컬럼 수정
                        const data = {
                            column_name: column.column_name,
                            column_key: column.column_key,
                            column_type: column.column_type,
                            is_active: column.is_active ? 1 : 0,
                            dropdown_options: column.dropdown_options,
                            column_order: column.column_order,
                            // 테이블 그룹인 경우 input_type 설정
                            input_type: (column.column_type === 'table') ? 'table' : null,
                            // 테이블 정보도 저장 (메타데이터로)
                            table_group: column._tableGroup || null,
                            table_type: column._tableType || null,
                            table_name: column._tableName || null
                        };
                        console.log('수정 처리 중:', column.id, data);
                        const response = await fetch(`/api/accident-columns/${column.id}`, {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(data)
                        });
                        if (response.ok) {
                            successCount++;
                        } else {
                            errorCount++;
                            console.error('수정 실패:', column.id);
                        }
                    }
                }
                
                if (errorCount > 0) {
                    alert(`일부 변경사항 저장 중 오류가 발생했습니다.\n성공: ${successCount}, 실패: ${errorCount}`);
                } else {
                    alert('모든 변경사항이 저장되었습니다.');
                }
                
                loadColumns(); // 새로고침
                
            } catch (error) {
                console.error('저장 중 오류:', error);
                alert('저장 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        function resetChanges() {
            const hasChanges = pendingColumns.some(c => c._isNew || c._modified || c._toDelete);
            
            if (hasChanges) {
                if (!confirm('모든 변경사항을 취소하시겠습니까?')) {
                    return;
                }
            }
            
            loadColumns(); // 원본 다시 로드
        }
        
        function updatePreview() {
            // 미리보기 기능이 제거되었습니다
        }
        
        // 코드 편집기 관련 함수들
        let currentEditingColumnKey = null;
        
        // 드롭다운 옵션 미리보기 로드
        async function loadOptionPreview(columnKey) {
            try {
            const boardType = 'accident';
            const response = await fetch(`/api/${boardType}/dropdown-codes?column_key=${encodeURIComponent(columnKey)}`);
                const data = await response.json();
                
                if (data.success && data.codes && data.codes.length > 0) {
                    const previewDiv = document.getElementById('optionPreview');
                    const previewBody = document.getElementById('optionPreviewBody');
                    
                    previewBody.innerHTML = data.codes.map(code => `
                        <tr>
                            <td><code>${code.code}</code></td>
                            <td>${code.value}</td>
                        </tr>
                    `).join('');
                    
                    previewDiv.style.display = 'block';
                } else {
                    document.getElementById('optionPreview').style.display = 'none';
                }
            } catch (error) {
                console.error('옵션 미리보기 로드 실패:', error);
            }
        }
        
        function openCodeEditor() {
            const columnKey = document.getElementById('columnKey').value;
            if (!columnKey) {
                alert('컬럼 키를 먼저 입력해주세요.');
                return;
            }
            
            currentEditingColumnKey = columnKey;
            
            // 새 창에서 코드 편집기 열기
            const width = 1200;
            const height = 800;
            const left = (window.screen.width - width) / 2;
            const top = (window.screen.height - height) / 2;
            
            const codeEditorWindow = window.open(
                `/admin/accident-columns?column_key=${columnKey}&embedded=true`,
                'codeEditor',
                `width=${width},height=${height},left=${left},top=${top},scrollbars=yes,resizable=yes`
            );
            
            // 메시지 리스너 설정
            window.addEventListener('message', function(event) {
                if (event.data.type === 'DROPDOWN_CODES_SAVED') {
                    handleCodesSaved(event.data.columnKey, event.data.codes);
                }
            });
        }
        
        function handleCodesSaved(columnKey, codes) {
            if (columnKey === currentEditingColumnKey) {
                // 코드를 JSON 문자열로 저장 (배열 형태 유지)
                const optionValues = codes.map(code => code.value);
                document.getElementById('dropdownOptions').value = JSON.stringify(optionValues);
                
                // 미리보기 업데이트
                loadOptionPreview(columnKey);
                
                // 사용자에게 알림
                const alert = document.createElement('div');
                alert.className = 'alert alert-success alert-dismissible fade show';
                alert.innerHTML = `
                    <i class="bi bi-check-circle"></i> 드롭다운 옵션이 설정되었습니다. (${codes.length}개)
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.getElementById('optionsField').appendChild(alert);
                
                setTimeout(() => {
                    alert.remove();
                }, 3000);
            }
        }
        
        // ==================== 테이블 설정 관련 함수 ====================
        let selectedTableType = null;
        let tableColumnMappings = {
            'person': {
                name: '담당자',
                columns: [
                    { name: '담당자', key_suffix: '', type: 'popup_person' },
                    { name: '담당자 부서', key_suffix: '_dept', type: 'linked_dept' }
                ]
            },
            'company': {
                name: '업체',
                columns: [
                    { name: '업체명', key_suffix: '', type: 'popup_company' },
                    { name: '사업자번호', key_suffix: '_bizno', type: 'linked_text' }
                ]
            },
            'department': {
                name: '부서',
                columns: [
                    { name: '부서명', key_suffix: '', type: 'popup_department' },
                    { name: '부서코드', key_suffix: '_code', type: 'linked_text' }
                ]
            },
            'building': {
                name: '건물',
                columns: [
                    { name: '건물명', key_suffix: '', type: 'popup_building' },
                    { name: '건물코드', key_suffix: '_code', type: 'linked_text' }
                ]
            },
            'contractor': {
                name: '협력사 근로자',
                columns: [
                    { name: '성함', key_suffix: '', type: 'popup_contractor' },
                    { name: 'ID', key_suffix: '_id', type: 'linked_text' },
                    { name: '소속업체', key_suffix: '_company', type: 'popup_company' },
                    { name: '사업자번호', key_suffix: '_bizno', type: 'linked_text' }
                ]
            }
        };
        
        function openTableConfigModal() {
            selectedTableType = null;
            
            // 테이블 목록 동적 생성
            const tableListContainer = document.getElementById('tableList');
            tableListContainer.innerHTML = '';
            
            // 아이콘 매핑
            const icons = {
                'person': 'bi-person-fill',
                'company': 'bi-building',
                'department': 'bi-diagram-3',
                'building': 'bi-house-door',
                'contractor': 'bi-people-fill'
            };
            
            // tableColumnMappings에서 테이블 목록 생성
            for (const [key, config] of Object.entries(tableColumnMappings)) {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'list-group-item list-group-item-action';
                button.dataset.tableType = key;  // 데이터 속성 추가
                button.onclick = () => selectTable(key);
                button.innerHTML = `
                    <i class="bi ${icons[key] || 'bi-table'}"></i> ${config.name}
                `;
                tableListContainer.appendChild(button);
            }
            
            document.getElementById('confirmTableBtn').disabled = true;
            
            // 초기 미리보기 표시
            document.getElementById('tablePreview').innerHTML = `
                <div class="text-muted text-center" style="padding: 50px 0;">
                    <i class="bi bi-table" style="font-size: 48px;"></i>
                    <p class="mt-3">왼쪽에서 테이블을 선택하세요</p>
                </div>
            `;
            
            const modalElement = document.getElementById('tableConfigModal');
            let modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (!modalInstance) {
                modalInstance = new bootstrap.Modal(modalElement);
            }
            modalInstance.show();
        }
        
        function selectTable(tableType) {
            selectedTableType = tableType;
            
            // 활성 표시 업데이트 - 데이터 속성 사용
            document.querySelectorAll('#tableList .list-group-item').forEach((item) => {
                if (item.dataset.tableType === tableType) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // 확인 버튼 활성화
            document.getElementById('confirmTableBtn').disabled = false;
            
            // 미리보기 업데이트
            updateTablePreview(tableType);
        }
        
        function updateTablePreview(tableType) {
            const config = tableColumnMappings[tableType];
            if (!config) return;
            
            const baseColumnName = document.getElementById('columnName').value || config.name;
            const baseColumnKey = document.getElementById('columnKey').value || tableType;
            
            let previewHtml = `
                <div class="mb-3">
                    <h6 class="text-primary mb-3">
                        <i class="bi bi-info-circle"></i> 
                        "${config.name}" 테이블 선택 시 생성될 컬럼들
                    </h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th width="40">#</th>
                                    <th>컬럼명</th>
                                    <th>컬럼 키</th>
                                    <th>타입</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            config.columns.forEach((col, index) => {
                const columnName = index === 0 ? baseColumnName : `${baseColumnName} ${col.name.split(' ').slice(-1)[0]}`;
                const columnKey = baseColumnKey + col.key_suffix;
                const typeLabel = getTypeLabel(col.type);
                
                previewHtml += `
                    <tr>
                        <td class="text-center">${index + 1}</td>
                        <td>${columnName}</td>
                        <td><code>${columnKey}</code></td>
                        <td><span class="badge bg-secondary">${typeLabel}</span></td>
                    </tr>
                `;
            });
            
            previewHtml += `
                            </tbody>
                        </table>
                    </div>
                    <div class="alert alert-info mt-3" style="font-size: 13px;">
                        <i class="bi bi-lightbulb"></i> 
                        위 컬럼들이 자동으로 생성되며, 생성 후 개별적으로 수정 가능합니다.
                    </div>
                </div>
            `;
            
            document.getElementById('tablePreview').innerHTML = previewHtml;
        }
        
        function closeTableConfigModal() {
            const modalElement = document.getElementById('tableConfigModal');
            const modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (modalInstance) {
                modalInstance.hide();
            }
            
            // 백드롭 제거
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                backdrop.remove();
            });
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
        }
        
        function confirmTableSelection() {
            if (!selectedTableType) return;
            
            const config = tableColumnMappings[selectedTableType];
            document.getElementById('selectedTableDisplay').value = config.name;
            document.getElementById('selectedTableConfig').value = selectedTableType;
            
            // 메인 모달의 미리보기 업데이트
            const baseColumnName = document.getElementById('columnName').value || config.name;
            const baseColumnKey = document.getElementById('columnKey').value || selectedTableType;
            
            let previewHtml = `
                <small class="text-muted">생성될 컬럼: </small>
            `;
            
            config.columns.forEach((col, index) => {
                const columnName = index === 0 ? baseColumnName : `${baseColumnName} ${col.name.split(' ').slice(-1)[0]}`;
                previewHtml += `<span class="badge bg-info me-1">${columnName}</span>`;
            });
            
            document.getElementById('tableColumnsPreview').innerHTML = previewHtml;
            document.getElementById('tableColumnsPreview').style.display = 'block';
            
            closeTableConfigModal();
        }
        
        // 컬럼명이나 키가 변경될 때 테이블 미리보기 업데이트
        document.getElementById('columnName').addEventListener('input', function() {
            if (selectedTableType) {
                updateTablePreview(selectedTableType);
            }
        });
        
        document.getElementById('columnKey').addEventListener('input', function() {
            if (selectedTableType) {
                updateTablePreview(selectedTableType);
            }
        });
</script>
{% endblock %}
