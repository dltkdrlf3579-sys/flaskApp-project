{% if is_popup %}
{% extends "popup-base.html" %}
{% else %}
{% extends "base.html" %}
{% endif %}

{% block head %}
{% endblock %}

{% block title %}환경안전 지시서 등록{% endblock %}
{% block popup_title %}환경안전 지시서 등록{% endblock %}
{% block content %}

{% if not is_popup %}
<div class="page-header">
    <h2 class="page-title">환경안전 지시서 등록</h2>
    <div class="breadcrumb">
        <a href="{{ url_for('page_view', url='safety-instruction') }}">환경안전 지시서</a>
        <span class="separator">></span>
        <span class="current">신규 등록</span>
    </div>
</div>
{% endif %}

<div class="accident-detail-container">
    <!-- 1. 기본정보 영역 -->
    <div class="section basic-info-section">
        <div class="section-header">
            <h3 class="section-title">기본정보</h3>
            <button class="collapse-btn" onclick="toggleSection('basic-info')">
                <span class="collapse-icon">▲</span>
            </button>
        </div>
        <div class="section-content" id="basic-info-content">
            <div class="info-table">
                <div class="info-row">
                    <div class="info-cell">
                        <label>발부번호</label>
                        <div class="value">자동 생성됩니다</div>
                    </div>
                    <div class="info-cell">
                        <label>발행인</label>
                        <input type="text" id="issuer" class="basic-input" placeholder="발행인 입력">
                    </div>
                    <div class="info-cell">
                        <label>발행부서</label>
                        <input type="text" id="issuer_department" class="basic-input" placeholder="발행부서 입력">
                    </div>
                    <div class="info-cell">
                        <label>분류</label>
                        <select id="classification" class="basic-input">
                            <option value="">선택하세요</option>
                            <option value="환경">환경</option>
                            <option value="안전">안전</option>
                            <option value="보건">보건</option>
                            <option value="품질">품질</option>
                        </select>
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-cell">
                        <label>고용형태</label>
                        <select id="employment_type" class="basic-input">
                            <option value="">선택하세요</option>
                            <option value="정규직">정규직</option>
                            <option value="계약직">계약직</option>
                            <option value="파견직">파견직</option>
                            <option value="임시직">임시직</option>
                        </select>
                    </div>
                    <div class="info-cell">
                        <label>1차사명</label>
                        <input type="text" id="primary_company" class="basic-input" placeholder="1차사명 입력">
                    </div>
                    <div class="info-cell">
                        <label>1차사_사업자번호</label>
                        <input type="text" id="primary_business_number" class="basic-input" placeholder="사업자번호 입력">
                    </div>
                    <div class="info-cell">
                        <label>하도사명</label>
                        <input type="text" id="subcontractor" class="basic-input" placeholder="하도사명 입력">
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-cell">
                        <label>하도사_사업자번호</label>
                        <input type="text" id="subcontractor_business_number" class="basic-input" placeholder="사업자번호 입력">
                    </div>
                    <div class="info-cell">
                        <label>징계자</label>
                        <input type="text" id="disciplined_person" class="basic-input" placeholder="징계자명 입력">
                    </div>
                    <div class="info-cell">
                        <label>GBM</label>
                        <input type="text" id="gbm" class="basic-input" placeholder="GBM 입력">
                    </div>
                    <div class="info-cell">
                        <label>사업부</label>
                        <input type="text" id="business_division" class="basic-input" placeholder="사업부 입력">
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-cell">
                        <label>팀</label>
                        <input type="text" id="team" class="basic-input" placeholder="팀명 입력">
                    </div>
                    <div class="info-cell">
                        <label>소속부서</label>
                        <input type="text" id="department" class="basic-input" placeholder="소속부서 입력">
                    </div>
                    <div class="info-cell">
                        <label>위반일자</label>
                        <input type="date" id="violation_date" class="basic-input">
                    </div>
                    <div class="info-cell">
                        <label>징계일자</label>
                        <input type="date" id="discipline_date" class="basic-input">
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-cell">
                        <label>징계발의부서</label>
                        <input type="text" id="discipline_department" class="basic-input" placeholder="징계발의부서 입력">
                    </div>
                    <div class="info-cell">
                        <label>징계유형</label>
                        <select id="discipline_type" class="basic-input">
                            <option value="">선택하세요</option>
                            <option value="경고">경고</option>
                            <option value="견책">견책</option>
                            <option value="정직">정직</option>
                            <option value="출입정지">출입정지</option>
                        </select>
                    </div>
                    <div class="info-cell">
                        <label>사고유형</label>
                        <select id="accident_type" class="basic-input">
                            <option value="">선택하세요</option>
                            <option value="추락">추락</option>
                            <option value="협착">협착</option>
                            <option value="절단">절단</option>
                            <option value="화재">화재</option>
                            <option value="누출">누출</option>
                        </select>
                    </div>
                    <div class="info-cell">
                        <label>사고등급</label>
                        <select id="accident_grade" class="basic-input">
                            <option value="">선택하세요</option>
                            <option value="경미">경미</option>
                            <option value="일반">일반</option>
                            <option value="중대">중대</option>
                            <option value="치명">치명</option>
                        </select>
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-cell">
                        <label>환경안전수칙 위반등급</label>
                        <select id="safety_violation_grade" class="basic-input">
                            <option value="">선택하세요</option>
                            <option value="경미">경미</option>
                            <option value="일반">일반</option>
                            <option value="중대">중대</option>
                            <option value="치명">치명</option>
                        </select>
                    </div>
                    <div class="info-cell">
                        <label>위반유형</label>
                        <select id="violation_type" class="basic-input">
                            <option value="">선택하세요</option>
                            <option value="작업절차위반">작업절차위반</option>
                            <option value="안전장비미착용">안전장비미착용</option>
                            <option value="무단작업">무단작업</option>
                            <option value="환경오염">환경오염</option>
                        </select>
                    </div>
                    <div class="info-cell">
                        <label>출입정지 시작일</label>
                        <input type="date" id="access_ban_start_date" class="basic-input">
                    </div>
                    <div class="info-cell">
                        <label>출입정지 종료일</label>
                        <input type="date" id="access_ban_end_date" class="basic-input">
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-cell">
                        <label>기간</label>
                        <input type="text" id="period" class="basic-input" placeholder="예: 7일">
                    </div>
                    <div class="info-cell">
                        <label>작업등급</label>
                        <input type="text" id="work_grade" class="basic-input" placeholder="작업등급 입력">
                    </div>
                    <div class="info-cell">
                        <label>감점</label>
                        <input type="number" id="penalty_points" class="basic-input" placeholder="감점 입력">
                    </div>
                    <div class="info-cell">
                        <label>징계자ID</label>
                        <input type="text" id="disciplined_person_id" class="basic-input" placeholder="징계자ID 입력">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. 위반 상세내용 영역 -->
    <div class="section detail-content-section">
        <div class="section-header">
            <h3 class="section-title">위반 상세내용</h3>
        </div>
        <div class="section-content">
            <div class="content-editor">
                <!-- 간단한 편집 가능한 영역 -->
                <div id="detailed-content" 
                     class="editable-content" 
                     contenteditable="true" 
                     placeholder="위반에 대한 상세 내용을 입력하세요."></div>
                
                <!-- 숨겨진 textarea (저장용) -->
                <textarea id="detailed-content-hidden" style="display: none;"></textarea>
            </div>
        </div>
    </div>

    <!-- 3. 첨부파일 영역 -->
    <div class="section attachments-section">
        <div class="section-header">
            <h3 class="section-title">첨부파일</h3>
            <button class="btn-add-file" onclick="document.getElementById('file-input').click();">추가</button>
            <span class="file-count">총 <span id="file-count">0</span>개</span>
            <span class="file-size"><span id="file-size">0</span> MB / 50 MB</span>
        </div>
        <div class="section-content">
            <input type="file" id="file-input" multiple style="display: none;" onchange="handleFileUpload(this.files)">
            <div class="attachments-table">
                <div class="table-header">
                    <div class="col-no">No.</div>
                    <div class="col-file">파일명</div>
                    <div class="col-desc">설명</div>
                    <div class="col-action">상태</div>
                </div>
                <div class="table-body" id="attachments-tbody">
                    <div class="table-row no-data" id="no-data-row">
                        <div class="col-full">등록된 첨부파일이 없습니다.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 저장 버튼 영역 -->
    <div class="save-section">
        <button class="btn-save" onclick="registerSafetyInstruction()">등록완료</button>
    </div>
</div>

<!-- 사고 등록과 동일한 스타일 사용 -->
<link rel="stylesheet" href="/static/styles/accident-register.css">

<script>
// 사고 등록과 동일한 스크립트 로직 사용
// 섹션 토글
function toggleSection(sectionId) {
    const content = document.getElementById(sectionId + '-content');
    const section = content.parentElement;
    content.classList.toggle('collapsed');
    section.classList.toggle('collapsed');
}

// 첨부파일 처리
let attachedFiles = [];
let totalFileSize = 0;

function handleFileUpload(files) {
    const maxSize = 50 * 1024 * 1024; // 50MB
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        // 크기 체크
        if (totalFileSize + file.size > maxSize) {
            alert('총 파일 크기가 50MB를 초과할 수 없습니다.');
            continue;
        }
        
        // 중복 파일명 체크
        if (attachedFiles.some(f => f.name === file.name)) {
            alert(`파일 "${file.name}"은 이미 추가되었습니다.`);
            continue;
        }
        
        attachedFiles.push(file);
        totalFileSize += file.size;
        addFileToTable(file);
    }
    
    updateFileStats();
}

function addFileToTable(file) {
    const tbody = document.getElementById('attachments-tbody');
    const noDataRow = document.getElementById('no-data-row');
    
    if (noDataRow) {
        noDataRow.style.display = 'none';
    }
    
    const row = document.createElement('div');
    row.className = 'table-row';
    row.innerHTML = `
        <div class="col-no">${attachedFiles.length}</div>
        <div class="col-file">${file.name}</div>
        <div class="col-desc">
            <input type="text" placeholder="파일 설명 입력" class="file-desc-input">
        </div>
        <div class="col-action">
            <button class="btn-remove" onclick="removeFile('${file.name}', this)">삭제</button>
        </div>
    `;
    
    tbody.appendChild(row);
}

function removeFile(fileName, button) {
    const fileIndex = attachedFiles.findIndex(f => f.name === fileName);
    if (fileIndex > -1) {
        totalFileSize -= attachedFiles[fileIndex].size;
        attachedFiles.splice(fileIndex, 1);
        
        button.closest('.table-row').remove();
        updateFileStats();
        renumberFiles();
        
        if (attachedFiles.length === 0) {
            document.getElementById('no-data-row').style.display = 'block';
        }
    }
}

function renumberFiles() {
    const rows = document.querySelectorAll('#attachments-tbody .table-row:not(.no-data)');
    rows.forEach((row, index) => {
        row.querySelector('.col-no').textContent = index + 1;
    });
}

function updateFileStats() {
    document.getElementById('file-count').textContent = attachedFiles.length;
    document.getElementById('file-size').textContent = (totalFileSize / (1024 * 1024)).toFixed(1);
}

// 환경안전 지시서 등록 함수
function registerSafetyInstruction() {
    // 필수 필드 유효성 검사
    const issuer = document.getElementById('issuer').value.trim();
    const primary_company = document.getElementById('primary_company').value.trim();
    const disciplined_person = document.getElementById('disciplined_person').value.trim();
    
    if (!issuer) {
        alert('발행인은 필수 입력 항목입니다.');
        document.getElementById('issuer').focus();
        return;
    }
    
    if (!primary_company) {
        alert('1차사명은 필수 입력 항목입니다.');
        document.getElementById('primary_company').focus();
        return;
    }
    
    if (!disciplined_person) {
        alert('징계자는 필수 입력 항목입니다.');
        document.getElementById('disciplined_person').focus();
        return;
    }
    
    // 저장 확인
    if (!confirm('환경안전 지시서를 등록하시겠습니까?')) {
        return;
    }
    
    // 버튼 비활성화 및 로딩 표시
    const saveBtn = document.querySelector('.btn-save');
    const originalText = saveBtn.textContent;
    saveBtn.disabled = true;
    saveBtn.textContent = '등록 중...';
    
    // FormData 생성
    const formData = new FormData();
    
    // 기본 필드 추가
    formData.append('issuer', document.getElementById('issuer').value);
    formData.append('issuer_department', document.getElementById('issuer_department').value);
    formData.append('classification', document.getElementById('classification').value);
    formData.append('employment_type', document.getElementById('employment_type').value);
    formData.append('primary_company', document.getElementById('primary_company').value);
    formData.append('primary_business_number', document.getElementById('primary_business_number').value);
    formData.append('subcontractor', document.getElementById('subcontractor').value);
    formData.append('subcontractor_business_number', document.getElementById('subcontractor_business_number').value);
    formData.append('disciplined_person', document.getElementById('disciplined_person').value);
    formData.append('gbm', document.getElementById('gbm').value);
    formData.append('business_division', document.getElementById('business_division').value);
    formData.append('team', document.getElementById('team').value);
    formData.append('department', document.getElementById('department').value);
    formData.append('violation_date', document.getElementById('violation_date').value);
    formData.append('discipline_date', document.getElementById('discipline_date').value);
    formData.append('discipline_department', document.getElementById('discipline_department').value);
    formData.append('discipline_type', document.getElementById('discipline_type').value);
    formData.append('accident_type', document.getElementById('accident_type').value);
    formData.append('accident_grade', document.getElementById('accident_grade').value);
    formData.append('safety_violation_grade', document.getElementById('safety_violation_grade').value);
    formData.append('violation_type', document.getElementById('violation_type').value);
    // violation_content 대신 detailed_content 전송
    const detailedContent = document.getElementById('detailed-content').innerHTML;
    formData.append('detailed_content', detailedContent);
    formData.append('access_ban_start_date', document.getElementById('access_ban_start_date').value);
    formData.append('access_ban_end_date', document.getElementById('access_ban_end_date').value);
    formData.append('period', document.getElementById('period').value);
    formData.append('work_grade', document.getElementById('work_grade').value);
    formData.append('penalty_points', document.getElementById('penalty_points').value);
    formData.append('disciplined_person_id', document.getElementById('disciplined_person_id').value);
    
    // 동적 컬럼 데이터 (현재는 빈 객체)
    formData.append('custom_data', JSON.stringify({}));
    
    // 첨부파일 데이터
    const attachmentData = [];
    document.querySelectorAll('#attachments-tbody .table-row:not(.no-data)').forEach((row, index) => {
        const descInput = row.querySelector('.file-desc-input');
        attachmentData.push({
            description: descInput ? descInput.value : ''
        });
    });
    formData.append('attachment_data', JSON.stringify(attachmentData));
    
    // 첨부파일들 추가
    attachedFiles.forEach(file => {
        formData.append('files', file);
    });
    
    // API 호출
    fetch('/register-safety-instruction', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`환경안전 지시서가 성공적으로 등록되었습니다.\n발부번호: ${data.issue_number}`);
            
            // 부모 창 새로고침
            if (window.opener && !window.opener.closed) {
                window.opener.location.reload();
            }
            
            // 팝업 닫기
            if (window.opener) {
                window.close();
            }
        } else {
            alert('등록 실패: ' + (data.message || '알 수 없는 오류가 발생했습니다.'));
        }
    })
    .catch(error => {
        console.error('등록 오류:', error);
        alert('등록 중 오류가 발생했습니다. 다시 시도해주세요.');
    })
    .finally(() => {
        // 버튼 복원
        saveBtn.disabled = false;
        saveBtn.textContent = originalText;
    });
}
</script>

<style>
/* 페이지 헤더 */
.page-header {
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #2f5fd3;
}
.page-title {
    font-size: 20px;
    font-weight: 700;
    color: #333;
    margin: 0 0 8px 0;
}
.breadcrumb {
    font-size: 14px;
    color: #6b7280;
}
.breadcrumb a {
    color: #2f5fd3;
    text-decoration: none;
}
.breadcrumb a:hover {
    text-decoration: underline;
}
.breadcrumb .separator {
    margin: 0 8px;
}
.breadcrumb .current {
    color: #111827;
}

/* 컨테이너 */
.accident-detail-container {
    padding: 20px;
    background: #f3f4f6;
    min-height: calc(100vh - 100px);
}

/* 섹션 공통 */
.section {
    margin-bottom: 24px;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: #f8f9fa;
    border-bottom: 1px solid #e5e7eb;
}

.section-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin: 0;
}

.collapse-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px 8px;
    color: #666;
}

.collapse-icon {
    display: inline-block;
    transition: transform 0.3s;
}

.collapsed .collapse-icon {
    transform: rotate(180deg);
}

.section-content {
    padding: 20px;
}

.section-content.collapsed {
    display: none;
}

/* 정보 테이블 */
.info-table {
    width: 100%;
}

.info-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 16px;
}

.info-row:last-child {
    margin-bottom: 0;
}

.info-cell {
    display: flex;
    flex-direction: column;
}

.info-cell label {
    font-weight: 600;
    color: #374151;
    margin-bottom: 6px;
    font-size: 13px;
}

.info-cell .value {
    padding: 8px 12px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    color: #111827;
    min-height: 36px;
    display: flex;
    align-items: center;
}

/* 입력 필드 */
.basic-input,
select,
textarea {
    padding: 8px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    font-size: 14px;
    width: 100%;
    box-sizing: border-box;
    background: white;
}

.basic-input:focus,
select:focus,
textarea:focus {
    outline: none;
    border-color: #2f5fd3;
    box-shadow: 0 0 0 2px rgba(47, 95, 211, 0.1);
}

/* 편집 가능한 컨텐츠 */
.content-editor {
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    background: white;
}

.editable-content {
    min-height: 200px;
    padding: 16px;
    border: none;
    outline: none;
    font-size: 14px;
    line-height: 1.6;
}

.editable-content:empty:before {
    content: attr(placeholder);
    color: #9ca3af;
    font-style: italic;
}

/* 첨부파일 영역 */
.attachments-section .section-header {
    align-items: center;
    gap: 16px;
}

.btn-add-file {
    padding: 6px 16px;
    background: #2f5fd3;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 13px;
    cursor: pointer;
}

.file-count, .file-size {
    font-size: 13px;
    color: #6b7280;
}

.attachments-table {
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
}

.table-header {
    display: grid;
    grid-template-columns: 60px 1fr 200px 100px;
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
    font-weight: 600;
    font-size: 13px;
    color: #374151;
}

.table-header > div {
    padding: 12px 16px;
    border-right: 1px solid #e5e7eb;
}

.table-header > div:last-child {
    border-right: none;
}

.table-row {
    display: grid;
    grid-template-columns: 60px 1fr 200px 100px;
    border-bottom: 1px solid #f3f4f6;
}

.table-row > div {
    padding: 12px 16px;
    border-right: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
}

.table-row > div:last-child {
    border-right: none;
}

.no-data {
    grid-column: 1 / -1;
    text-align: center;
    color: #9ca3af;
    font-style: italic;
    padding: 40px;
}

.file-desc-input {
    border: none;
    outline: none;
    background: transparent;
    width: 100%;
}

.btn-remove {
    padding: 4px 8px;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
}

/* 저장 버튼 영역 */
.save-section {
    display: flex;
    justify-content: center;
    padding: 24px 20px;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
}

.btn-save {
    padding: 12px 40px;
    background: #2f5fd3;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-save:hover {
    background: #1e4bb8;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(47, 95, 211, 0.3);
}

/* 반응형 */
@media (max-width: 768px) {
    .info-row {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 480px) {
    .info-row {
        grid-template-columns: 1fr;
    }
}
</style>

{% endblock %}