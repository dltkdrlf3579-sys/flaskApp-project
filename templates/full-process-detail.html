{% if is_popup %}
{% extends "popup-base.html" %}
{% else %}
{% extends "base.html" %}
{% endif %}

{% from 'includes/board_form/detail_content.html' import render_detail_content %}
{% from 'includes/board_form/save_controls.html' import render_save_button, render_password_modal %}

{% block head %}
    {{ super() }}
    {% include 'includes/board_form_scripts.html' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/scoring-system.css') }}">
    <script src="{{ url_for('static', filename='js/scoring-system.js') }}"></script>
    <script src="{{ url_for('static', filename='js/scoring-external.js') }}"></script>
{% endblock %}

{% block title %}Full Process 상세정보{% endblock %}
{% block popup_title %}{{ process.fullprocess_number }} - Full Process 상세정보{% endblock %}
{% block content %}

{% if not is_popup %}
<div class="page-header">
    <h2 class="page-title">Full Process 상세정보</h2>
    <div class="breadcrumb">
        <a href="{{ url_for('page_view', url='full-process') }}">Full Process</a>
        <span class="separator">></span>
        <span class="current">{{ process.fullprocess_number }}</span>
    </div>
</div>
{% endif %}

<div class="fullprocess-detail-container">
    <!-- 동적 섹션 렌더링 -->
    {% for section in sections %}
    <div class="section {{ section.section_key }}-section">
        <div class="section-header">
            <h3 class="section-title">{{ section.section_name }}</h3>
            <button class="collapse-btn" onclick="BoardDetail.toggleSection('{{ section.section_key }}', this)">
                <span class="collapse-icon">▲</span>
            </button>
        </div>
        <div class="section-content" id="{{ section.section_key }}-content">
            <div class="info-table">
                <!-- 평가번호와 등록일 추가 (첫 번째 섹션에만) -->
                {% if loop.index == 1 %}
                <div class="info-row">
                    <div class="info-cell span-2">
                        <label>평가번호</label>
                        <input type="text" value="{{ process.fullprocess_number or '-' }}" readonly class="readonly-highlight">
                    </div>
                    <div class="info-cell span-2">
                        <label>등록일</label>
                        <input type="text" value="{{ (process.created_at|date_only) if process.created_at else '-' }}" readonly class="readonly-highlight">
                    </div>
                </div>
                {% endif %}
                
                {% set all_columns = section_columns[section.section_key] %}
                <!-- detailed_content와 violation_content는 제외하고 일반 필드만 batch 처리 -->
                {% set columns = [] %}
                {% for col in all_columns %}
                    {% if col.column_key not in ['detailed_content', 'violation_content', 'fullprocess_number', 'created_at'] %}
                        {% set _ = columns.append(col) %}
                    {% endif %}
                {% endfor %}
                {% set columns_per_row = 8 %}
                
                <!-- batch 방식으로 4개씩 묶어서 처리 -->
                {% for chunk in columns | batch(columns_per_row, '') %}
                <div class="info-row">
                    {% for col in chunk %}
                        {% if col %}
                            {% if col.column_type == 'list' %}
                                {% set span = 8 %}
                            {% elif col.column_type == 'scoring' %}
                                {# 모든 scoring 그룹은 항상 전체 폭(8칸)을 차지 #}
                                {% set span = 8 %}
                            {% elif col.column_type == 'score_total' %}
                                {# 이전 컬럼이 scoring이면 span 0 (이미 처리됨) #}
                                {% set prev_idx = loop.index0 - 1 %}
                                {% set prev_col = chunk[prev_idx] if prev_idx >= 0 else None %}
                                {% if prev_col and prev_col.column_type == 'scoring' %}
                                    {% set span = 0 %}
                                {% else %}
                                    {% set span = 2 %}
                                {% endif %}
                            {% elif col.column_span and col.column_span|int > 0 %}
                                {% set cs = col.column_span|int %}
                                {% set span = cs if cs >= 2 else 2 %}
                            {% else %}
                                {% set span = 2 %}
                            {% endif %}
                            
                            {% if col.column_type == 'list' %}
                                <!-- 리스트 필드는 항상 custom_data에서 가져오기 -->
                                {% set col_value = custom_data.get(col.column_key, '[]') if custom_data else '[]' %}
                            {% elif col.column_type == 'score_total' %}
                                <!-- score_total 필드는 custom_data에서 가져오기 -->
                                {% set col_value = custom_data.get(col.column_key, '') if custom_data else '' %}
                            {% elif col.column_type == 'scoring' %}
                                <!-- scoring 필드는 custom_data에서 가져오기 -->
                                {% set col_value = custom_data.get(col.column_key, '{}') if custom_data else '{}' %}
                            {% else %}
                                {% set col_value = process[col.column_key] | default('', true) %}
                            {% endif %}

                            {% set render_type = col.column_type %}
                            {% if not render_type or render_type == 'text' %}
                                {% set suffixes = ['_id','_dept','_bizno','_code','_company'] %}
                                {% set base_key = col.column_key %}
                                {% for s in suffixes %}
                                    {% if base_key.endswith(s) %}
                                        {% set suffix_len = s|length %}
                                        {% if suffix_len > 0 %}
                                            {% set base_key = base_key[:-suffix_len] %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                {% set all_keys = (all_column_keys if all_column_keys is defined else (section_columns[section.section_key] | map(attribute='column_key') | list)) + ((custom_data.keys() | list) if custom_data else []) %}
                                {% set group = '' %}
                                {% if (base_key ~ '_bizno') in all_keys %}
                                    {% set group = 'company' %}
                                {% elif (base_key ~ '_dept') in all_keys %}
                                    {% set group = 'person' %}
                                {% elif (base_key ~ '_code') in all_keys %}
                                    {% set group = 'department' %}
                                {% elif (base_key ~ '_company') in all_keys %}
                                    {% set group = 'contractor' %}
                                {% endif %}
                                {% if group == 'person' %}
                                    {% set render_type = 'popup_person' %}
                                {% elif group == 'company' %}
                                    {% set render_type = 'popup_company' %}
                                {% elif group == 'department' %}
                                    {% set render_type = 'popup_department' %}
                                {% elif group == 'contractor' %}
                                    {% set render_type = 'popup_contractor' %}
                                {% endif %}
                            {% endif %}

                            <!-- DEBUG: col={{ col.column_key }}, type={{ col.column_type }}, span={{ span }} -->
                            {% if span > 0 %}
                            <div class="info-cell span-{{ span }}">
                                {% if col.column_type not in ['scoring', 'score_total'] %}
                                <label>{{ col.column_name }}</label>
                                {% endif %}

                                {% if col.column_type == 'list' %}
                                    <!-- 리스트 필드는 항상 custom_data에서 가져오기 -->
                                    {% set col_value = custom_data.get(col.column_key, '[]') if custom_data else '[]' %}
                                {% else %}
                                    {% set proc_val = process.get(col.column_key) if process else None %}
                                    {% set col_value = (proc_val if proc_val not in (None, '') else (custom_data.get(col.column_key) if custom_data else '')) %}
                                {% endif %}

                                {% if col.column_type == 'dropdown' %}
                                    <!-- 드롭다운 필드 -->
                                    <select class="{{ section.section_key }}-input" 
                                            data-field="{{ col.column_key }}"
                                            data-section="{{ section.section_key }}">
                                        <option value="">선택하세요</option>
                                        {% if col.column_key in basic_options %}
                                            {% for opt in basic_options[col.column_key] %}
                                            <option value="{{ opt.code }}" 
                                                    {% if opt.code == col_value %}selected{% endif %}>
                                                {{ opt.value }}
                                            </option>
                                            {% endfor %}
                                        {% elif col.dropdown_options_mapped %}
                                            {% for opt in col.dropdown_options_mapped %}
                                            <option value="{{ opt.code }}"
                                                    {% if opt.code == col_value %}selected{% endif %}>
                                                {{ opt.value }}
                                            </option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                    
                                {% elif col.column_type == 'date' %}
                                    <!-- 날짜 필드 -->
                                    <input type="date" 
                                           class="{{ section.section_key }}-input" 
                                           data-field="{{ col.column_key }}"
                                           data-section="{{ section.section_key }}"
                                           value="{{ col_value }}">
                                           
                                {% elif col.column_type == 'time' %}
                                    <!-- 시간 필드 -->
                                    <input type="time" 
                                           class="{{ section.section_key }}-input" 
                                           data-field="{{ col.column_key }}"
                                           data-section="{{ section.section_key }}"
                                           value="{{ col_value }}"
                                           placeholder="시간 선택">
                                           
                                {% elif col.column_type == 'list' %}
                                    <!-- 리스트 필드 -->
                                    {% from 'includes/list_field_v3.html' import render_list_field %}
                                    {{ render_list_field(col, col_value, section, mode='edit') }}
                                           
                                {% elif col.column_type == 'number' %}
                                    <!-- 숫자 필드 -->
                                    {% set _nt = 'integer' if col.input_type == 'number_integer' else 'float' %}
                                    <input type="number" 
                                           class="{{ section.section_key }}-input" 
                                           data-field="{{ col.column_key }}"
                                           data-section="{{ section.section_key }}"
                                           data-number-type="{{ _nt }}"
                                           step="{% if _nt == 'integer' %}1{% else %}any{% endif %}"
                                           value="{{ col_value }}"
                                           oninput="validateNumberInput(this)"
                                           onkeypress="return isNumberKey(event, this)"
                                           placeholder="숫자만 입력하세요">
                                           
                                {% elif col.column_type == 'linked_text' %}
                                    <!-- 연결된 필드 (읽기 전용) -->
                                    <input type="text"
                                           id="{{ col.column_key }}"
                                           class="{{ section.section_key }}-input linked-field"
                                           data-field="{{ col.column_key }}"
                                           data-section="{{ section.section_key }}"
                                           {% if col.table_group %}data-table-group="{{ col.table_group }}"{% endif %}
                                           {% if col.table_type %}data-table-type="{{ col.table_type }}"{% endif %}
                                           value="{{ col_value }}"
                                           readonly>
                                           
                                {% elif col.column_type == 'popup' %}
                                    <!-- 팝업 필드 -->
                                    <div class="input-group">
                                        <input type="text"
                                               id="{{ col.column_key }}"
                                               class="{{ section.section_key }}-input"
                                               data-field="{{ col.column_key }}"
                                               data-section="{{ section.section_key }}"
                                               {% if col.table_group %}data-table-group="{{ col.table_group }}"{% endif %}
                                               {% if col.table_type %}data-table-type="{{ col.table_type }}"{% endif %}
                                               value="{{ col_value }}"
                                               readonly>
                                        <button class="btn btn-sm btn-primary"
                                                onclick="alert('팝업 타입이 구현되지 않았습니다.')">
                                            검색
                                        </button>
                                    </div>
                                    
                                {% elif render_type == 'popup_person' %}
                                    <!-- 담당자 검색 필드 -->
                                    <div class="input-group">
                                        <input type="text"
                                               id="{{ col.column_key }}"
                                               class="{{ section.section_key }}-input"
                                               data-field="{{ col.column_key }}"
                                               data-section="{{ section.section_key }}"
                                               data-input-type="popup_person"
                                               {% if col.table_group %}data-table-group="{{ col.table_group }}"{% endif %}
                                               {% if col.table_type %}data-table-type="{{ col.table_type }}"{% endif %}
                                               value="{{ col_value }}"
                                               readonly
                                               style="background-color: #f8f9fa;">
                                        <button class="btn btn-sm btn-primary" 
                                                onclick="openPersonSearch('{{ col.column_key }}')">
                                            검색
                                        </button>
                                    </div>
                                    
                                {% elif render_type == 'popup_company' %}
                                    <!-- 업체 검색 필드 -->
                                    <div class="input-group">
                                        <input type="text"
                                               id="{{ col.column_key }}"
                                               class="{{ section.section_key }}-input"
                                               data-field="{{ col.column_key }}"
                                               data-section="{{ section.section_key }}"
                                               data-input-type="popup_company"
                                               {% if col.table_group %}data-table-group="{{ col.table_group }}"{% endif %}
                                               {% if col.table_type %}data-table-type="{{ col.table_type }}"{% endif %}
                                               value="{{ col_value }}"
                                               readonly
                                               style="background-color: #f8f9fa;">
                                        <button class="btn btn-sm btn-primary" 
                                                onclick="openCompanySearch('{{ col.column_key }}')">
                                            검색
                                        </button>
                                    </div>
                                    
                                {% elif render_type == 'popup_building' %}
                                    <!-- 건물 검색 필드 -->
                                    <div class="input-group">
                                        <input type="text"
                                               id="{{ col.column_key }}"
                                               class="{{ section.section_key }}-input"
                                               data-field="{{ col.column_key }}"
                                               data-section="{{ section.section_key }}"
                                               data-input-type="popup_building"
                                               {% if col.table_group %}data-table-group="{{ col.table_group }}"{% endif %}
                                               {% if col.table_type %}data-table-type="{{ col.table_type }}"{% endif %}
                                               value="{{ col_value }}"
                                               readonly
                                               style="background-color: #f8f9fa;">
                                        <button class="btn btn-sm btn-primary" 
                                                onclick="openBuildingSearch('{{ col.column_key }}')">
                                            검색
                                        </button>
                                    </div>
                                    
                                {% elif render_type == 'popup_department' %}
                                    <!-- 부서 검색 필드 -->
                                    <div class="input-group">
                                        <input type="text"
                                               id="{{ col.column_key }}"
                                               class="{{ section.section_key }}-input"
                                               data-field="{{ col.column_key }}"
                                               data-section="{{ section.section_key }}"
                                               data-input-type="popup_department"
                                               {% if col.table_group %}data-table-group="{{ col.table_group }}"{% endif %}
                                               {% if col.table_type %}data-table-type="{{ col.table_type }}"{% endif %}
                                               value="{{ col_value }}"
                                               readonly
                                               style="background-color: #f8f9fa;">
                                        <button class="btn btn-sm btn-primary" 
                                                onclick="openDepartmentSearch('{{ col.column_key }}')">
                                            검색
                                        </button>
                                    </div>
                                    
                                {% elif render_type == 'popup_contractor' %}
                                    <!-- 협력사 근로자 검색 필드 -->
                                    <div class="input-group">
                                        <input type="text"
                                               id="{{ col.column_key }}"
                                               class="{{ section.section_key }}-input"
                                               data-field="{{ col.column_key }}"
                                               data-section="{{ section.section_key }}"
                                               data-input-type="popup_contractor"
                                               {% if col.table_group %}data-table-group="{{ col.table_group }}"{% endif %}
                                               {% if col.table_type %}data-table-type="{{ col.table_type }}"{% endif %}
                                               value="{{ col_value }}"
                                               readonly
                                               style="background-color: #f8f9fa;">
                                        <button class="btn btn-sm btn-primary"
                                                onclick="openContractorSearch('{{ col.column_key }}')">
                                            검색
                                        </button>
                                    </div>

                                {% elif render_type == 'popup_division' %}
                                    <!-- 사업부 검색 필드 -->
                                    <div class="input-group">
                                        <input type="text"
                                               id="{{ col.column_key }}"
                                               class="{{ section.section_key }}-input"
                                               data-field="{{ col.column_key }}"
                                               data-section="{{ section.section_key }}"
                                               data-input-type="popup_division"
                                               {% if col.table_group %}data-table-group="{{ col.table_group }}"{% endif %}
                                               {% if col.table_type %}data-table-type="{{ col.table_type }}"{% endif %}
                                               value="{{ col_value }}"
                                               readonly
                                               style="background-color: #f8f9fa;">
                                        <button class="btn btn-sm btn-primary"
                                                onclick="openDivisionSearch('{{ col.column_key }}')">
                                            검색
                                        </button>
                                    </div>

                                {% elif col.column_type == 'table' or col.input_type == 'table' %}
                                    <!-- 테이블 검색 필드 -->
                                    <div class="input-group">
                                        <input type="text"
                                               id="{{ col.column_key }}"
                                               class="{{ section.section_key }}-input"
                                               data-field="{{ col.column_key }}"
                                               data-section="{{ section.section_key }}"
                                               data-input-type="table"
                                               {% if col.table_group %}data-table-group="{{ col.table_group }}"{% endif %}
                                               {% if col.table_type %}data-table-type="{{ col.table_type }}"{% endif %}
                                               value="{{ col_value }}"
                                               readonly>
                                        <button class="btn btn-sm btn-primary"
                                                onclick="alert('팝업 타입이 구현되지 않았습니다.')">
                                            검색
                                        </button>
                                    </div>
                                    
                                {% elif col.column_type == 'textarea' %}
                                    <!-- 텍스트영역 필드 -->
                                    <textarea class="{{ section.section_key }}-input" 
                                            data-field="{{ col.column_key }}"
                                            data-section="{{ section.section_key }}"
                                            rows="4">{{ col_value }}</textarea>
                                            
                                {% elif col.column_type == 'scoring' %}
                                    {# scoring 필드 #}
                                    <label>{{ col.column_name }}</label>
                                    {% set sc = (col.scoring_config|from_json) if col.scoring_config else {} %}
                                    {% set items = sc['items'] if sc and ('items' in sc) else [] %}
                                    {% set values = (col_value|from_json) if col_value else {} %}
                                    {# 이전 컬럼이 score_total인지 확인 #}
                                    {% set prev_idx = loop.index0 - 1 %}
                                    {% set prev_col = chunk[prev_idx] if prev_idx >= 0 else None %}
                                    {% set has_prev_score_total = prev_col and prev_col.column_type == 'score_total' %}
                                    {# 다음 컬럼이 score_total인지 확인 #}
                                    {% set next_idx = loop.index0 + 1 %}
                                    {% set next_col = chunk[next_idx] if next_idx < chunk|length else None %}
                                    {% set has_score_total = next_col and next_col.column_type == 'score_total' %}

                                    <div class="scoring-group scoring-columns" data-field="{{ col.column_key }}" data-config='{{ col.scoring_config|default("{}")|tojson }}' data-group="{{ sc['total_key'] if sc and ('total_key' in sc) else 'default' }}">
                                        {# score_total이 이전에 있으면 첫 번째로 포함 #}
                                        {% if has_prev_score_total %}
                                            {% set sc_total = (prev_col.scoring_config|from_json) if prev_col.scoring_config else {} %}
                                            {% set base_score = sc_total.get('base_score') if sc_total and sc_total.get('base_score') else 100 %}
                                            {% set prev_col_value = custom_data.get(prev_col.column_key, '') if custom_data else '' %}
                                            {% set current_score = prev_col_value if (prev_col_value and prev_col_value != '') else base_score %}
                                            <div class="sc-col">
                                                <label class="form-label">{{ prev_col.column_name }}</label>
                                                <input type="number"
                                                       id="{{ prev_col.column_key }}_display"
                                                       class="total-score-display"
                                                       data-field="{{ prev_col.column_key }}"
                                                       data-config='{{ prev_col.scoring_config|default("{}")|tojson }}'
                                                       data-base-score="{{ base_score }}"
                                                       value="{{ current_score }}"
                                                       readonly
                                                       style="width: 100%; border: 1px solid #d1d5db; border-radius: 4px; padding: 6px 8px; font-weight: bold; text-align: center; background: #f8f9fa;">
                                                <input type="hidden"
                                                       id="{{ prev_col.column_key }}"
                                                       class="{{ section.section_key }}-input"
                                                       data-field="{{ prev_col.column_key }}"
                                                       data-section="{{ section.section_key }}"
                                                       value="{{ current_score }}">
                                            </div>
                                        {% endif %}
                                        {% for it in items %}
                                        <div class="sc-col">
                                            <label class="form-label">{{ it.name or it.label or '항목' }}</label>
                                            <input type="number" min="0" step="1"
                                                   class="scoring-input"
                                                   data-item="{{ it.id }}"
                                                   data-score="{{ it.per_unit_delta }}"
                                                   data-group="{{ sc['total_key'] if sc and ('total_key' in sc) else 'default' }}"
                                                   value="{{ values[it.id] if values and it.id in values and values[it.id] else '' }}">
                                            {% if sc.get('show_unit_hint', True) %}
                                            <small class="hint">{{ it.per_unit_delta }}점/건</small>
                                            {% endif %}
                                        </div>
                                        {% endfor %}

                                        {# score_total이 다음에 있으면 같은 그룹에 포함 #}
                                        {% if has_score_total %}
                                            {% set sc_total = (next_col.scoring_config|from_json) if next_col.scoring_config else {} %}
                                            {% set base_score = sc_total.get('base_score') if sc_total and sc_total.get('base_score') else 100 %}
                                            {% set next_col_value = custom_data.get(next_col.column_key, '') if custom_data else '' %}
                                            {% set current_score = next_col_value if (next_col_value and next_col_value != '') else base_score %}
                                            <div class="sc-col">
                                                <label class="form-label">{{ next_col.column_name }}</label>
                                                <input type="number"
                                                       id="{{ next_col.column_key }}_display"
                                                       class="total-score-display"
                                                       data-field="{{ next_col.column_key }}"
                                                       data-config='{{ next_col.scoring_config|default("{}")|tojson }}'
                                                       data-base-score="{{ base_score }}"
                                                       value="{{ current_score }}"
                                                       readonly
                                                       style="width: 100%; border: 1px solid #d1d5db; border-radius: 4px; padding: 6px 8px; font-weight: bold; text-align: center; background: #f8f9fa;">
                                                <input type="hidden"
                                                       id="{{ next_col.column_key }}"
                                                       class="{{ section.section_key }}-input"
                                                       data-field="{{ next_col.column_key }}"
                                                       data-section="{{ section.section_key }}"
                                                       value="{{ current_score }}">
                                            </div>
                                        {% endif %}

                                        <input type="hidden"
                                               class="{{ section.section_key|replace('_', '-') }}-input"
                                               data-field="{{ col.column_key }}"
                                               data-section="{{ section.section_key }}"
                                               value='{{ col_value|default("{}") }}'>
                                    </div>
                                    
                                {% elif col.column_type == 'score_total' %}
                                    {# 이전 컬럼이 scoring이거나 다음 컬럼이 scoring이면 건너뛰기 #}
                                    {% set prev_idx = loop.index0 - 1 %}
                                    {% set prev_col = chunk[prev_idx] if prev_idx >= 0 and prev_idx < chunk|length else None %}
                                    {% set next_idx = loop.index0 + 1 %}
                                    {% set next_col = chunk[next_idx] if next_idx < chunk|length else None %}
                                    <!-- DEBUG score_total: prev_col={{ prev_col.column_key if prev_col else 'None' }}, next_col={{ next_col.column_key if next_col else 'None' }} -->
                                    {% if not (prev_col and prev_col.column_type == 'scoring') and not (next_col and next_col.column_type == 'scoring') %}
                                        <!-- 총점 필드 (독립적으로 표시) - {{ col.column_key }}, col_value=[{{ col_value }}], base_score={{ base_score if base_score is defined else 'undefined' }} -->
                                        <label>{{ col.column_name }}</label>
                                        {% set sc = (col.scoring_config|from_json) if col.scoring_config else {} %}
                                        {% set base_score = sc.get('base_score') if sc and sc.get('base_score') else 100 %}
                                        {% set current_score = base_score %}
                                        <!-- FORCED: current_score=100 (always base_score) -->
                                        <div class="scoring-columns" style="grid-template-columns: repeat(1, minmax(0, 1fr));">
                                            <div class="sc-col">
                                                <label class="form-label">{{ col.column_name }}</label>
                                                <input type="number"
                                                       id="{{ col.column_key }}_display"
                                                       class="total-score-display"
                                                       data-field="{{ col.column_key }}"
                                                       data-config='{{ col.scoring_config|default("{}")|tojson }}'
                                                       data-base-score="{{ base_score }}"
                                                       value="{{ current_score }}"
                                                       readonly
                                                       style="width: 100%; border: 1px solid #d1d5db; border-radius: 4px; padding: 6px 8px; font-weight: bold; text-align: center; background: #f8f9fa;">
                                                <input type="hidden"
                                                       id="{{ col.column_key }}"
                                                       class="{{ section.section_key }}-input"
                                                       data-field="{{ col.column_key }}"
                                                       data-section="{{ section.section_key }}"
                                                       value="{{ current_score }}">
                                            </div>
                                        </div>
                                    {% endif %}
                                            
                                {% else %}
                                    <!-- 기본 텍스트 필드 -->
                                    <input type="text" 
                                           class="{{ section.section_key }}-input" 
                                           data-field="{{ col.column_key }}"
                                           data-section="{{ section.section_key }}"
                                           value="{{ col_value }}">
                                {% endif %}
                            </div>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}

    {{ render_detail_content(
        value=process.detailed_content if process.detailed_content else '',
        textarea_name='detailed_content',
        textarea_id='detailed-content'
    ) }}

    <!-- 4. 첨부파일 영역 (공통 컴포넌트) -->
{% from 'includes/attachment_section.html' import render_attachment_section %}
{{ render_attachment_section(attachments, 'full_process') }}

    {{ render_save_button('showEditPasswordModal()') }}

    {{ render_password_modal(
        modal_id='edit-password-modal',
        input_id='edit-password-input',
        confirm_onclick='verifyPasswordAndSave()',
        cancel_onclick='closeEditPasswordModal()'
    ) }}
</div>

<script>
const sections = {{ sections | tojson | safe }};
const sectionColumns = {{ section_columns | tojson | safe }};
const issueNumber = {{ process.fullprocess_number|default('')|tojson }};
const CAN_WRITE = {{ can_write|default(false)|tojson }};

const updateFullProcess = BoardDetail.createUpdater({

    endpoint: '/update-full-process',

    idField: 'fullprocess_number',

    idValue: issueNumber,

    sections: sections,

    sectionColumns: sectionColumns,

    attachmentsSelector: '#attachments-tbody .table-row',

    popupReload: {{ 'true' if is_popup else 'false' }},

    successMessage: 'Full Process가 성공적으로 수정되었습니다.',

    failurePrefix: '수정 실패',

    includeDeletedAttachments: true

});



window.updateFullProcess = updateFullProcess;

function showEditPasswordModal() {
    if (!CAN_WRITE) {
        alert('등록/수정 권한이 없습니다. 권한 신청 후 승인을 받아주세요.');
        return;
    }
    const modal = document.getElementById('edit-password-modal');
    const input = document.getElementById('edit-password-input');
    if (modal) {
        modal.style.display = 'block';
    }
    if (input) {
        input.value = '';
        input.focus();
    }
}

function closeEditPasswordModal() {
    const modal = document.getElementById('edit-password-modal');
    const input = document.getElementById('edit-password-input');
    if (modal) {
        modal.style.display = 'none';
    }
    if (input) {
        input.value = '';
    }
}

function verifyPasswordAndSave() {
    const input = document.getElementById('edit-password-input');
    const password = input ? input.value : '';

    if (!password) {
        alert('비밀번호를 입력해주세요.');
        if (input) {
            input.focus();
        }
        return;
    }

    BoardDetail.verifyPassword({ boardType: 'full_process', password })
        .then(() => {
            closeEditPasswordModal();
            updateFullProcess();
        })
        .catch((error) => {
            alert(error && error.message ? error.message : '비밀번호가 올바르지 않습니다.');
            if (input) {
                input.value = '';
                input.focus();
            }
        });
}

window.showEditPasswordModal = showEditPasswordModal;
window.closeEditPasswordModal = closeEditPasswordModal;
window.verifyPasswordAndSave = verifyPasswordAndSave;
</script>
<!-- 공통 첨부파일 스크립트와 스타일 import -->
{% from 'includes/attachment_section.html' import attachment_scripts, attachment_styles %}
{{ attachment_styles() }}
{{ attachment_scripts() }}


<!-- CKEditor 스크립트 -->
<script src="/static/js/ckeditor-simple.js"></script>

{% endblock %}
