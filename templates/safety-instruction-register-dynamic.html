{% if is_popup %}
{% extends "popup-base.html" %}
{% else %}
{% extends "base.html" %}
{% endif %}

{% block head %}
{% endblock %}

{% block title %}환경안전 지시서 등록{% endblock %}
{% block popup_title %}환경안전 지시서 등록{% endblock %}
{% block content %}

{% if not is_popup %}
<div class="page-header">
    <h2 class="page-title">환경안전 지시서 등록</h2>
    <div class="breadcrumb">
        <a href="{{ url_for('page_view', url='safety-instruction') }}">환경안전 지시서</a>
        <span class="separator">></span>
        <span class="current">신규 등록</span>
    </div>
</div>
{% endif %}

<div class="accident-detail-container">
    <!-- 동적 섹션 렌더링 -->
    {% for section in sections %}
    <div class="section {{ section.section_key }}-section">
        <div class="section-header">
            <h3 class="section-title">{{ section.section_name }}</h3>
            <button class="collapse-btn" onclick="toggleSection('{{ section.section_key }}')">
                <span class="collapse-icon">▲</span>
            </button>
        </div>
        <div class="section-content" id="{{ section.section_key }}-content">
            <div class="info-table">
                <div class="info-row">
                    {% set ns = namespace(col_count=0) %}
                    {% for col in section_columns[section.section_key] %}
                    
                    <!-- 새로운 행 시작 (4개 컬럼마다 또는 span 고려) -->
                    {% if ns.col_count >= 4 %}
                        </div><div class="info-row">
                        {% set ns.col_count = 0 %}
                    {% endif %}
                    
                    <!-- violation_content는 별도 처리 -->
                    {% if col.column_key == 'violation_content' %}
                        {% if ns.col_count > 0 %}
                            </div><div class="info-row">
                            {% set ns.col_count = 0 %}
                        {% endif %}
                        <div class="info-cell span-4">
                            <label>{{ col.column_name }}</label>
                            <textarea id="{{ col.column_key }}" 
                                    class="{{ section.section_key }}-input" 
                                    data-field="{{ col.column_key }}"
                                    data-section="{{ section.section_key }}"
                                    rows="4"
                                    placeholder="{{ col.column_name }} 입력"></textarea>
                        </div>
                        {% set ns.col_count = 4 %}
                    {% else %}
                        <!-- 일반 필드 처리 -->
                        {% set span = col.column_span|default(1) %}
                        <div class="info-cell {% if col.column_type == 'text' and span > 1 %}span-{{ span }}{% endif %}">
                            <label>{{ col.column_name }}</label>
                            
                            {% if col.column_key == 'issue_number' %}
                                <!-- 발부번호는 자동 생성 -->
                                <div class="value">자동 생성됩니다</div>
                            {% elif col.column_type == 'dropdown' %}
                                <!-- 드롭다운 필드 -->
                                <select id="{{ col.column_key }}" 
                                        class="{{ section.section_key }}-input" 
                                        data-field="{{ col.column_key }}"
                                        data-section="{{ section.section_key }}">
                                    <option value="">선택하세요</option>
                                    {% if col.column_key in basic_options %}
                                        {% for opt in basic_options[col.column_key] %}
                                        <option value="{{ opt.option_code }}">{{ opt.option_value }}</option>
                                        {% endfor %}
                                    {% elif col.dropdown_options_mapped %}
                                        {% for opt in col.dropdown_options_mapped %}
                                        <option value="{{ opt.option_code }}">{{ opt.option_value }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            {% elif col.column_type == 'date' %}
                                <!-- 날짜 필드 -->
                                <input type="date" 
                                       id="{{ col.column_key }}" 
                                       class="{{ section.section_key }}-input" 
                                       data-field="{{ col.column_key }}"
                                       data-section="{{ section.section_key }}">
                            {% elif col.column_type == 'number' %}
                                <!-- 숫자 필드 -->
                                <input type="number" 
                                       id="{{ col.column_key }}" 
                                       class="{{ section.section_key }}-input" 
                                       data-field="{{ col.column_key }}"
                                       data-section="{{ section.section_key }}"
                                       placeholder="{{ col.column_name }} 입력">
                            {% elif col.column_type == 'linked' %}
                                <!-- 연결된 필드 (읽기 전용) -->
                                <input type="text" 
                                       id="{{ col.column_key }}" 
                                       class="{{ section.section_key }}-input" 
                                       data-field="{{ col.column_key }}"
                                       data-section="{{ section.section_key }}"
                                       readonly
                                       style="background-color: #f3f4f6;">
                            {% elif col.column_type == 'popup' %}
                                <!-- 팝업 필드 -->
                                <div class="input-group">
                                    <input type="text" 
                                           id="{{ col.column_key }}" 
                                           class="{{ section.section_key }}-input" 
                                           data-field="{{ col.column_key }}"
                                           data-section="{{ section.section_key }}"
                                           placeholder="클릭하여 선택"
                                           readonly>
                                    <button class="btn btn-sm btn-outline-secondary" 
                                            onclick="openPopup('{{ col.column_key }}')">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            {% else %}
                                <!-- 기본 텍스트 필드 -->
                                <input type="text" 
                                       id="{{ col.column_key }}" 
                                       class="{{ section.section_key }}-input" 
                                       data-field="{{ col.column_key }}"
                                       data-section="{{ section.section_key }}"
                                       placeholder="{{ col.column_name }} 입력">
                            {% endif %}
                        </div>
                        {% set ns.col_count = ns.col_count + span %}
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- 첨부파일 영역 -->
    <div class="section attachments-section">
        <div class="section-header">
            <h3 class="section-title">첨부파일</h3>
            <button class="btn-add-file" onclick="document.getElementById('file-input').click();">추가</button>
            <span class="file-count">총 <span id="file-count">0</span>개</span>
            <span class="file-size"><span id="file-size">0</span> MB / 50 MB</span>
        </div>
        <div class="section-content">
            <input type="file" id="file-input" multiple style="display: none;" onchange="handleFileUpload(this.files)">
            <div class="attachments-table">
                <div class="table-header">
                    <div class="col-no">No.</div>
                    <div class="col-file">파일명</div>
                    <div class="col-desc">설명</div>
                    <div class="col-action">상태</div>
                </div>
                <div class="table-body" id="attachments-tbody">
                    <div class="table-row no-data" id="no-data-row">
                        <div class="col-full">등록된 첨부파일이 없습니다.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 저장 버튼 영역 -->
    <div class="save-section">
        <button class="btn-save" onclick="registerSafetyInstruction()">등록완료</button>
    </div>
</div>

<!-- 스타일 -->
<link rel="stylesheet" href="/static/styles/accident-register.css">

<script>
// 섹션 정보
const sections = {{ sections | tojson | safe }};
const sectionColumns = {{ section_columns | tojson | safe }};

// 섹션 토글
function toggleSection(sectionId) {
    const content = document.getElementById(sectionId + '-content');
    const icon = event.target;
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '▲';
    } else {
        content.style.display = 'none';
        icon.textContent = '▼';
    }
}

// 첨부파일 관련 변수
let uploadedFiles = [];
let totalFileSize = 0;
const maxFileSize = 50 * 1024 * 1024; // 50MB

// 첨부파일 업로드 처리
function handleFileUpload(files) {
    for (let file of files) {
        if (totalFileSize + file.size > maxFileSize) {
            alert('총 파일 크기가 50MB를 초과할 수 없습니다.');
            break;
        }
        
        uploadedFiles.push(file);
        totalFileSize += file.size;
        
        const tbody = document.getElementById('attachments-tbody');
        const noDataRow = document.getElementById('no-data-row');
        
        if (noDataRow) {
            noDataRow.remove();
        }
        
        const row = document.createElement('div');
        row.className = 'table-row';
        row.innerHTML = `
            <div class="col-no">${uploadedFiles.length}</div>
            <div class="col-file">${file.name}</div>
            <div class="col-desc">
                <input type="text" class="file-desc-input" placeholder="파일 설명 입력">
            </div>
            <div class="col-action">
                <button class="btn-delete" onclick="removeFile(${uploadedFiles.length - 1})">삭제</button>
            </div>
        `;
        tbody.appendChild(row);
    }
    
    updateFileInfo();
}

// 파일 제거
function removeFile(index) {
    totalFileSize -= uploadedFiles[index].size;
    uploadedFiles.splice(index, 1);
    
    // 테이블 다시 그리기
    const tbody = document.getElementById('attachments-tbody');
    tbody.innerHTML = '';
    
    if (uploadedFiles.length === 0) {
        tbody.innerHTML = `
            <div class="table-row no-data" id="no-data-row">
                <div class="col-full">등록된 첨부파일이 없습니다.</div>
            </div>
        `;
    } else {
        uploadedFiles.forEach((file, idx) => {
            const row = document.createElement('div');
            row.className = 'table-row';
            row.innerHTML = `
                <div class="col-no">${idx + 1}</div>
                <div class="col-file">${file.name}</div>
                <div class="col-desc">
                    <input type="text" class="file-desc-input" placeholder="파일 설명 입력">
                </div>
                <div class="col-action">
                    <button class="btn-delete" onclick="removeFile(${idx})">삭제</button>
                </div>
            `;
            tbody.appendChild(row);
        });
    }
    
    updateFileInfo();
}

// 파일 정보 업데이트
function updateFileInfo() {
    document.getElementById('file-count').textContent = uploadedFiles.length;
    document.getElementById('file-size').textContent = (totalFileSize / (1024 * 1024)).toFixed(2);
}

// 동적 필드 수집 함수
function collectDynamicFields() {
    const data = {};
    
    // 모든 섹션 순회
    sections.forEach(section => {
        const sectionInputs = document.querySelectorAll(`[data-section="${section.section_key}"]`);
        
        sectionInputs.forEach(input => {
            const fieldKey = input.dataset.field;
            let value = '';
            
            if (input.tagName === 'SELECT') {
                value = input.value;
            } else if (input.type === 'checkbox') {
                value = input.checked ? '1' : '0';
            } else if (input.tagName === 'TEXTAREA') {
                value = input.value;
            } else {
                value = input.value;
            }
            
            data[fieldKey] = value;
        });
    });
    
    return data;
}

// 등록 함수
function registerSafetyInstruction() {
    const formData = new FormData();
    
    // 동적 필드 수집
    const dynamicData = collectDynamicFields();
    
    // 각 필드를 FormData에 추가
    for (const [key, value] of Object.entries(dynamicData)) {
        formData.append(key, value);
    }
    
    // custom_data 처리 (additional 섹션 데이터 등)
    const customData = {};
    const additionalColumns = sectionColumns['additional'] || [];
    additionalColumns.forEach(col => {
        if (dynamicData[col.column_key]) {
            customData[col.column_key] = dynamicData[col.column_key];
        }
    });
    formData.append('custom_data', JSON.stringify(customData));
    
    // 첨부파일 처리
    const attachmentData = [];
    document.querySelectorAll('#attachments-tbody .table-row:not(.no-data)').forEach((row, index) => {
        const descInput = row.querySelector('.file-desc-input');
        attachmentData.push({
            description: descInput ? descInput.value : ''
        });
    });
    
    uploadedFiles.forEach((file, index) => {
        formData.append('files', file);
        if (attachmentData[index]) {
            formData.append(`file_desc_${index}`, attachmentData[index].description);
        }
    });
    
    // 서버로 전송
    fetch('/register-safety-instruction', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('환경안전 지시서가 성공적으로 등록되었습니다.');
            if (window.opener) {
                window.opener.location.reload();
                window.close();
            } else {
                window.location.href = '/safety-instruction';
            }
        } else {
            alert('등록 실패: ' + (data.message || '알 수 없는 오류'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('등록 중 오류가 발생했습니다.');
    });
}

// 팝업 열기 함수
function openPopup(fieldKey) {
    // 팝업 구현 (필요시 추가)
    alert('팝업 기능은 추가 구현이 필요합니다.');
}
</script>

<style>
/* 추가 스타일 */
.info-cell textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 14px;
    resize: vertical;
}

.info-cell.span-2 {
    grid-column: span 2;
}

.info-cell.span-3 {
    grid-column: span 3;
}

.info-cell.span-4 {
    grid-column: span 4;
}

.info-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 16px;
}

.input-group {
    display: flex;
    gap: 4px;
}

.input-group input {
    flex: 1;
}

.input-group button {
    padding: 4px 8px;
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    cursor: pointer;
}

.input-group button:hover {
    background: #e5e7eb;
}
</style>

{% endblock %}