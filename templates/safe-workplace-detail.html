{% if is_popup %}
{% extends "popup-base.html" %}
{% else %}
{% extends "base.html" %}
{% endif %}

{% from 'includes/board_form/detail_content.html' import render_detail_content %}
{% from 'includes/board_form/save_controls.html' import render_save_button, render_password_modal %}

{% block head %}
    {{ super() }}
    {% include 'includes/board_form_scripts.html' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/scoring-system.css') }}">
    <script src="{{ url_for('static', filename='js/scoring-system.js') }}"></script>
{% endblock %}

{% block title %}안전한 일터 상세정보{% endblock %}
{% block popup_title %}{{ workplace.safeplace_no }} - 안전한 일터 상세정보{% endblock %}
{% block content %}

{% if not is_popup %}
<div class="page-header">
    <h2 class="page-title">안전한 일터 상세정보</h2>
    <div class="breadcrumb">
        <a href="{{ url_for('page_view', url='safe-workplace') }}">안전한 일터</a>
        <span class="separator">></span>
        <span class="current">{{ workplace.safeplace_no }}</span>
    </div>
</div>
{% endif %}



<div class="safe-workplace-detail-container">
    {% for section in sections %}
    <div class="section {{ section.section_key|replace('_', '-') }}-section">
        <div class="section-header">
            <h3 class="section-title">{{ section.section_name }}</h3>
            <button class="collapse-btn" onclick="BoardDetail.toggleSection('{{ section.section_key|replace('_', '-') }}', this)">
                <span class="collapse-icon">▲</span>
            </button>
        </div>
        <div class="section-content" id="{{ section.section_key|replace('_', '-') }}-content">
            <div class="info-table">
                {% set columns = section_columns.get(section.section_key, []) %}
                {% set columns_per_row = 8 %}
                {% for chunk in columns | batch(columns_per_row, '') %}
                <div class="info-row">
                    {% for col in chunk %}
                        {% if col %}
                            {% if col.column_type == 'list' %}
                                {% set span = 8 %}
                            {% elif col.column_type == 'scoring' %}
                                {% set span = 8 %}
                            {% elif col.column_type == 'score_total' %}
                                {% set span = 4 %}
                            {% elif col.column_type == 'dropdown' %}
                                {% if col.input_type == 'dropdown_multi' %}
                                    {% set span = 8 %}
                                {% elif col.column_span and col.column_span|int > 0 %}
                                    {% set cs = col.column_span|int %}
                                    {% set span = cs if cs >= 2 else 2 %}
                                {% else %}
                                    {% set span = 2 %}
                                {% endif %}
                            {% elif col.column_span and col.column_span|int > 0 %}
                                {% set cs = col.column_span|int %}
                                {% set span = cs if cs >= 2 else 2 %}
                            {% else %}
                                {% set span = 2 %}
                            {% endif %}
                            <div class="info-cell span-{{ span }}">
                                <label>{{ col.column_name }}</label>
                                {% set value = workplace[col.column_key] | default('', true) %}
                                {% if col.column_key == 'safeplace_no' %}
                                    <input type="text" value="{{ workplace.safeplace_no or '-' }}" readonly class="readonly-highlight">
                                    <input type="hidden" name="safeplace_no" value="{{ workplace.safeplace_no }}">
                                {% elif col.column_key == 'created_at' %}
                                    <input type="text" value="{{ (workplace.created_at|date_only) if workplace.created_at else '-' }}" readonly class="readonly-highlight">
                                {% elif col.column_key == 'updated_by' %}
                                    <input type="text"
                                           value="{{ (workplace.updated_by or workplace.created_by) | default('-', true) }}"
                                           readonly
                                           class="readonly-highlight">
                                {% elif col.column_key == 'updated_at' %}
                                    {% set updated_stamp = workplace.updated_at or workplace.created_at %}
                                    <input type="text"
                                           value="{{ (updated_stamp|date_only) if updated_stamp else '-' }}"
                                           readonly
                                           class="readonly-highlight">
                                {% elif col.column_type == 'dropdown' %}
                                    {% set is_multi = col.input_type == 'dropdown_multi' %}
                                    {% if is_multi %}
                                        {% set options = [] %}
                                        {% if col.column_key in basic_options %}
                                            {% set options = basic_options[col.column_key] %}
                                        {% elif col.dropdown_options_mapped %}
                                            {% set options = col.dropdown_options_mapped %}
                                        {% endif %}
                                        {% set raw_values = [] %}
                                        {% if value is sequence and not (value is string) %}
                                            {% set raw_values = value | map('string') | list %}
                                        {% elif value %}
                                            {% set raw_values = [value|string] %}
                                        {% endif %}
                                        {% set selected_codes = [] %}
                                        {% set selected_labels = [] %}
                                        {% for rv in raw_values %}
                                            {% for opt in options %}
                                                {% if opt.code == rv or opt.value == rv %}
                                                    {% if opt.code not in selected_codes %}
                                                        {% set selected_codes = selected_codes + [opt.code] %}
                                                        {% set selected_labels = selected_labels + [opt.value] %}
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                        {% endfor %}
                                        {% set display_values = selected_labels if selected_labels else raw_values %}
                                        <div class="dropdown-multi-summary text-muted mb-1" data-summary-for="{{ col.column_key }}">{{ display_values|join(', ') if display_values else '-' }}</div>
                                        <div class="dropdown-multi-checkboxes" data-checkbox-for="{{ col.column_key }}" data-section="{{ section.section_key }}">
                                            {% for opt in options %}
                                            <label class="dropdown-multi-option form-check">
                                                <input type="checkbox"
                                                       class="form-check-input me-2 dropdown-multi-checkbox"
                                                       value="{{ opt.code }}"
                                                       data-multi-key="{{ col.column_key }}"
                                                       data-section="{{ section.section_key }}"
                                                       {% if opt.code in selected_codes %}checked{% endif %}>
                                                <span class="form-check-label flex-grow-1">{{ opt.value }}</span>
                                            </label>
                                            {% endfor %}
                                        </div>
                                        <input type="hidden"
                                               class="dropdown-multi-hidden-value"
                                               data-field="{{ col.column_key }}"
                                               data-section="{{ section.section_key }}"
                                               data-field-type="dropdown_multi_hidden"
                                               value="{{ selected_codes|tojson if selected_codes else '' }}">
                                    {% else %}
                                        {% set single_value = value|string if value is not none else '' %}
                                        <select class="{{ section.section_key|replace('_', '-') }}-input"
                                                id="{{ col.column_key }}"
                                                data-field="{{ col.column_key }}"
                                                data-section="{{ section.section_key }}">
                                            <option value="">선택하세요</option>
                                            {% if col.column_key in basic_options %}
                                                {% for opt in basic_options[col.column_key] %}
                                                <option value="{{ opt.code }}" {% if opt.code == single_value %}selected{% endif %}>{{ opt.value }}</option>
                                                {% endfor %}
                                            {% elif col.dropdown_options_mapped %}
                                                {% for opt in col.dropdown_options_mapped %}
                                                <option value="{{ opt.code }}" {% if opt.code == single_value %}selected{% endif %}>{{ opt.value }}</option>
                                                {% endfor %}
                                            {% endif %}
                                        </select>
                                    {% endif %}
                                {% elif col.column_type == 'date' %}
                                    <input type="date"
                                           class="{{ section.section_key|replace('_', '-') }}-input"
                                           data-field="{{ col.column_key }}"
                                           data-section="{{ section.section_key }}"
                                           value="{{ value }}">
                                {% elif col.column_type == 'number' %}
                                    {% set _nt = 'integer' if col.input_type == 'number_integer' else 'float' %}
                                    <input type="number"
                                           class="{{ section.section_key|replace('_', '-') }}-input"
                                           data-field="{{ col.column_key }}"
                                           data-section="{{ section.section_key }}"
                                           data-number-type="{{ _nt }}"
                                           step="{% if _nt == 'integer' %}1{% else %}any{% endif %}"
                                           oninput="validateNumberInput(this)"
                                           onkeypress="return isNumberKey(event, this)"
                                           value="{{ value }}">
                                {% elif col.column_type == 'textarea' %}
                                    <textarea class="{{ section.section_key|replace('_', '-') }}-input"
                                              data-field="{{ col.column_key }}"
                                              data-section="{{ section.section_key }}"
                                              rows="4">{{ value }}</textarea>
                                {% elif col.column_type == 'scoring' %}
                                    {% set sc = (col.scoring_config|from_json) if col.scoring_config else {} %}
                                    {% set items = sc['items'] if sc and ('items' in sc) else [] %}
                                    {% set values = (value|from_json) if value else {} %}
                                    <div class="scoring-group scoring-columns" data-field="{{ col.column_key }}" data-config='{{ col.scoring_config|default("{}")|tojson }}'>
                                        {% for it in items %}
                                        <div class="sc-col">
                                            <label class="form-label">{{ it.name or it.label or '항목' }}</label>
                                            <input type="number" min="0" step="1"
                                                   class="scoring-input"
                                                   data-item="{{ it.id }}"
                                                   data-score="{{ it.per_unit_delta }}" data-delta="{{ it.per_unit_delta }}"
                                                   value="{{ values[it.id] if values and it.id in values else 0 }}">
                                        </div>
                                        {% endfor %}
                                        <input type="hidden"
                                               class="{{ section.section_key|replace('_', '-') }}-input"
                                               data-field="{{ col.column_key }}"
                                               data-section="{{ section.section_key }}"
                                               value='{{ value|default("{}") }}'>
                                    </div>
                                {% elif col.column_type == 'score_total' %}
                                    {% set sc = (col.scoring_config|from_json) if col.scoring_config else {} %}
                                    {% set base_score = sc.get('base_score') if sc and sc.get('base_score') else 100 %}
                                    <div class="scoring-columns">
                                        <div class="sc-col score-total-field" data-field="{{ col.column_key }}" data-config='{{ col.scoring_config|default("{}")|tojson }}' data-base-score="{{ base_score }}">
                                            <label class="form-label">총점</label>
                                            <input type="number" class="total-score-display" value="{{ value if value != '' else base_score }}" readonly style="background: #f0f0f0; font-weight: bold;">
                                            <input type="hidden"
                                                   class="{{ section.section_key|replace('_', '-') }}-input"
                                                   data-field="{{ col.column_key }}"
                                                   data-section="{{ section.section_key }}"
                                                   value="{{ value }}">
                                        </div>
                                    </div>
                                {% elif col.column_type == 'list' %}
                                    {% from 'includes/list_field_v3.html' import render_list_field %}
                                    {{ render_list_field(col, value, section, mode='edit') }}
                                {% elif col.column_type == 'linked_text' %}
                                    <input type="text"
                                           id="{{ col.column_key }}"
                                           class="{{ section.section_key|replace('_', '-') }}-input linked-field"
                                           data-field="{{ col.column_key }}"
                                           data-section="{{ section.section_key }}"
                                           {% if col.table_type or col.table_group %}data-table-group="{{ col.table_type or col.table_group }}"{% endif %}
                                           {% if col.table_type %}data-table-type="{{ col.table_type }}"{% endif %}
                                           value="{{ value }}"
                                           readonly>
                                {% elif col.column_type == 'popup_company' and col.column_key.endswith('_company') %}
                                    <input type="text"
                                           id="{{ col.column_key }}"
                                           class="{{ section.section_key|replace('_', '-') }}-input linked-field"
                                           data-field="{{ col.column_key }}"
                                           data-section="{{ section.section_key }}"
                                           {% if col.table_type or col.table_group %}data-table-group="{{ col.table_type or col.table_group }}"{% endif %}
                                           {% if col.table_type %}data-table-type="{{ col.table_type }}"{% endif %}
                                           value="{{ value }}"
                                           readonly
                                           style="background-color: #f8f9fa;">
                                {% elif col.column_type and col.column_type.startswith('popup') %}
                                    <div class="input-group">
                                        <input type="text"
                                               id="{{ col.column_key }}"
                                               class="{{ section.section_key|replace('_', '-') }}-input"
                                               data-field="{{ col.column_key }}"
                                               data-section="{{ section.section_key }}"
                                               {% if col.table_type or col.table_group %}data-table-group="{{ col.table_type or col.table_group }}"{% endif %}
                                               {% if col.table_type %}data-table-type="{{ col.table_type }}"{% endif %}
                                               value="{{ value }}"
                                               placeholder="클릭하여 선택"
                                               readonly>
                                        <button class="btn btn-sm btn-primary"
                                                onclick="{% if col.column_type == 'popup_person' %}openPersonSearch('{{ col.column_key }}'){% elif col.column_type == 'popup_company' %}openCompanySearch('{{ col.column_key }}'){% elif col.column_type == 'popup_building' %}openBuildingSearch('{{ col.column_key }}'){% elif col.column_type == 'popup_department' %}openDepartmentSearch('{{ col.column_key }}'){% elif col.column_type == 'popup_contractor' %}openContractorSearch('{{ col.column_key }}'){% elif col.column_type == 'popup_division' %}openDivisionSearch('{{ col.column_key }}'){% else %}console.error('Unknown popup type: {{ col.column_type }}'){% endif %}">검색</button>
                                    </div>
                                {% elif col.column_type == 'table' or col.input_type == 'table' %}
                                    <div class="input-group">
                                        <input type="text"
                                               id="{{ col.column_key }}"
                                               class="{{ section.section_key|replace('_', '-') }}-input"
                                               data-field="{{ col.column_key }}"
                                               data-section="{{ section.section_key }}"
                                               {% if col.table_type or col.table_group %}data-table-group="{{ col.table_type or col.table_group }}"{% endif %}
                                               {% if col.table_type %}data-table-type="{{ col.table_type }}"{% endif %}
                                               value="{{ value }}"
                                               placeholder="검색하여 선택"
                                               readonly
                                               style="background-color: #f8f9fa;">
                                        <input type="hidden"
                                               id="{{ col.column_key }}_id"
                                               data-field="{{ col.column_key }}_id"
                                               value="{{ workplace.get(col.column_key ~ '_id') if workplace else '' }}">
                                        <button class="btn btn-sm btn-primary"
                                                onclick="openTableSearch('{{ col.column_key }}')">검색</button>
                                    </div>
                                {% else %}
                                    <input type="text"
                                           class="{{ section.section_key|replace('_', '-') }}-input"
                                           data-field="{{ col.column_key }}"
                                           data-section="{{ section.section_key }}"
                                           value="{{ value }}">
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}

    {{ render_detail_content(
        value=workplace.detailed_content|default(''),
        textarea_name='detailed_content',
        textarea_id='detailed-content',
        use_data_content=True,
        data_content=workplace.detailed_content|default('')
    ) }}

    {% from 'includes/attachment_section.html' import render_attachment_section, attachment_scripts, attachment_styles %}
    {{ render_attachment_section(attachments, 'safe_workplace') }}

    {{ render_save_button('showEditPasswordModal()') }}

    {{ render_password_modal(
        modal_id='edit-password-modal',
        input_id='edit-password-input',
        confirm_onclick='verifyPasswordAndSave()',
        cancel_onclick='closeEditPasswordModal()'
    ) }}
</div>

{{ attachment_styles() }}

<script>
const sections = {{ sections | tojson | safe }};
const sectionColumns = {{ section_columns | tojson | safe }};
const safeplaceNo = {{ workplace.safeplace_no|default('')|tojson }};
const CAN_WRITE = {{ can_write|default(false)|tojson }};

const submitSafeWorkplaceUpdate = BoardDetail.createUpdater({
    endpoint: '/update-safe-workplace',
    idField: 'safeplace_no',
    idValue: safeplaceNo,
    sections: sections,
    sectionColumns: sectionColumns,
    attachmentsSelector: '#attachments-tbody .table-row',
    popupReload: {{ 'true' if is_popup else 'false' }},
    successMessage: '안전한 일터가 성공적으로 수정되었습니다.',
    failurePrefix: '수정 실패',
    includeDeletedAttachments: true
});

window.submitSafeWorkplaceUpdate = submitSafeWorkplaceUpdate;

function showEditPasswordModal() {
    if (!CAN_WRITE) {
        alert('등록/수정 권한이 없습니다. 권한 신청 후 승인을 받아주세요.');
        return;
    }
    const modal = document.getElementById('edit-password-modal');
    const input = document.getElementById('edit-password-input');

    if (modal) {
        modal.style.display = 'block';
    }
    if (input) {
        input.value = '';
        input.focus();
    }
}

function closeEditPasswordModal() {
    const modal = document.getElementById('edit-password-modal');
    const input = document.getElementById('edit-password-input');

    if (modal) {
        modal.style.display = 'none';
    }
    if (input) {
        input.value = '';
    }
}

function verifyPasswordAndSave() {
    const input = document.getElementById('edit-password-input');
    const password = input ? input.value : '';

    if (!password) {
        alert('비밀번호를 입력해주세요.');
        if (input) {
            input.focus();
        }
        return;
    }

    BoardDetail.verifyPassword({ boardType: 'safe_workplace', password })
        .then(() => {
            closeEditPasswordModal();
            submitSafeWorkplaceUpdate();
        })
        .catch((error) => {
            alert(error && error.message ? error.message : '비밀번호가 올바르지 않습니다.');
            if (input) {
                input.value = '';
                input.focus();
            }
        });
}

window.showEditPasswordModal = showEditPasswordModal;
window.closeEditPasswordModal = closeEditPasswordModal;
window.verifyPasswordAndSave = verifyPasswordAndSave;
</script>

{{ attachment_scripts() }}
{% endblock %}
