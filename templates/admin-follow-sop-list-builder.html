{% extends "popup-base.html" %}
{% block title %}{{ board_label }} 리스트 자식 컬럼 관리{% endblock %}
{% block content %}
<style>
.builder-content {
    padding: 32px;
    background: transparent;
}

.admin-container {
    max-width: 1080px;
    margin: 0 auto;
    padding: 0;
    background: #ffffff;
    border-radius: 14px;
    box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
    border: 1px solid rgba(99, 102, 241, 0.12);
    overflow: hidden;
}

.admin-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px 0;
    margin: -20px -20px 30px -20px;
    border-radius: 8px;
}

.admin-header h1 {
    margin: 0;
    font-size: 28px;
    font-weight: 600;
}

.admin-header p {
    margin: 5px 0 0 0;
    opacity: 0.9;
}

.badge-soft {
    background: rgba(255, 255, 255, 0.18);
    color: #fff;
    font-weight: 500;
    border-radius: 999px;
    padding: 6px 14px;
    font-size: 13px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.columns-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
}

.column-card-small {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 12px;
    border: 2px solid transparent;
    cursor: move;
    position: relative;
    user-select: none;
    grid-column: span 1;
}

.column-card-small:hover {
    border-color: #2f5fd3;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.column-card-small.dragging {
    opacity: 0.5;
}

.column-card-small.drag-over {
    border-color: #4338ca;
    background: #eef2ff;
}

.column-card-small .column-number {
    position: absolute;
    top: 5px;
    left: 5px;
    width: 24px;
    height: 24px;
    background: #6c757d;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: bold;
}

.column-card-small .column-content {
    margin-left: 30px;
}

.column-card-small .column-name {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
}

.column-card-small .column-key {
    font-size: 11px;
    color: #6c757d;
    font-family: monospace;
}

.column-card-small .column-controls {
    display: flex;
    gap: 5px;
    margin-top: 8px;
    justify-content: space-between;
    align-items: center;
}

.column-card-small .column-type-badge {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 10px;
    background: #e9ecef;
    color: #495057;
}

.empty-placeholder {
    grid-column: 1 / -1;
    border: 2px dashed #cbd5ff;
    border-radius: 10px;
    padding: 32px;
    text-align: center;
    color: #64748b;
}

.modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.advanced-panel {
    border-top: 1px solid #e2e8f0;
    margin-top: 20px;
    padding-top: 16px;
}

.info-banner {
    background: rgba(99, 102, 241, 0.08);
    border: 1px solid rgba(99, 102, 241, 0.18);
    border-radius: 12px;
    padding: 12px 16px;
    font-weight: 500;
    color: #4338ca;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.info-banner::before {
    content: '4a6';
    font-family: 'bootstrap-icons';
    font-size: 1rem;
    color: #4338ca;
}

.info-banner .banner-label {
    font-weight: 700;
    color: #312e81;
    letter-spacing: -0.2px;
}

.info-banner .banner-value {
    color: #4338ca;
    font-weight: 500;
}

.header-card {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(37, 99, 235, 0.1));
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: 14px;
    padding: 14px 16px;
}

.header-card h5 {
    color: #1e3a8a;
    font-weight: 700;
    letter-spacing: -0.3px;
}

.badge.bg-soft-indigo {
    background: rgba(99, 102, 241, 0.15);
    color: #3730a3;
    padding: 6px 14px;
    font-weight: 600;
    font-size: 0.875rem;
}

.btn-indigo {
    background: linear-gradient(135deg, #6366f1, #4f46e5);
    border: none;
    color: #fff;
    font-weight: 600;
    padding: 0.75rem 1.25rem;
    border-radius: 12px;
    box-shadow: 0 12px 24px rgba(79, 70, 229, 0.25);
    transition: all 0.2s ease-in-out;
}

.btn-indigo:hover {
    background: linear-gradient(135deg, #4f46e5, #4338ca);
    box-shadow: 0 16px 32px rgba(79, 70, 229, 0.35);
}

.btn-indigo:focus,
.btn-indigo:active,
.btn-indigo:focus-visible {
    color: #fff;
    background: linear-gradient(135deg, #4f46e5, #4338ca);
    box-shadow: 0 16px 32px rgba(79, 70, 229, 0.35);
    outline: none;
}

.text-indigo {
    color: #4338ca !important;
}

</style>

<script>
(function hideParentHeaders() {
  function run() {
    const popupRoot = document.querySelector('.popup-content');
    const isInsidePopup = (el) => popupRoot && popupRoot.contains(el);
    const headerSelectors = [
      '.page-header',
      '.detail-header',
      '.app-header',
      '.drawer-header',
      '.offcanvas-header',
      '.slide-over-header',
      '.sheet-header',
      '.modal-header.top',
      '.top-header',
      '.popup-header'
    ];
    headerSelectors.forEach((selector) => {
      document.querySelectorAll(selector).forEach((el) => {
        if (!isInsidePopup(el)) {
          el.style.display = 'none';
        }
      });
    });
    document.querySelectorAll('.popup-header').forEach((el) => {
      if (!isInsidePopup(el)) {
        el.style.display = 'none';
      }
    });
    if (document.body) {
      document.body.style.marginTop = '0';
      document.body.style.paddingTop = '0';
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', run);
  } else {
    run();
  }
})();
</script>


<div class="builder-content">
    <div class="admin-container">
        <div class="container p-4">
            <div class="info-banner mb-3">
                <span class="banner-label">대상 컬럼</span>
                <span class="banner-value">{{ column.column_name }} <span class="text-body-secondary">({{ column.column_key }})</span></span>
            </div>
            <div class="header-card d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">{{ board_label }} 자식 컬럼 목록</h5>
                <span class="badge rounded-pill bg-soft-indigo text-indigo" id="summaryInfo">총 0개</span>
            </div>

            <div class="columns-grid" id="childColumnGrid"></div>

            <button type="button" class="btn btn-indigo w-100 mb-3" id="addChildFieldBtn">
                <i class="bi bi-plus-circle me-2"></i> 새 컬럼 추가
            </button>

            <div class="d-flex align-items-center gap-3 justify-content-end">
                <span class="text-muted me-auto">마지막 저장 시각: <span id="lastSavedAt">-</span></span>
                <button type="button" class="btn btn-secondary" id="closePopupBtn">
                    <i class="bi bi-arrow-left-circle"></i> 창 닫기
                </button>
                <button class="btn btn-success" id="saveSchemaBtn">
                    <i class="bi bi-check-lg"></i> 변경사항 저장
                </button>
            </div>
            <div class="text-end mt-2" style="font-size: 0.9rem; font-weight:600; color:#1e293b;">
                변경사항 저장 시 즉시 반영되며, 컬럼 관리 창에서 추가 저장이 필요 없습니다.
            </div>
        </div>
    </div>
</div>

<!-- 자식 컬럼 추가/수정 모달 -->
<div class="modal fade" id="childFieldModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog" style="margin-top: 100px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="childFieldModalTitle">자식 컬럼 추가</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% with form_options = {
                    'show_section': False,
                    'show_span': False,
                    'show_table': True,
                    'show_list_button': False,
                    'show_number': True,
                    'show_scoring': True,
                    'show_active': False
                } %}
                    {% include "admin/partials/column_field_form.html" %}
                {% endwith %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger me-auto" id="childFieldDeleteBtn" style="display:none;">
                    <i class="bi bi-trash3"></i> 항목 삭제
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="childFieldSaveBtn">입력 완료</button>
            </div>
        </div>
</div>
</div>

<!-- 테이블 설정 모달 -->
<div class="modal fade" id="tableConfigModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-table"></i> 테이블 설정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-4">
                    <div class="col-md-4">
                        <h6 class="mb-3 text-secondary">테이블 선택</h6>
                        <div class="list-group" id="tableList"></div>
                    </div>
                    <div class="col-md-8">
                        <h6 class="mb-3 text-secondary">미리보기</h6>
                        <div id="tablePreview" class="border rounded p-3 bg-light" style="min-height:260px;">
                            <div class="text-center text-muted" style="padding:40px 0;">
                                <i class="bi bi-info-circle" style="font-size:42px;"></i>
                                <p class="mt-3 mb-0">왼쪽 목록에서 테이블을 선택해주세요.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="confirmTableBtn" disabled>선택 완료</button>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/Sortable.min.js"></script>
<script src="/static/js/column-field-editor.js"></script>
<script>
(function () {
    const COLUMN = {{ column | tojson | safe }};
    const API_ENDPOINT = {{ api_endpoint | tojson | safe }};

    const _originalAlert = window.alert;
    window.alert = function(message, ...rest) {
        if (typeof message === 'string' && message.includes('팝업이 차단되었습니다')) {
            console.warn('[popup-blocked]', message);
            return;
        }
        return _originalAlert.call(this, message, ...rest);
    };

    const typeLabels = {
        text: '텍스트',
        dropdown: '드롭다운',
        date: '날짜',
        time: '시간',
        number: '숫자',
        table: '테이블',
        list: '리스트',
        popup: '검색 팝업',
        checkbox: '체크박스',
        scoring: '채점',
        score_total: '총점(자동)'
    };

    let listChildFields = [];
    const detectedPreset = detectPreset(COLUMN);
    let currentPreset = detectedPreset || (COLUMN.list_item_type || '');

    const childGrid = document.getElementById('childColumnGrid');
    const summaryInfo = document.getElementById('summaryInfo');
    const lastSavedAt = document.getElementById('lastSavedAt');
    const addChildFieldBtn = document.getElementById('addChildFieldBtn');
    const saveSchemaBtn = document.getElementById('saveSchemaBtn');
    const closePopupBtn = document.getElementById('closePopupBtn');
    const closePopupTopBtn = document.getElementById('popupCloseTopBtn');

    const modalElement = document.getElementById('childFieldModal');
    const childFieldModalTitle = document.getElementById('childFieldModalTitle');
    const childFieldDeleteBtn = document.getElementById('childFieldDeleteBtn');
    const childFieldSaveBtn = document.getElementById('childFieldSaveBtn');

    const tableColumnMappings = {{ table_mappings | tojson | safe }};

    let selectedTableType = null;

    let modalInstance = null;
    let fallbackBackdrop = null;
    let editingIndex = -1;
    let editingOriginal = null;
    let childSortableInstance = null;

    if (window.ColumnFieldEditor) {
        window.ColumnFieldEditor.init({
            showSection: false,
            showSpan: false,
            showTable: true,
            showListButton: false,
            showNumber: true,
            showScoring: true,
            showActive: false
        });
        window.ColumnFieldEditor.resetForm();
    }

    if (modalElement) {
        modalElement.addEventListener('hidden.bs.modal', () => {
            resetChildFieldForm();
            removeFallbackBackdrop();
        });
    }

    if (childFieldDeleteBtn) {
        childFieldDeleteBtn.addEventListener('click', () => {
            if (editingIndex >= 0) {
                removeChildField(editingIndex);
                renderChildList();
            }
            hideChildModal();
        });
    }

    if (childFieldSaveBtn) {
        childFieldSaveBtn.addEventListener('click', () => {
            try {
                saveChildField();
                hideChildModal();
                renderChildList();
            } catch (err) {
                alert(err.message || err);
            }
        });
    }

    addChildFieldBtn.addEventListener('click', () => openChildModal());

    childGrid.addEventListener('click', (evt) => {
        const button = evt.target.closest('[data-action]');
        if (!button) return;
        const index = parseInt(button.dataset.index, 10);
        if (isNaN(index)) return;
        const action = button.dataset.action;
        if (action === 'edit') {
            openChildModal(index);
        } else if (action === 'remove') {
            removeChildField(index);
        }
    });

    saveSchemaBtn.addEventListener('click', () => {
        saveSchema().catch((err) => {
            if (err && err.message === 'empty-schema') {
                alert('최소 한 개 이상의 자식 컬럼을 추가해주세요.');
                return;
            }
            alert('저장 중 오류가 발생했습니다.\n\n' + (err && err.message ? err.message : err));
        });
    });

    if (closePopupBtn) {
        closePopupBtn.addEventListener('click', closeBuilderWindow);
    }
    if (closePopupTopBtn) {
        closePopupTopBtn.addEventListener('click', closeBuilderWindow);
    }

    function detectPreset(column) {
        const preset = (column.list_item_type || column.input_type || '').toString().trim();
        if (preset.startsWith('list_')) {
            const candidate = preset.slice(5);
            return candidate === 'custom' ? '' : candidate;
        }
        if (preset === 'partner_worker' || preset === 'company') {
            return preset;
        }
        return '';
    }

    function deepClone(value) {
        return value ? JSON.parse(JSON.stringify(value)) : null;
    }

    function escapeHtml(value) {
        const str = value == null ? '' : String(value);
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        return str.replace(/[&<>"']/g, (ch) => map[ch] || ch);
    }

    let generatedKeyCounter = 0;

    function sanitizeKey(raw) {
        let key = (raw || '').toLowerCase().replace(/[^a-z0-9_]/g, '_');
        key = key.replace(/_{2,}/g, '_').replace(/^_+/, '');
        if (!key) {
            const uniqueSuffix = (Date.now().toString(36) + '_' + (generatedKeyCounter++).toString(36)).replace(/[^a-z0-9_]/g, '');
            key = 'field_' + uniqueSuffix;
        }
        if (!/^[a-z]/.test(key)) {
            key = `f_${key}`;
        }
        return key;
    }

    function ensureUniqueKey(baseKey, currentIndex) {
        const sanitizedBase = sanitizeKey(baseKey);
        let key = sanitizedBase;
        let counter = 1;
        while (listChildFields.some((field, idx) => field.key === key && idx !== currentIndex)) {
            key = `${sanitizedBase}_${counter}`;
            counter += 1;
        }
        return key;
    }

    function mapTableColumnTypeToField(colType) {
        if (!colType) return 'text';
        if (colType.startsWith('popup_')) {
            return 'popup';
        }
        if (colType.startsWith('linked_')) {
            return 'text';
        }
        if (colType === 'dropdown') {
            return 'dropdown';
        }
        if (colType === 'number') {
            return 'number';
        }
        return colType;
    }

    function derivePopupLookup(colType) {
        if (!colType || !colType.startsWith('popup_')) return '';
        return colType.slice(6);
    }

    function generateTableChildFields(tableType) {
        const config = tableColumnMappings[tableType];
        if (!config) return [];
        const nameInput = document.getElementById('columnName');
        const keyInput = document.getElementById('columnKey');
        const baseNameRaw = nameInput && nameInput.value ? nameInput.value : config.name;
        const baseKeyRaw = keyInput && keyInput.value ? keyInput.value : tableType;
        const baseKey = sanitizeKey(baseKeyRaw || tableType);
        if (keyInput && !keyInput.value) {
            keyInput.value = baseKey;
        }

        const generated = (config.columns || []).map((col) => {
            const labelTemplate = col.label || '{base}';
            const keyTemplate = col.key || '{base}';
            const label = labelTemplate.replace(/\{base\}/g, baseNameRaw).trim();
            const keyRaw = keyTemplate.replace(/\{base\}/g, baseKey);
            const key = sanitizeKey(keyRaw);
            const fieldType = col.field_type || mapTableColumnTypeToField(col.type) || 'text';
            const type = fieldType.toLowerCase();
            const metadata = {
                tableGroup: baseKey,
                tableType: tableType
            };
            if (col.lookup_type) {
                metadata.lookupType = col.lookup_type;
            }
            if (Array.isArray(col.stores) && col.stores.length) {
                metadata.stores = col.stores.slice();
            }
            if (col.read_only) {
                metadata.readOnly = true;
            }
            if (col.multiple) {
                metadata.dropdownMulti = true;
            }
            const field = {
                key,
                label,
                type
            };
            if (col.bind) {
                field.bind = col.bind.replace(/\{base\}/g, baseKey);
            }
            if (Array.isArray(col.options)) {
                field.options = col.options.slice();
            }
            if (col.multiple) {
                field.dropdown_multi = true;
            }
            if (Object.keys(metadata).length) {
                field.metadata = metadata;
            }
            return field;
        });
        return generated;
    }

    function applyTablePreset(tableType) {
        if (!tableType) return;
        const generated = generateTableChildFields(tableType);
        if (!generated.length) return;

        const existingByKey = new Map();
        listChildFields.forEach((field, index) => existingByKey.set(field.key, index));

        if (listChildFields.length) {
            const hasOverlap = generated.some((field) => existingByKey.has(field.key));
            if (hasOverlap) {
                const confirmed = window.confirm('이미 동일한 키를 가진 자식 컬럼이 있습니다. 프리셋을 적용하면 해당 항목이 새 데이터로 갱신됩니다. 계속하시겠습니까?');
                if (!confirmed) {
                    const displayInput = document.getElementById('selectedTableDisplay');
                    if (displayInput) displayInput.value = '';
                    const configInput = document.getElementById('selectedTableConfig');
                    if (configInput) configInput.value = '';
                    selectedTableType = null;
                    return;
                }
            }
        }

        generated.forEach((genField) => {
            const existingIndex = existingByKey.get(genField.key);
            if (typeof existingIndex === 'number') {
                listChildFields[existingIndex] = {
                    ...listChildFields[existingIndex],
                    ...genField
                };
            } else {
                listChildFields.push({ ...genField });
            }
        });

        editingIndex = -1;
        renderChildList();
        hideChildModal();
        if (window.ColumnFieldEditor) {
            window.ColumnFieldEditor.resetForm();
            window.ColumnFieldEditor.handleTypeChange();
        }
    }

    function renderChildList() {
        if (!listChildFields.length) {
            summaryInfo.textContent = '총 0개';
            childGrid.innerHTML = '<div class="empty-placeholder"><i class="bi bi-layers"></i> 아직 자식 컬럼이 없습니다. "새 컬럼 추가" 버튼으로 시작하세요.</div>';
            destroyChildSortable();
            return;
        }
        summaryInfo.textContent = `총 ${listChildFields.length}개`;
        childGrid.innerHTML = listChildFields.map((field, index) => {
            const typeLabel = typeLabels[field.type] || field.type || '텍스트';
            return `
                <div class="column-card-small" data-index="${index}">
                    <div class="column-number">${index + 1}</div>
                    <div class="column-content">
                        <div class="column-name">${escapeHtml(field.label || '')}</div>
                        <div class="column-key">${escapeHtml(field.key)}</div>
                        <div class="column-controls">
                            <span class="column-type-badge">${escapeHtml(typeLabel)}</span>
                            <div style="display:flex; gap:5px; align-items:center;">
                                <button type="button" class="btn btn-sm btn-link p-0 text-primary" data-action="edit" data-index="${index}" title="편집"><i class="bi bi-pencil"></i></button>
                                <button type="button" class="btn btn-sm btn-link p-0 text-danger" data-action="remove" data-index="${index}" title="삭제"><i class="bi bi-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>`;
        }).join('');

        initializeChildSortable();
    }

    function resetChildFieldForm() {
        editingIndex = -1;
        editingOriginal = null;
        if (window.ColumnFieldEditor) {
            window.ColumnFieldEditor.resetForm();
        }
        selectedTableType = null;
        syncTableControlsFromForm();
        updateOptionPreviewFromArray([]);
        if (childFieldDeleteBtn) {
            childFieldDeleteBtn.style.display = 'none';
        }
        const collapseEl = document.getElementById('advancedSettings');
        if (collapseEl && collapseEl.classList.contains('show') && window.bootstrap && window.bootstrap.Collapse) {
            window.bootstrap.Collapse.getInstance(collapseEl)?.hide();
        }
    }

    function openChildModal(index) {
        resetChildFieldForm();
        editingIndex = typeof index === 'number' ? index : -1;
        if (editingIndex >= 0) {
            const field = listChildFields[editingIndex];
            if (!field) return;
            editingOriginal = deepClone(field);
            childFieldModalTitle.textContent = '자식 컬럼 수정';
            if (window.ColumnFieldEditor) {
                window.ColumnFieldEditor.fillForm(mapChildFieldToForm(field));
                window.ColumnFieldEditor.handleTypeChange();
            }
            updateOptionPreviewFromArray(Array.isArray(field.options) ? field.options : []);
            syncTableControlsFromForm();
            if (childFieldDeleteBtn) {
                childFieldDeleteBtn.style.display = '';
            }
        } else {
            childFieldModalTitle.textContent = '자식 컬럼 추가';
            if (childFieldDeleteBtn) {
                childFieldDeleteBtn.style.display = 'none';
            }
            if (window.ColumnFieldEditor) {
                window.ColumnFieldEditor.handleTypeChange();
            }
            syncTableControlsFromForm();
        }
        showChildModal();
    }

    function validateFieldKey(key) {
        if (!/^[a-z][a-z0-9_]*$/.test(key)) {
            throw new Error('컬럼 키는 영문 소문자로 시작해야 하며, 영문/숫자/언더스코어만 사용할 수 있습니다.');
        }
    }

    function saveChildField() {
        if (!window.ColumnFieldEditor) {
            throw new Error('폼 편집기를 찾을 수 없습니다.');
        }
        const formState = window.ColumnFieldEditor.collectFormData();
        let key = (formState.column_key || '').trim();
        const label = (formState.column_name || '').trim();
        const type = (formState.column_type || '').trim();
        const idx = editingIndex;

        if (!key || !/^[a-z]/.test(key)) {
            key = sanitizeKey(key || label || 'field');
            const keyInput = document.getElementById('columnKey');
            if (keyInput) {
                keyInput.value = key;
            }
        }

        validateFieldKey(key);
        const uniqueKey = ensureUniqueKey(key, idx);
        if (uniqueKey !== key) {
            key = uniqueKey;
            const keyInput = document.getElementById('columnKey');
            if (keyInput) {
                keyInput.value = key;
            }
        }

        if (!label) {
            throw new Error('컬럼명을 입력해주세요.');
        }
        if (!type) {
            throw new Error('입력 타입을 선택해주세요.');
        }
        if (type === 'list') {
            throw new Error('리스트 안에 리스트 타입을 추가할 수 없습니다.');
        }

        const existing = idx >= 0 ? { ...listChildFields[idx] } : {};
        const field = {
            ...existing,
            key,
            label,
            type
        };

        const metadata = existing.metadata ? deepClone(existing.metadata) || {} : {};

        if (type === 'dropdown') {
            const options = Array.isArray(formState.dropdown_options) ? formState.dropdown_options : [];
            if (!options.length) {
                throw new Error('드롭다운 옵션을 최소 한 개 이상 입력해주세요.');
            }
            field.options = options;
            field.dropdown_multi = !!formState.dropdown_multi;
            metadata.dropdownMulti = field.dropdown_multi;
        } else {
            delete field.options;
            delete field.dropdown_multi;
            delete metadata.dropdownMulti;
        }

        if (type === 'number') {
            metadata.numberType = formState.number_type === 'float' ? 'float' : 'integer';
            delete metadata.perUnit;
            delete metadata.grade;
        } else {
            delete metadata.numberType;
            delete metadata.perUnit;
            delete metadata.grade;
        }

        if (type === 'table') {
            if (formState.table_config) {
                metadata.tableConfig = formState.table_config;
            } else {
                delete metadata.tableConfig;
            }
            if (formState.table_display) {
                metadata.tableDisplay = formState.table_display;
            } else {
                delete metadata.tableDisplay;
            }
        } else {
            delete metadata.tableConfig;
            delete metadata.tableDisplay;
        }

        if (type === 'scoring' || type === 'score_total') {
            if (formState.scoring_config) {
                metadata.scoringConfig = formState.scoring_config;
            } else {
                delete metadata.scoringConfig;
            }
        } else {
            delete metadata.scoringConfig;
        }

        Object.keys(metadata).forEach((keyName) => {
            const value = metadata[keyName];
            if (value === '' || value === undefined || value === null) {
                delete metadata[keyName];
            }
            if (Array.isArray(value) && !value.length) {
                delete metadata[keyName];
            }
        });

        if (Object.keys(metadata).length) {
            field.metadata = metadata;
        } else {
            delete field.metadata;
        }

        if (idx >= 0 && idx < listChildFields.length) {
            listChildFields[idx] = field;
        } else {
            listChildFields.push(field);
        }
    }

    function mapChildFieldToForm(field) {
        const metadata = field && typeof field === 'object' ? (field.metadata || {}) : {};
        return {
            id: field.id,
            column_name: field.label || '',
            column_key: field.key || '',
            column_type: field.type || 'text',
            dropdown_options: Array.isArray(field.options) ? field.options.slice() : [],
            dropdown_multi: field.dropdown_multi || metadata.dropdownMulti || false,
            table_config: metadata.tableConfig || '',
            table_display: metadata.tableDisplay || '',
            number_type: metadata.numberType || 'integer',
            scoring_config: metadata.scoringConfig || '',
            scoring_preview: metadata.scoringPreview || ''
        };
    }

    function updateOptionPreviewFromArray(options) {
        const preview = document.getElementById('optionPreview');
        const body = document.getElementById('optionPreviewBody');
        if (!preview || !body) return;
        if (Array.isArray(options) && options.length) {
            preview.style.display = 'block';
            body.innerHTML = options.map((opt, idx) => `
                <tr>
                    <td>${idx + 1}</td>
                    <td>${escapeHtml(opt)}</td>
                </tr>
            `).join('');
        } else {
            preview.style.display = 'none';
            body.innerHTML = '';
        }
    }

    function setDropdownOptions(options) {
        const hidden = document.getElementById('dropdownOptions');
        if (hidden) {
            hidden.value = JSON.stringify(Array.isArray(options) ? options : []);
        }
        updateOptionPreviewFromArray(options);
    }

    function openLocalCodeEditor() {
        if (!window.ColumnFieldEditor) {
            alert('폼 편집기를 찾을 수 없습니다.');
            return;
        }
        const formState = window.ColumnFieldEditor.collectFormData();
        const type = (formState.column_type || '').trim();
        if (type !== 'dropdown') {
            alert('드롭다운 타입에서만 옵션을 설정할 수 있습니다.');
            return;
        }
        const current = Array.isArray(formState.dropdown_options) ? formState.dropdown_options : [];
        const promptMessage = '드롭다운 옵션을 줄바꿈으로 입력하세요.';
        const input = window.prompt(promptMessage, current.join("\n"));
        if (input === null) {
            return;
        }
        const options = input.split(/\r?\n/).map((line) => line.trim()).filter(Boolean);
        if (!options.length) {
            alert('최소 한 개 이상의 옵션을 입력해주세요.');
            return;
        }
        setDropdownOptions(options);
        if (window.ColumnFieldEditor) {
            window.ColumnFieldEditor.refreshElements();
            window.ColumnFieldEditor.handleTypeChange();
        }
    }

    window.openCodeEditor = openLocalCodeEditor;

    function getTypeLabelForTable(type) {
        const mapping = {
            popup_person: '담당자 검색',
            popup_company: '업체 검색',
            popup_department: '부서 검색',
            popup_building: '건물 검색',
            popup_contractor: '근로자 검색',
            popup_division: '사업부 검색',
            linked_text: '연동 텍스트',
            linked_dept: '연동 부서',
            linked_company: '연동 업체',
            linked_bizno: '연동 사업자번호',
            popup: '검색 팝업'
        };
        if (typeLabels[type]) {
            return typeLabels[type];
        }
        return mapping[type] || type || '텍스트';
    }

    function buildTableList(activeType) {
        const container = document.getElementById('tableList');
        if (!container) return;
        container.innerHTML = '';
        const icons = {
            person: 'bi-person-fill',
            company: 'bi-building',
            department: 'bi-diagram-3',
            building: 'bi-house-door',
            contractor: 'bi-people-fill',
            division: 'bi-diagram-2'
        };
        Object.entries(tableColumnMappings).forEach(([key, config]) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'list-group-item list-group-item-action d-flex align-items-center gap-2';
            button.dataset.tableType = key;
            if (key === activeType) {
                button.classList.add('active');
            }
            button.innerHTML = `<i class="bi ${icons[key] || 'bi-table'}"></i><span>${config.name}</span>`;
            button.addEventListener('click', () => selectTable(key));
            container.appendChild(button);
        });
    }

    function selectTable(tableType) {
        selectedTableType = tableType;
        document.querySelectorAll('#tableList .list-group-item').forEach((btn) => {
            if (btn.dataset.tableType === tableType) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        const confirmBtn = document.getElementById('confirmTableBtn');
        if (confirmBtn) {
            confirmBtn.disabled = !tableType;
        }
        updateTablePreview(tableType);
    }

    function updateTablePreview(tableType) {
        const preview = document.getElementById('tablePreview');
        if (!preview) return;
        if (!tableType || !tableColumnMappings[tableType]) {
            preview.innerHTML = `
                <div class="text-center text-muted" style="padding:40px 0;">
                    <i class="bi bi-info-circle" style="font-size:42px;"></i>
                    <p class="mt-3 mb-0">왼쪽 목록에서 테이블을 선택해주세요.</p>
                </div>`;
            return;
        }
        const config = tableColumnMappings[tableType];
        const columnNameInput = document.getElementById('columnName');
        const columnKeyInput = document.getElementById('columnKey');
        const baseName = columnNameInput && columnNameInput.value ? columnNameInput.value : config.name;
        const baseKey = columnKeyInput && columnKeyInput.value ? columnKeyInput.value : tableType;
        let html = `
            <div class="table-responsive">
                <table class="table table-sm table-bordered mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="40">#</th>
                            <th>컬럼명</th>
                            <th>컬럼 키</th>
                            <th>타입</th>
                        </tr>
                    </thead>
                    <tbody>`;
        config.columns.forEach((col, index) => {
            const name = index === 0 ? baseName : `${baseName} ${col.name.split(' ').slice(-1)[0]}`;
            const key = baseKey + col.key_suffix;
            html += `
                <tr>
                    <td class="text-center">${index + 1}</td>
                    <td>${escapeHtml(name)}</td>
                    <td><code>${escapeHtml(key)}</code></td>
                    <td><span class="badge bg-secondary">${escapeHtml(getTypeLabelForTable(col.type))}</span></td>
                </tr>`;
        });
        html += '</tbody></table></div>';
        preview.innerHTML = html;
    }

    function updateMainTablePreview(tableType) {
        const preview = document.getElementById('tableColumnsPreview');
        if (!preview) return;
        if (!tableType || !tableColumnMappings[tableType]) {
            preview.innerHTML = '';
            preview.style.display = 'none';
            return;
        }
        const config = tableColumnMappings[tableType];
        const columnNameInput = document.getElementById('columnName');
        const baseName = columnNameInput && columnNameInput.value ? columnNameInput.value : config.name;
        const badges = config.columns.map((col, index) => {
            const label = index === 0 ? baseName : `${baseName} ${col.name.split(' ').slice(-1)[0]}`;
            return `<span class="badge bg-info text-dark me-1">${escapeHtml(label)}</span>`;
        }).join('');
        preview.innerHTML = `<small class="text-muted">생성될 컬럼: </small>${badges}`;
        preview.style.display = 'block';
    }

    function openTableConfigModal() {
        const configInput = document.getElementById('selectedTableConfig');
        selectedTableType = configInput && configInput.value ? configInput.value : null;
        buildTableList(selectedTableType);
        const confirmBtn = document.getElementById('confirmTableBtn');
        if (confirmBtn) {
            confirmBtn.disabled = !selectedTableType;
        }
        updateTablePreview(selectedTableType);
        const modalElement = document.getElementById('tableConfigModal');
        if (!modalElement) return;
        const modal = window.bootstrap && window.bootstrap.Modal
            ? window.bootstrap.Modal.getOrCreateInstance(modalElement)
            : null;
        if (modal) {
            modal.show();
        } else {
            modalElement.classList.add('show');
            modalElement.style.display = 'block';
        }
    }

    function closeTableConfigModal() {
        const modalElement = document.getElementById('tableConfigModal');
        if (!modalElement) return;
        const modal = window.bootstrap && window.bootstrap.Modal
            ? window.bootstrap.Modal.getInstance(modalElement)
            : null;
        if (modal) {
            modal.hide();
        } else {
            modalElement.classList.remove('show');
            modalElement.style.display = 'none';
        }
    }

    function confirmTableSelection() {
        if (!selectedTableType) return;
        const config = tableColumnMappings[selectedTableType];
        const displayInput = document.getElementById('selectedTableDisplay');
        const configInput = document.getElementById('selectedTableConfig');
        if (displayInput) {
            displayInput.value = config ? config.name : selectedTableType;
        }
        if (configInput) {
            configInput.value = selectedTableType;
        }
        updateMainTablePreview(selectedTableType);
        closeTableConfigModal();
        if (window.ColumnFieldEditor) {
            window.ColumnFieldEditor.refreshElements();
            window.ColumnFieldEditor.handleTypeChange();
        }
        applyTablePreset(selectedTableType);
    }

    function syncTableControlsFromForm() {
        const configInput = document.getElementById('selectedTableConfig');
        const displayInput = document.getElementById('selectedTableDisplay');
        const currentType = configInput && configInput.value ? configInput.value : '';
        selectedTableType = currentType || null;
        if (currentType && displayInput && !displayInput.value && tableColumnMappings[currentType]) {
            displayInput.value = tableColumnMappings[currentType].name;
        }
        updateMainTablePreview(currentType);
    }

    window.openTableConfigModal = openTableConfigModal;

    const confirmTableBtn = document.getElementById('confirmTableBtn');
    if (confirmTableBtn) {
        confirmTableBtn.addEventListener('click', confirmTableSelection);
    }

    ['columnName', 'columnKey'].forEach((id) => {
        const input = document.getElementById(id);
        if (!input) return;
        input.addEventListener('input', () => {
            if (selectedTableType) {
                updateTablePreview(selectedTableType);
                updateMainTablePreview(selectedTableType);
            }
        });
    });

    const typeSelect = document.getElementById('columnType');
    if (typeSelect) {
        typeSelect.addEventListener('change', () => {
            if (typeSelect.value !== 'table') {
                selectedTableType = null;
                updateMainTablePreview(null);
            } else {
                syncTableControlsFromForm();
            }
        });
    }


    function validateColumnName(input) {
        if (!input) return true;
        const value = input.value.trim();
        const errorDiv = document.getElementById('columnNameError');

        if (/^\d+$/.test(value)) {
            input.classList.add('is-invalid');
            if (errorDiv) {
                errorDiv.textContent = '숫자로만 구성된 컬럼명은 사용할 수 없습니다.';
                errorDiv.style.display = 'block';
            }
            return false;
        } else if (value && !/[가-힣a-zA-Z]/.test(value)) {
            input.classList.add('is-invalid');
            if (errorDiv) {
                errorDiv.textContent = '최소 하나 이상의 한글 또는 영문자를 포함해야 합니다.';
                errorDiv.style.display = 'block';
            }
            return false;
        } else {
            input.classList.remove('is-invalid');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
            return true;
        }
    }

    function validateColumnKey(input) {
        if (!input) return true;
        const value = input.value.trim();
        const errorDiv = document.getElementById('columnKeyError');

        if (value && !/^[a-z][a-z0-9_]*$/.test(value)) {
            input.classList.add('is-invalid');
            if (errorDiv) {
                errorDiv.textContent = '영문 소문자로 시작하고, 영문 소문자/숫자/언더스코어만 사용 가능합니다.';
                errorDiv.style.display = 'block';
            }
            return false;
        } else {
            input.classList.remove('is-invalid');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
            return true;
        }
    }

    function reorderChildField(fromIndex, toIndex) {
        if (fromIndex === toIndex) {
            return;
        }
        if (fromIndex < 0 || fromIndex >= listChildFields.length) {
            return;
        }

        let target = toIndex;
        if (target < 0) {
            target = 0;
        }
        if (target >= listChildFields.length) {
            target = listChildFields.length - 1;
        }

        const [moved] = listChildFields.splice(fromIndex, 1);
        listChildFields.splice(target, 0, moved);
        renderChildList();
    }

    function destroyChildSortable() {
        if (childSortableInstance) {
            try {
                childSortableInstance.destroy();
            } catch (err) {
                console.warn('Failed to destroy child Sortable instance', err);
            }
            childSortableInstance = null;
        }
    }

    function initializeChildSortable() {
        if (!window.Sortable) {
            console.warn('Sortable.js is not loaded for child builder');
            return;
        }
        destroyChildSortable();
        childSortableInstance = new Sortable(childGrid, {
            animation: 150,
            ghostClass: 'dragging',
            handle: '.column-card-small',
            onEnd(evt) {
                if (evt.oldIndex === undefined || evt.newIndex === undefined) {
                    return;
                }
                reorderChildField(evt.oldIndex, evt.newIndex);
            }
        });
    }

    function removeChildField(index) {
        if (!confirm('해당 자식 컬럼을 삭제하시겠습니까?')) return;
        listChildFields.splice(index, 1);
        renderChildList();
    }

    function getModalInstance() {
        if (!modalElement) return null;
        if (window.bootstrap && window.bootstrap.Modal) {
            modalInstance = window.bootstrap.Modal.getOrCreateInstance(modalElement);
            return modalInstance;
        }
        return null;
    }

    function ensureFallbackBackdrop() {
        if (fallbackBackdrop && document.body.contains(fallbackBackdrop)) {
            return;
        }
        fallbackBackdrop = document.createElement('div');
        fallbackBackdrop.className = 'modal-backdrop fade show';
        document.body.appendChild(fallbackBackdrop);
    }

    function removeFallbackBackdrop() {
        if (fallbackBackdrop && fallbackBackdrop.parentNode) {
            fallbackBackdrop.parentNode.removeChild(fallbackBackdrop);
        }
    }

    function closeBuilderWindow() {
        if (typeof closePopupWindow === 'function') {
            closePopupWindow();
            return;
        }
        try {
            window.close();
        } catch (err) {
            console.warn('창을 닫을 수 없습니다:', err);
        }
    }

    function showChildModal() {
        const instance = getModalInstance();
        if (instance) {
            instance.show();
            return;
        }
        modalElement.classList.add('show');
        modalElement.style.display = 'block';
        modalElement.removeAttribute('aria-hidden');
        modalElement.setAttribute('aria-modal', 'true');
        ensureFallbackBackdrop();
        document.body.classList.add('modal-open');
    }

    function hideChildModal() {
        const instance = getModalInstance();
        if (instance) {
            instance.hide();
            return;
        }
        modalElement.classList.remove('show');
        modalElement.style.display = 'none';
        modalElement.setAttribute('aria-hidden', 'true');
        modalElement.removeAttribute('aria-modal');
        document.body.classList.remove('modal-open');
        removeFallbackBackdrop();
        resetChildFieldForm();
    }

    function normalizeField(field) {
        const result = {
            key: field.key,
            label: field.label,
            type: field.type || 'text'
        };
        if (field.bind) result.bind = field.bind;
        if (Array.isArray(field.options) && field.options.length) {
            result.options = field.options.slice();
        }
        if (field.dropdown_multi) {
            result.dropdown_multi = true;
        }
        if (field.metadata && Object.keys(field.metadata).length) {
            result.metadata = JSON.parse(JSON.stringify(field.metadata));
        }
        return result;
    }

    function saveSchema() {
        if (!listChildFields.length) {
            return Promise.reject(new Error('empty-schema'));
        }
        const schema = {
            version: '1.0',
            rowMode: 'multi',
            childFields: listChildFields.map(normalizeField)
        };
        const preset = COLUMN.list_item_type || currentPreset || '';
        let inputType = COLUMN.input_type || '';
        if (!inputType && preset) {
            inputType = preset === 'company' ? 'list_company' : `list_${preset}`;
        }
        const payload = { child_schema: schema };
        if (inputType) payload.input_type = inputType;
        if (preset) payload.list_item_type = preset;

        return fetch(API_ENDPOINT, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then((resp) => resp.json().catch(() => ({})).then((body) => ({ ok: resp.ok, body })))
            .then(({ ok, body }) => {
                if (!ok || body.success === false) {
                    throw new Error(body.message || '알 수 없는 오류');
                }
                const now = new Date();
                if (lastSavedAt) {
                    lastSavedAt.textContent = now.toLocaleString();
                }
                COLUMN.child_schema = schema;
                if (preset) COLUMN.list_item_type = preset;
                if (inputType) COLUMN.input_type = inputType;
                currentPreset = preset;
                if (window.opener && !window.opener.closed) {
                    try {
                        const targetOrigin = (window.location && window.location.origin) ? window.location.origin : '*';
                        window.opener.postMessage({
                            type: 'LIST_CHILD_SCHEMA_SAVED',
                            columnId: COLUMN.id,
                            columnKey: COLUMN.column_key,
                            schema,
                            listItemType: preset,
                            inputType,
                            rowMode: schema.rowMode || 'multi'
                        }, targetOrigin);
                    } catch (postErr) {
                        console.warn('부모 창 알림 실패:', postErr);
                    }
                }
                alert('리스트 자식 컬럼 구성이 저장되었습니다.');
            });
    }

    function initialise() {
        if (lastSavedAt) {
            lastSavedAt.textContent = COLUMN.updated_at || '-';
        }
        const initialSchema = COLUMN.child_schema && Object.keys(COLUMN.child_schema).length
            ? COLUMN.child_schema
            : null;
        const cloned = initialSchema ? deepClone(initialSchema) : { childFields: [] };
        listChildFields = Array.isArray(cloned.childFields) ? cloned.childFields.map(deepClone) : [];
        renderChildList();
    }

    syncTableControlsFromForm();
    initialise();
})();
</script>
{% endblock %}
