{% if is_popup %}
{% extends "popup-base.html" %}
{% else %}
{% extends "base.html" %}
{% endif %}

{% block head %}
{% endblock %}

{% block title %}환경안전 지시서 상세정보{% endblock %}
{% block popup_title %}{{ instruction.issue_number }} - 환경안전 지시서 상세정보{% endblock %}
{% block content %}

{% if not is_popup %}
<div class="page-header">
    <h2 class="page-title">환경안전 지시서 상세정보</h2>
    <div class="breadcrumb">
        <a href="{{ url_for('page_view', url='safety-instruction') }}">환경안전 지시서</a>
        <span class="separator">></span>
        <span class="current">{{ instruction.issue_number }}</span>
    </div>
</div>
{% endif %}

<div class="safety-instruction-detail-container">
    <!-- 동적 섹션 렌더링 -->
    {% for section in sections %}
    <div class="section {% if section.section_key == 'basic_info' %}basic-info{% elif section.section_key == 'violation_info' %}violation-info{% elif section.section_key == 'additional' %}additional{% else %}{{ section.section_key|replace('_', '-') }}{% endif %}-section">
        <div class="section-header">
            <h3 class="section-title">{{ section.section_name }}</h3>
            <button class="collapse-btn" onclick="toggleSection('{% if section.section_key == 'basic_info' %}basic-info{% elif section.section_key == 'violation_info' %}violation-info{% elif section.section_key == 'additional' %}additional{% else %}{{ section.section_key|replace('_', '-') }}{% endif %}')">
                <span class="collapse-icon">▲</span>
            </button>
        </div>
        <div class="section-content" id="{% if section.section_key == 'basic_info' %}basic-info{% elif section.section_key == 'violation_info' %}violation-info{% elif section.section_key == 'additional' %}additional{% else %}{{ section.section_key|replace('_', '-') }}{% endif %}-content">
            <div class="info-table">
                {% set ns = namespace(col_count=0) %}
                {% for col in section_columns[section.section_key] %}
                    {% set span = col.column_span|default(1)|int %}
                    
                    <!-- 새 행 시작 조건 -->
                    {% if loop.first or ns.col_count == 0 %}
                        <div class="info-row">
                    {% endif %}
                    
                    <!-- 필드 렌더링 -->
                    <div class="info-cell {% if span > 1 %}span-{{ span }}{% endif %}">
                        <label>{{ col.column_name }}</label>
                        {% set col_value = instruction[col.column_key] | default('', true) %}
                        
                        {% if col.column_key == 'issue_number' %}
                            <div class="value">{{ col_value or '-' }}</div>
                        {% elif col.column_type == 'dropdown' %}
                            <select class="{% if section.section_key == 'basic_info' %}basic-info{% elif section.section_key == 'violation_info' %}violation-info{% elif section.section_key == 'additional' %}additional{% else %}{{ section.section_key|replace('_', '-') }}{% endif %}-input" 
                                    data-field="{{ col.column_key }}"
                                    data-section="{{ section.section_key }}">
                                <option value="">선택하세요</option>
                                {% if col.column_key in basic_options %}
                                    {% for opt in basic_options[col.column_key] %}
                                    <option value="{{ opt.code }}" {% if opt.code == col_value %}selected{% endif %}>
                                        {{ opt.value }}
                                    </option>
                                    {% endfor %}
                                {% elif col.dropdown_options_mapped %}
                                    {% for opt in col.dropdown_options_mapped %}
                                    <option value="{{ opt.code }}" {% if opt.code == col_value %}selected{% endif %}>
                                        {{ opt.value }}
                                    </option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                        {% elif col.column_type == 'date' %}
                            <input type="date" 
                                   class="{% if section.section_key == 'basic_info' %}basic-info{% elif section.section_key == 'violation_info' %}violation-info{% elif section.section_key == 'additional' %}additional{% else %}{{ section.section_key|replace('_', '-') }}{% endif %}-input" 
                                   data-field="{{ col.column_key }}"
                                   data-section="{{ section.section_key }}"
                                   value="{{ col_value }}">
                        {% elif col.column_type == 'textarea' %}
                            <textarea class="{% if section.section_key == 'basic_info' %}basic-info{% elif section.section_key == 'violation_info' %}violation-info{% elif section.section_key == 'additional' %}additional{% else %}{{ section.section_key|replace('_', '-') }}{% endif %}-input" 
                                    data-field="{{ col.column_key }}"
                                    data-section="{{ section.section_key }}"
                                    rows="4">{{ col_value }}</textarea>
                        {% else %}
                            <input type="text" 
                                   class="{% if section.section_key == 'basic_info' %}basic-info{% elif section.section_key == 'violation_info' %}violation-info{% elif section.section_key == 'additional' %}additional{% else %}{{ section.section_key|replace('_', '-') }}{% endif %}-input" 
                                   data-field="{{ col.column_key }}"
                                   data-section="{{ section.section_key }}"
                                   value="{{ col_value }}">
                        {% endif %}
                    </div>
                    
                    {% set ns.col_count = ns.col_count + span %}
                    
                    <!-- 행 종료 조건 -->
                    {% if ns.col_count >= 4 %}
                        </div>
                        {% set ns.col_count = 0 %}
                    {% elif loop.last %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- 첨부파일 영역 -->
    <div class="section attachments-section">
        <div class="section-header">
            <h3 class="section-title">첨부파일</h3>
            <button class="btn-add-file" onclick="document.getElementById('file-input').click();">추가</button>
            <span class="file-count">총 <span id="file-count">{{ attachments|length }}</span>개</span>
        </div>
        <div class="section-content">
            <input type="file" id="file-input" multiple style="display: none;" onchange="handleFileUpload(this.files)">
            <div class="attachments-table">
                <div class="table-header">
                    <div class="col-no">No.</div>
                    <div class="col-file">파일명</div>
                    <div class="col-desc">설명</div>
                    <div class="col-action">작업</div>
                </div>
                <div class="table-body" id="attachments-tbody">
                    {% if attachments %}
                        {% for att in attachments %}
                        <div class="table-row" data-attachment-id="{{ att.id }}">
                            <div class="col-no">{{ loop.index }}</div>
                            <div class="col-file">
                                <a href="/download-attachment/{{ att.id }}" target="_blank">{{ att.file_name }}</a>
                            </div>
                            <div class="col-desc">{{ att.description or '-' }}</div>
                            <div class="col-action">
                                <button class="btn-delete" onclick="deleteAttachment({{ att.id }})">삭제</button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="table-row no-data" id="no-data-row">
                            <div class="col-full">등록된 첨부파일이 없습니다.</div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 저장 버튼 영역 -->
    <div class="save-section">
        <button class="btn-save" onclick="updateSafetyInstruction()">수정완료</button>
        <button class="btn-cancel" onclick="window.close()">취소</button>
    </div>
</div>

<!-- 스타일 -->
<link rel="stylesheet" href="/static/styles/accident-register.css">

<script>
// JavaScript 코드는 기존 것 그대로 사용
const sections = {{ sections | tojson | safe }};
const sectionColumns = {{ section_columns | tojson | safe }};
const issueNumber = "{{ instruction.issue_number }}";

function toggleSection(sectionId) {
    const content = document.getElementById(sectionId + '-content');
    const icon = event.target;
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '▲';
    } else {
        content.style.display = 'none';
        icon.textContent = '▼';
    }
}

// 파일 업로드 등 기타 함수들...
let newFiles = [];

function handleFileUpload(files) {
    for (let file of files) {
        newFiles.push(file);
        
        const tbody = document.getElementById('attachments-tbody');
        const noDataRow = document.getElementById('no-data-row');
        
        if (noDataRow) {
            noDataRow.remove();
        }
        
        const row = document.createElement('div');
        row.className = 'table-row new-file';
        row.innerHTML = `
            <div class="col-no">신규</div>
            <div class="col-file">${file.name}</div>
            <div class="col-desc">
                <input type="text" class="file-desc-input" placeholder="파일 설명 입력">
            </div>
            <div class="col-action">
                <button class="btn-delete" onclick="removeNewFile(${newFiles.length - 1})">취소</button>
            </div>
        `;
        tbody.appendChild(row);
    }
    
    updateFileCount();
}

function removeNewFile(index) {
    newFiles.splice(index, 1);
    const newFileRows = document.querySelectorAll('.new-file');
    if (newFileRows[index]) {
        newFileRows[index].remove();
    }
    updateFileCount();
}

function deleteAttachment(attachmentId) {
    if (!confirm('이 첨부파일을 삭제하시겠습니까?')) {
        return;
    }
    
    fetch(`/delete-attachment/${attachmentId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.querySelector(`[data-attachment-id="${attachmentId}"]`).remove();
            updateFileCount();
        } else {
            alert('첨부파일 삭제 실패');
        }
    });
}

function updateFileCount() {
    const totalCount = document.querySelectorAll('#attachments-tbody .table-row:not(.no-data)').length;
    document.getElementById('file-count').textContent = totalCount;
}

function collectDynamicFields() {
    const data = {};
    
    sections.forEach(section => {
        const sectionInputs = document.querySelectorAll(`[data-section="${section.section_key}"]`);
        
        sectionInputs.forEach(input => {
            const fieldKey = input.dataset.field;
            let value = '';
            
            if (input.tagName === 'SELECT') {
                value = input.value;
            } else if (input.type === 'checkbox') {
                value = input.checked ? '1' : '0';
            } else if (input.tagName === 'TEXTAREA') {
                value = input.value;
            } else {
                value = input.value;
            }
            
            data[fieldKey] = value;
        });
    });
    
    return data;
}

function updateSafetyInstruction() {
    const formData = new FormData();
    
    formData.append('issue_number', issueNumber);
    
    const dynamicData = collectDynamicFields();
    
    for (const [key, value] of Object.entries(dynamicData)) {
        formData.append(key, value);
    }
    
    const customData = {};
    sections.forEach(section => {
        if (section.section_key !== 'basic_info' && 
            section.section_key !== 'violation_info') {
            const cols = sectionColumns[section.section_key] || [];
            cols.forEach(col => {
                if (dynamicData[col.column_key]) {
                    customData[col.column_key] = dynamicData[col.column_key];
                }
            });
        }
    });
    
    formData.append('custom_data', JSON.stringify(customData));
    
    newFiles.forEach((file, index) => {
        formData.append('files', file);
        const descInput = document.querySelectorAll('.new-file .file-desc-input')[index];
        if (descInput) {
            formData.append(`file_desc_${index}`, descInput.value);
        }
    });
    
    fetch('/update-safety-instruction', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('환경안전 지시서가 성공적으로 수정되었습니다.');
            if (window.opener) {
                window.opener.location.reload();
                window.close();
            } else {
                window.location.href = '/safety-instruction';
            }
        } else {
            alert('수정 실패: ' + (data.message || '알 수 없는 오류'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('수정 중 오류가 발생했습니다.');
    });
}

function openPopup(fieldKey) {
    alert('팝업 기능은 추가 구현이 필요합니다.');
}
</script>

<style>
.info-cell textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 14px;
    resize: vertical;
}

.info-cell.span-2 {
    grid-column: span 2;
}

.info-cell.span-3 {
    grid-column: span 3;
}

.info-cell.span-4 {
    grid-column: span 4;
}

.info-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 16px;
}

.input-group {
    display: flex;
    gap: 4px;
}

.input-group input {
    flex: 1;
}

.input-group button {
    padding: 4px 8px;
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    cursor: pointer;
}

.input-group button:hover {
    background: #e5e7eb;
}

.btn-cancel {
    background: #6b7280;
    margin-left: 10px;
}

.btn-cancel:hover {
    background: #4b5563;
}
</style>

{% endblock %}