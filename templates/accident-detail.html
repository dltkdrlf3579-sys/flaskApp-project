{% if is_popup %}
{% extends "popup-base.html" %}
{% else %}
{% extends "base.html" %}
{% endif %}

{% block head %}
{% endblock %}

{% block title %}사고 상세정보{% endblock %}
{% block popup_title %}{{ instruction.accident_number }} - 사고 상세정보{% endblock %}
{% block content %}

{% if not is_popup %}
<div class="page-header">
    <h2 class="page-title">사고 상세정보</h2>
    <div class="breadcrumb">
        <a href="{{ url_for('page_view', url='accident') }}">사고</a>
        <span class="separator">></span>
        <span class="current">{{ instruction.accident_number }}</span>
    </div>
</div>
{% endif %}

<div class="accident-detail-container">
    <!-- 동적 섹션 렌더링 -->
    {% for section in sections %}
    <div class="section {{ section.section_key }}-section">
        <div class="section-header">
            <h3 class="section-title">{{ section.section_name }}</h3>
            <button class="collapse-btn" onclick="toggleSection('{{ section.section_key }}')">
                <span class="collapse-icon">▲</span>
            </button>
        </div>
        <div class="section-content" id="{{ section.section_key }}-content">
            <div class="info-table">
                {% set all_columns = section_columns[section.section_key] %}
                <!-- accident_content는 제외하고 일반 필드만 batch 처리 -->
                {% set columns = [] %}
                {% for col in all_columns %}
                    {% if col.column_key != 'accident_content' %}
                        {% set _ = columns.append(col) %}
                    {% endif %}
                {% endfor %}
                {% set columns_per_row = 4 %}
                
                <!-- batch 방식으로 4개씩 묶어서 처리 -->
                {% for chunk in columns | batch(columns_per_row, '') %}
                <div class="info-row">
                    {% for col in chunk %}
                        {% if col %}
                            {% set span = col.column_span|default(1)|int %}
                            
                            <div class="info-cell {% if span > 1 %}span-{{ span }}{% endif %}">
                                <label>{{ col.column_name }}</label>
                                {% set col_value = instruction[col.column_key] | default('', true) %}
                            
                            {% if col.column_key == 'accident_number' %}
                                <!-- 발부번호는 수정 불가 -->
                                <div class="value">{{ col_value or '-' }}</div>
                            {% elif col.column_type == 'dropdown' %}
                                <!-- 드롭다운 필드 -->
                                <select class="{{ section.section_key }}-input" 
                                        data-field="{{ col.column_key }}"
                                        data-section="{{ section.section_key }}">
                                    <option value="">선택하세요</option>
                                    {% if col.column_key in basic_options %}
                                        {% for opt in basic_options[col.column_key] %}
                                        <option value="{{ opt.option_code }}" 
                                                {% if opt.option_code == col_value %}selected{% endif %}>
                                            {{ opt.option_value }}
                                        </option>
                                        {% endfor %}
                                    {% elif col.dropdown_options_mapped %}
                                        {% for opt in col.dropdown_options_mapped %}
                                        <option value="{{ opt.option_code }}"
                                                {% if opt.option_code == col_value %}selected{% endif %}>
                                            {{ opt.option_value }}
                                        </option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            {% elif col.column_type == 'date' %}
                                <!-- 날짜 필드 -->
                                <input type="date" 
                                       class="{{ section.section_key }}-input" 
                                       data-field="{{ col.column_key }}"
                                       data-section="{{ section.section_key }}"
                                       value="{{ col_value }}">
                            {% elif col.column_type == 'number' %}
                                <!-- 숫자 필드 -->
                                <input type="number" 
                                       class="{{ section.section_key }}-input" 
                                       data-field="{{ col.column_key }}"
                                       data-section="{{ section.section_key }}"
                                       value="{{ col_value }}">
                            {% elif col.column_type == 'linked' %}
                                <!-- 연결된 필드 (읽기 전용) -->
                                <input type="text" 
                                       class="{{ section.section_key }}-input" 
                                       data-field="{{ col.column_key }}"
                                       data-section="{{ section.section_key }}"
                                       value="{{ col_value }}"
                                       readonly
                                       style="background-color: #f3f4f6;">
                            {% elif col.column_type == 'popup' %}
                                <!-- 팝업 필드 -->
                                <div class="input-group">
                                    <input type="text" 
                                           class="{{ section.section_key }}-input" 
                                           data-field="{{ col.column_key }}"
                                           data-section="{{ section.section_key }}"
                                           value="{{ col_value }}"
                                           readonly>
                                    <button class="btn btn-sm btn-outline-secondary" 
                                            onclick="openPopup('{{ col.column_key }}')">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            {% else %}
                                <!-- 기본 텍스트 필드 -->
                                <input type="text" 
                                       class="{{ section.section_key }}-input" 
                                       data-field="{{ col.column_key }}"
                                       data-section="{{ section.section_key }}"
                                       value="{{ col_value }}">
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endfor %}
                
                <!-- accident_content 필드가 있는 경우 별도 처리 -->
                {% for col in all_columns %}
                    {% if col.column_key == 'accident_content' %}
                    <div class="info-row">
                        <div class="info-cell span-4">
                            <label>{{ col.column_name }}</label>
                            {% set col_value = instruction[col.column_key] | default('', true) %}
                            <textarea id="{{ col.column_key }}" 
                                    class="{{ section.section_key }}-input" 
                                    data-field="{{ col.column_key }}"
                                    data-section="{{ section.section_key }}"
                                    rows="4">{{ col_value }}</textarea>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- 첨부파일 영역 (공통 컴포넌트) -->
    {% from 'includes/attachment_section.html' import render_attachment_section %}
    {{ render_attachment_section(attachments, 'accident') }}

    <!-- 저장 버튼 영역 -->
    <div class="save-section">
        <button class="btn-save" onclick="updateSafetyInstruction()">수정완료</button>
        <button class="btn-cancel" onclick="window.close()">취소</button>
    </div>
</div>

<!-- 스타일 -->
<link rel="stylesheet" href="/static/styles/accident-register.css">

<script>
// 섹션 정보
const sections = {{ sections | tojson | safe }};
const sectionColumns = {{ section_columns | tojson | safe }};
const issueNumber = "{{ instruction.accident_number }}";

// 섹션 토글
function toggleSection(sectionId) {
    const content = document.getElementById(sectionId + '-content');
    const icon = event.target;
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '▲';
    } else {
        content.style.display = 'none';
        icon.textContent = '▼';
    }
}

// 첨부파일 관련 변수와 함수는 공통 컴포넌트에서 제공됨

// 동적 필드 수집 함수
function collectDynamicFields() {
    const data = {};
    
    // 모든 섹션 순회
    sections.forEach(section => {
        const sectionInputs = document.querySelectorAll(`[data-section="${section.section_key}"]`);
        
        sectionInputs.forEach(input => {
            const fieldKey = input.dataset.field;
            let value = '';
            
            if (input.tagName === 'SELECT') {
                value = input.value;
            } else if (input.type === 'checkbox') {
                value = input.checked ? '1' : '0';
            } else if (input.tagName === 'TEXTAREA') {
                value = input.value;
            } else if (input.classList.contains('value')) {
                // 읽기 전용 div
                return;
            } else {
                value = input.value;
            }
            
            data[fieldKey] = value;
        });
    });
    
    return data;
}

// 수정 함수
function updateSafetyInstruction() {
    const formData = new FormData();
    
    // 발부번호
    formData.append('accident_number', issueNumber);
    
    // 동적 필드 수집
    const dynamicData = collectDynamicFields();
    
    // 각 필드를 FormData에 추가
    for (const [key, value] of Object.entries(dynamicData)) {
        formData.append(key, value);
    }
    
    // custom_data 처리
    const customData = {};
    const additionalColumns = sectionColumns['additional'] || [];
    
    // 새로 추가된 섹션의 데이터도 포함
    sections.forEach(section => {
        if (section.section_key !== 'basic_info' && 
            section.section_key !== 'accident_info') {
            const cols = sectionColumns[section.section_key] || [];
            cols.forEach(col => {
                if (dynamicData[col.column_key]) {
                    customData[col.column_key] = dynamicData[col.column_key];
                }
            });
        }
    });
    
    formData.append('custom_data', JSON.stringify(customData));
    
    // 새 첨부파일 처리 (공통 컴포넌트 변수 사용)
    if (typeof pendingFiles !== 'undefined') {
        pendingFiles.forEach((file, index) => {
            formData.append('files', file);
        });
    }
    
    // 삭제된 첨부파일 정보
    if (typeof deletedAttachments !== 'undefined') {
        formData.append('deleted_attachments', JSON.stringify(deletedAttachments));
    }
    
    // 첨부파일 설명 정보
    const attachmentDescriptions = [];
    document.querySelectorAll('.attachment-desc').forEach(input => {
        attachmentDescriptions.push(input.value);
    });
    formData.append('attachment_data', JSON.stringify(attachmentDescriptions));
    
    // 서버로 전송
    fetch('/update-accident', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('사고가 성공적으로 수정되었습니다.');
            if (window.opener) {
                window.opener.location.reload();
                window.close();
            } else {
                window.location.href = '/accident';
            }
        } else {
            alert('수정 실패: ' + (data.message || '알 수 없는 오류'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('수정 중 오류가 발생했습니다.');
    });
}

// 팝업 열기 함수
function openPopup(fieldKey) {
    // 팝업 구현 (필요시 추가)
    alert('팝업 기능은 추가 구현이 필요합니다.');
}
</script>

<style>
/* 추가 스타일 */
.info-cell textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 14px;
    resize: vertical;
}

.info-cell.span-2 {
    grid-column: span 2;
}

.info-cell.span-3 {
    grid-column: span 3;
}

.info-cell.span-4 {
    grid-column: span 4;
}

.info-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 16px;
}

.input-group {
    display: flex;
    gap: 4px;
}

.input-group input {
    flex: 1;
}

.input-group button {
    padding: 4px 8px;
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    cursor: pointer;
}

.input-group button:hover {
    background: #e5e7eb;
}

.btn-cancel {
    background: #6b7280;
    margin-left: 10px;
}

.btn-cancel:hover {
    background: #4b5563;
}
</style>

<!-- 공통 첨부파일 스크립트와 스타일 import -->
{% from 'includes/attachment_section.html' import attachment_scripts, attachment_styles %}
{{ attachment_styles() }}
{{ attachment_scripts() }}

{% endblock %}