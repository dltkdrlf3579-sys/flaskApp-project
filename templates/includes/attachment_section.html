<!-- ê³µí†µ ì²¨ë¶€íŒŒì¼ ì„¹ì…˜ í…œí”Œë¦¿ -->
{% macro render_attachment_section(attachments, board_type) %}
<div class="section attachments-section">
    <div class="section-header">
        <div class="attachments-header-left">
            <h3 class="section-title">ì²¨ë¶€íŒŒì¼</h3>
        </div>
        <div class="attachments-header-right">
            <button class="btn-add-file" onclick="document.getElementById('file-input').click();">ì¶”ê°€</button>
            <span class="file-count">ì´ <span id="file-count">{{ attachments|length if attachments else 0 }}</span>ê°œ</span>
            <span class="file-size"><span id="file-size">0</span> MB / 50 MB</span>
        </div>
    </div>
    <div class="section-content">
        <input type="file" id="file-input" multiple style="display: none;" onchange="handleFileUpload(this.files)">
        <div class="attachments-table">
            <div class="table-header">
                <div class="col-no">No.</div>
                <div class="col-file">íŒŒì¼ëª…</div>
                <div class="col-desc">ì„¤ëª…</div>
                <div class="col-action">ìƒíƒœ</div>
            </div>
            <div class="table-body" id="attachments-tbody">
                {% if attachments %}
                    {% for attachment in attachments %}
                    <div class="table-row" data-id="{{ attachment.id }}" data-board="{{ board_type }}">
                        <div class="col-no">{{ loop.index }}</div>
                        <div class="col-file">
                            <span class="file-icon">ğŸ“„</span>
                            <a href="/download/{{ attachment.id }}" class="file-link" download>{{ attachment.file_name }}</a>
                            <span class="file-size">({{ (attachment.file_size / 1024) | round(2) }} KB)</span>
                        </div>
                        <div class="col-desc">
                            <input type="text" class="attachment-desc" value="{{ attachment.description or '' }}" placeholder="ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <div class="col-action">
                            <button class="btn-delete" onclick="markFileForDeletion(this)" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="table-row no-data" id="no-data-row">
                        <div class="col-full">ë“±ë¡ëœ ì²¨ë¶€íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endmacro %}

<!-- ê³µí†µ ì²¨ë¶€íŒŒì¼ ìŠ¤íƒ€ì¼ -->
{% macro attachment_styles() %}
<style>
/* ì²¨ë¶€íŒŒì¼ ì„¹ì…˜ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
.attachments-section {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 20px;
}

.attachments-section .section-header {
    padding: 16px 20px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #f9fafb;
    border-radius: 8px 8px 0 0;
}

.attachments-section .section-title {
    font-size: 16px;
    font-weight: 600;
    color: #374151;
    margin: 0;
}

.btn-add-file {
    padding: 6px 12px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
}

.btn-add-file:hover {
    background: #218838;
}

.attachments-header-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.attachments-header-right {
    display: flex;
    align-items: center;
    gap: 15px;
    text-align: right;
}

.file-count, .file-size {
    font-size: 14px;
    color: #666;
}

.attachments-section .section-content {
    padding: 0;
}

.attachments-table {
    border: none;
    width: 100%;
}

.attachments-table .table-header {
    display: grid;
    grid-template-columns: 60px 1fr 2fr 100px;
    background: #f8f9fa;
    border-bottom: 1px solid #e1e5e9;
    font-weight: 600;
    font-size: 14px;
    color: #374151;
}

.attachments-table .table-header > div {
    padding: 12px 16px;
    border-right: 1px solid #e1e5e9;
    display: flex;
    align-items: center;
}

.attachments-table .table-header > div:last-child {
    border-right: none;
}

.attachments-table .table-body {
    max-height: 300px;
    overflow-y: auto;
}

.attachments-table .table-row {
    display: grid;
    grid-template-columns: 60px 1fr 2fr 100px;
    border-bottom: 1px solid #e1e5e9;
    background: white;
    transition: background 0.2s;
}

.attachments-table .table-row:hover {
    background: #f8f9fa;
}

.attachments-table .table-row > div {
    padding: 12px 16px;
    display: flex;
    align-items: center;
    border-right: 1px solid #e1e5e9;
}

.attachments-table .table-row > div:last-child {
    border-right: none;
}

.attachments-table .table-row.no-data {
    grid-template-columns: 1fr;
}

.attachments-table .col-full {
    text-align: center;
    color: #999;
    padding: 20px !important;
}

.attachments-table .file-icon {
    margin-right: 8px;
}

.attachments-table .attachment-desc {
    width: 100%;
    padding: 6px 10px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
}

.attachments-table .btn-delete {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    padding: 2px 6px;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.attachments-table .btn-delete:hover {
    opacity: 1;
}

.attachments-table .file-link {
    color: #2f5fd3;
    text-decoration: none;
    cursor: pointer;
}

.attachments-table .file-link:hover {
    text-decoration: underline;
}

.attachments-table .file-size {
    color: #666;
    font-size: 12px;
    margin-left: 5px;
}

.attachments-table .col-action {
    width: 60px;
    text-align: center;
}
</style>
{% endmacro %}

<!-- ê³µí†µ ì²¨ë¶€íŒŒì¼ JavaScript -->
{% macro attachment_scripts() %}
<script>
// ì „ì—­ ë³€ìˆ˜ - ì´ë¯¸ ì„ ì–¸ëœ ê²½ìš° ì¬ì‚¬ìš©
if (typeof pendingFiles === 'undefined') {
    window.pendingFiles = [];
}
if (typeof deletedAttachments === 'undefined') {
    window.deletedAttachments = [];
}

function handleFileUpload(files) {
    const tbody = document.getElementById('attachments-tbody');
    const noDataRow = document.getElementById('no-data-row');
    
    if (noDataRow) {
        noDataRow.remove();
    }
    
    Array.from(files).forEach((file, index) => {
        const newRow = document.createElement('div');
        newRow.className = 'table-row';
        newRow.dataset.isNew = 'true';
        
        const rowCount = document.querySelectorAll('#attachments-tbody .table-row:not(.no-data)').length + 1;
        const fileSize = `(${(file.size / 1024).toFixed(2)} KB)`;
        
        newRow.innerHTML = `
            <div class="col-no">${rowCount}</div>
            <div class="col-file">
                <span class="file-icon">ğŸ“„</span>
                <span class="file-link">${file.name}</span>
                <span class="file-size">${fileSize}</span>
            </div>
            <div class="col-desc">
                <input type="text" class="attachment-desc" placeholder="ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="col-action">
                <button class="btn-delete" onclick="removeNewFile(this, ${pendingFiles.length})" title="ì·¨ì†Œ">ğŸ—‘ï¸</button>
            </div>
        `;
        
        tbody.appendChild(newRow);
        pendingFiles.push(file);
    });
    
    updateFileCount();
    updateFileSize();
    document.getElementById('file-input').value = '';
}

function markFileForDeletion(button) {
    // ì²« ë²ˆì§¸ í™•ì¸: ì •ë§ ì‚­ì œí•  ê²ƒì¸ì§€
    if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        const row = button.closest('.table-row');
        const attachmentId = row.dataset.id;

        if (attachmentId && !row.dataset.isNew) {
            deletedAttachments.push(parseInt(attachmentId));
        }

        row.remove();
        updateRowNumbers();
        updateFileCount();

        // íŒŒì¼ì´ ëª¨ë‘ ì‚­ì œëœ ê²½ìš°
        const tbody = document.getElementById('attachments-tbody');
        if (tbody.children.length === 0) {
            tbody.innerHTML = '<div class="table-row no-data" id="no-data-row"><div class="col-full">ë“±ë¡ëœ ì²¨ë¶€íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div></div>';
        }

        // ë‘ ë²ˆì§¸ ì•Œë¦¼: ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ìµœì¢… ì‚­ì œë¨ì„ ì•ˆë‚´
        alert('ì‚­ì œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nìµœì¢…ì ìœ¼ë¡œ ì‚­ì œë¥¼ ì™„ë£Œí•˜ë ¤ë©´ "ìˆ˜ì •ì™„ë£Œ" ë˜ëŠ” "ë“±ë¡ì™„ë£Œ" ë²„íŠ¼ì„ í´ë¦­í•´ì£¼ì„¸ìš”.');
    }
}

function removeNewFile(button, fileIndex) {
    const row = button.closest('.table-row');
    pendingFiles.splice(fileIndex, 1);
    row.remove();
    updateRowNumbers();
    updateFileCount();
    
    const tbody = document.getElementById('attachments-tbody');
    if (tbody.children.length === 0) {
        tbody.innerHTML = '<div class="table-row no-data" id="no-data-row"><div class="col-full">ë“±ë¡ëœ ì²¨ë¶€íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div></div>';
    }
}

function updateFileCount() {
    const rows = document.querySelectorAll('#attachments-tbody .table-row:not(.no-data)');
    document.getElementById('file-count').textContent = rows.length;
}

function updateRowNumbers() {
    const rows = document.querySelectorAll('#attachments-tbody .table-row:not(.no-data)');
    rows.forEach((row, index) => {
        const noCell = row.querySelector('.col-no');
        if (noCell) {
            noCell.textContent = index + 1;
        }
    });
}

function updateFileSize() {
    const rows = document.querySelectorAll('#attachments-tbody .table-row:not(.no-data)');
    let totalSize = 0;
    
    // ê¸°ì¡´ íŒŒì¼ í¬ê¸° ê³„ì‚°
    rows.forEach(row => {
        const sizeText = row.querySelector('.file-size')?.textContent || '(0 KB)';
        const sizeMatch = sizeText.match(/\(([\d.]+)\s*KB\)/);
        if (sizeMatch) {
            totalSize += parseFloat(sizeMatch[1]) * 1024; // KB to bytes
        }
    });
    
    // ìƒˆë¡œ ì¶”ê°€ëœ íŒŒì¼ í¬ê¸°
    pendingFiles.forEach(file => {
        totalSize += file.size;
    });
    
    // MBë¡œ ë³€í™˜
    const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
    
    // UI ì—…ë°ì´íŠ¸
    const sizeElement = document.getElementById('file-size');
    if (sizeElement) {
        sizeElement.textContent = totalSizeMB;
    }
}

// í˜ì´ì§€ ë¡œë“œì‹œ íŒŒì¼ ê°œìˆ˜ì™€ í¬ê¸° ì—…ë°ì´íŠ¸
document.addEventListener('DOMContentLoaded', function() {
    updateFileCount();
    updateFileSize();
});
</script>
{% endmacro %}