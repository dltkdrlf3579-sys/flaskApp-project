<!-- 공통 첨부파일 섹션 템플릿 -->
{% macro render_attachment_section(attachments, board_type) %}
<div class="section attachments-section">
    <div class="section-header">
        <div class="attachments-header-left">
            <h3 class="section-title">첨부파일</h3>
        </div>
        <div class="attachments-header-right">
            <button class="btn-add-file" onclick="document.getElementById('file-input').click();">추가</button>
            <span class="file-count">총 <span id="file-count">{{ attachments|length if attachments else 0 }}</span>개</span>
            <span class="file-size"><span id="file-size">0</span> MB / 50 MB</span>
        </div>
    </div>
    <div class="section-content">
        <input type="file" id="file-input" multiple style="display: none;" onchange="handleFileUpload(this.files)">
        <div class="attachments-table">
            <div class="table-header">
                <div class="col-no">No.</div>
                <div class="col-file">파일명</div>
                <div class="col-desc">설명</div>
                <div class="col-action">상태</div>
            </div>
            <div class="table-body" id="attachments-tbody">
                {% if attachments %}
                    {% for attachment in attachments %}
                    <div class="table-row" data-id="{{ attachment.id }}" data-board="{{ board_type }}">
                        <div class="col-no">{{ loop.index }}</div>
                        <div class="col-file">
                            <span class="file-icon">📄</span>
                            <a href="/download/{{ attachment.id }}" class="file-link" download>{{ attachment.file_name }}</a>
                            <span class="file-size">({{ (attachment.file_size / 1024) | round(2) }} KB)</span>
                        </div>
                        <div class="col-desc">
                            <input type="text" class="attachment-desc" value="{{ attachment.description or '' }}" placeholder="설명을 입력하세요">
                        </div>
                        <div class="col-action">
                            <button class="btn-delete" onclick="markFileForDeletion(this)" title="삭제">🗑️</button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="table-row no-data" id="no-data-row">
                        <div class="col-full">등록된 첨부파일이 없습니다.</div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endmacro %}

<!-- 공통 첨부파일 스타일 -->
{% macro attachment_styles() %}
<style>
/* 첨부파일 섹션 기본 스타일 */
.attachments-section {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 20px;
}

.attachments-section .section-header {
    padding: 16px 20px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #f9fafb;
    border-radius: 8px 8px 0 0;
}

.attachments-section .section-title {
    font-size: 16px;
    font-weight: 600;
    color: #374151;
    margin: 0;
}

.btn-add-file {
    padding: 6px 12px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
}

.btn-add-file:hover {
    background: #218838;
}

.attachments-header-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.attachments-header-right {
    display: flex;
    align-items: center;
    gap: 15px;
    text-align: right;
}

.file-count, .file-size {
    font-size: 14px;
    color: #666;
}

.attachments-section .section-content {
    padding: 0;
}

.attachments-table {
    border: none;
    width: 100%;
}

.attachments-table .table-header {
    display: grid;
    grid-template-columns: 60px 1fr 2fr 100px;
    background: #f8f9fa;
    border-bottom: 1px solid #e1e5e9;
    font-weight: 600;
    font-size: 14px;
    color: #374151;
}

.attachments-table .table-header > div {
    padding: 12px 16px;
    border-right: 1px solid #e1e5e9;
    display: flex;
    align-items: center;
}

.attachments-table .table-header > div:last-child {
    border-right: none;
}

.attachments-table .table-body {
    max-height: 300px;
    overflow-y: auto;
}

.attachments-table .table-row {
    display: grid;
    grid-template-columns: 60px 1fr 2fr 100px;
    border-bottom: 1px solid #e1e5e9;
    background: white;
    transition: background 0.2s;
}

.attachments-table .table-row:hover {
    background: #f8f9fa;
}

.attachments-table .table-row > div {
    padding: 12px 16px;
    display: flex;
    align-items: center;
    border-right: 1px solid #e1e5e9;
}

.attachments-table .table-row > div:last-child {
    border-right: none;
}

.attachments-table .table-row.no-data {
    grid-template-columns: 1fr;
}

.attachments-table .col-full {
    text-align: center;
    color: #999;
    padding: 20px !important;
}

.attachments-table .file-icon {
    margin-right: 8px;
}

.attachments-table .attachment-desc {
    width: 100%;
    padding: 6px 10px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
}

.attachments-table .btn-delete {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    padding: 2px 6px;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.attachments-table .btn-delete:hover {
    opacity: 1;
}

.attachments-table .file-link {
    color: #2f5fd3;
    text-decoration: none;
    cursor: pointer;
}

.attachments-table .file-link:hover {
    text-decoration: underline;
}

.attachments-table .file-size {
    color: #666;
    font-size: 12px;
    margin-left: 5px;
}

.attachments-table .col-action {
    width: 60px;
    text-align: center;
}
</style>
{% endmacro %}

<!-- 공통 첨부파일 JavaScript -->
{% macro attachment_scripts() %}
<script>
// 전역 변수 - 이미 선언된 경우 재사용
if (typeof pendingFiles === 'undefined') {
    window.pendingFiles = [];
}
if (typeof deletedAttachments === 'undefined') {
    window.deletedAttachments = [];
}

function handleFileUpload(files) {
    const tbody = document.getElementById('attachments-tbody');
    const noDataRow = document.getElementById('no-data-row');
    
    if (noDataRow) {
        noDataRow.remove();
    }
    
    Array.from(files).forEach((file, index) => {
        const newRow = document.createElement('div');
        newRow.className = 'table-row';
        newRow.dataset.isNew = 'true';
        
        const rowCount = document.querySelectorAll('#attachments-tbody .table-row:not(.no-data)').length + 1;
        const fileSize = `(${(file.size / 1024).toFixed(2)} KB)`;
        
        newRow.innerHTML = `
            <div class="col-no">${rowCount}</div>
            <div class="col-file">
                <span class="file-icon">📄</span>
                <span class="file-link">${file.name}</span>
                <span class="file-size">${fileSize}</span>
            </div>
            <div class="col-desc">
                <input type="text" class="attachment-desc" placeholder="설명을 입력하세요">
            </div>
            <div class="col-action">
                <button class="btn-delete" onclick="removeNewFile(this, ${pendingFiles.length})" title="취소">🗑️</button>
            </div>
        `;
        
        tbody.appendChild(newRow);
        pendingFiles.push(file);
    });
    
    updateFileCount();
    updateFileSize();
    document.getElementById('file-input').value = '';
}

function markFileForDeletion(button) {
    // 첫 번째 확인: 정말 삭제할 것인지
    if (confirm('정말 삭제하시겠습니까?')) {
        const row = button.closest('.table-row');
        const attachmentId = row.dataset.id;

        if (attachmentId && !row.dataset.isNew) {
            deletedAttachments.push(parseInt(attachmentId));
        }

        row.remove();
        updateRowNumbers();
        updateFileCount();

        // 파일이 모두 삭제된 경우
        const tbody = document.getElementById('attachments-tbody');
        if (tbody.children.length === 0) {
            tbody.innerHTML = '<div class="table-row no-data" id="no-data-row"><div class="col-full">등록된 첨부파일이 없습니다.</div></div>';
        }

        // 두 번째 알림: 저장 버튼을 눌러야 최종 삭제됨을 안내
        alert('삭제 처리되었습니다.\n\n최종적으로 삭제를 완료하려면 "수정완료" 또는 "등록완료" 버튼을 클릭해주세요.');
    }
}

function removeNewFile(button, fileIndex) {
    const row = button.closest('.table-row');
    pendingFiles.splice(fileIndex, 1);
    row.remove();
    updateRowNumbers();
    updateFileCount();
    
    const tbody = document.getElementById('attachments-tbody');
    if (tbody.children.length === 0) {
        tbody.innerHTML = '<div class="table-row no-data" id="no-data-row"><div class="col-full">등록된 첨부파일이 없습니다.</div></div>';
    }
}

function updateFileCount() {
    const rows = document.querySelectorAll('#attachments-tbody .table-row:not(.no-data)');
    document.getElementById('file-count').textContent = rows.length;
}

function updateRowNumbers() {
    const rows = document.querySelectorAll('#attachments-tbody .table-row:not(.no-data)');
    rows.forEach((row, index) => {
        const noCell = row.querySelector('.col-no');
        if (noCell) {
            noCell.textContent = index + 1;
        }
    });
}

function updateFileSize() {
    const rows = document.querySelectorAll('#attachments-tbody .table-row:not(.no-data)');
    let totalSize = 0;
    
    // 기존 파일 크기 계산
    rows.forEach(row => {
        const sizeText = row.querySelector('.file-size')?.textContent || '(0 KB)';
        const sizeMatch = sizeText.match(/\(([\d.]+)\s*KB\)/);
        if (sizeMatch) {
            totalSize += parseFloat(sizeMatch[1]) * 1024; // KB to bytes
        }
    });
    
    // 새로 추가된 파일 크기
    pendingFiles.forEach(file => {
        totalSize += file.size;
    });
    
    // MB로 변환
    const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
    
    // UI 업데이트
    const sizeElement = document.getElementById('file-size');
    if (sizeElement) {
        sizeElement.textContent = totalSizeMB;
    }
}

// 페이지 로드시 파일 개수와 크기 업데이트
document.addEventListener('DOMContentLoaded', function() {
    updateFileCount();
    updateFileSize();
});
</script>
{% endmacro %}