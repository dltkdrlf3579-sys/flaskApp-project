{# ë¦¬ìŠ¤íŠ¸ í•„ë“œ - V3 (CSS ê·¸ë¦¬ë“œ í˜¸í™˜) #}

{% macro render_list_field(col, col_value, section, mode='view') %}
{% if col.column_type == 'list' %}
    {# ë¦¬ìŠ¤íŠ¸ ìœ í˜• ê²°ì •: ê¸°ë³¸ì€ í˜‘ë ¥ì‚¬ ê·¼ë¡œì, input_typeì´ 'list_company'ì´ë©´ ì—…ì²´ ë¦¬ìŠ¤íŠ¸ #}
    {% set _list_input_type = (col.input_type or col.list_item_type or '') %}
    {% if _list_input_type == 'list_company' or _list_input_type == 'company' %}
        {% set list_type = 'company' %}
    {% else %}
        {% set list_type = 'partner_worker' %}
    {% endif %}
    {% if col_value %}
        {% if col_value is string %}
            {% set list_data = [] %}
            <!-- ë¬¸ìì—´ì„ JavaScriptì—ì„œ íŒŒì‹± -->
        {% else %}
            {% set list_data = col_value %}
        {% endif %}
    {% else %}
        {% set list_data = [] %}
    {% endif %}
    
    <!-- ë¦¬ìŠ¤íŠ¸ í•„ë“œ ì „ì²´ ì»¨í…Œì´ë„ˆ -->
    <div class="list-field-container-{{ col.column_key }}">
        <!-- DEBUG: í•„ë“œ ì •ë³´ í™•ì¸ ë° ë°ì´í„° ì„¤ì • -->
        <script>
            // ì´ˆê¸° ë°ì´í„°ë¥¼ JavaScript ë³€ìˆ˜ë¡œ ì„¤ì •
            var {{ col.column_key }}_initialData = {{ col_value | tojson | safe if col_value else '[]' }};
            
            console.log('ğŸ—ï¸ ë¦¬ìŠ¤íŠ¸ í•„ë“œ ìƒì„±:', {
                column_key: '{{ col.column_key }}',
                section_key: '{{ section.section_key }}',
                col_value_type: '{{ col_value.__class__.__name__ if col_value else "None" }}',
                col_value_length: {{ col_value|length if col_value else 0 }},
                col_value: {{ col.column_key }}_initialData
            });
            
            // DOM ë¡œë“œ í›„ hidden inputì— ê°’ ì„¤ì •
            document.addEventListener('DOMContentLoaded', function() {
                var hiddenInput = document.getElementById('{{ col.column_key }}');
                if (hiddenInput && {{ col.column_key }}_initialData) {
                    hiddenInput.value = JSON.stringify({{ col.column_key }}_initialData);
                    console.log('ğŸ”§ {{ col.column_key }} hidden input ì´ˆê¸°ê°’ ì„¤ì • ì™„ë£Œ:', hiddenInput.value.length, 'ë¬¸ì');
                }
            });
        </script>
        
        <!-- Hidden input for data storage -->
        <input type="hidden" 
               id="{{ col.column_key }}" 
               name="{{ col.column_key }}"
               class="{{ section.section_key }}-input" 
               data-field="{{ col.column_key }}"
               data-field-type="list"
               data-section="{{ section.section_key }}">
        
        <!-- ì œëª©ê³¼ ì¶”ê°€ ë²„íŠ¼ -->
        <div class="list-field-header-{{ col.column_key }}">
            <h6 class="list-field-title-{{ col.column_key }}">{{ col.column_name }}</h6>
            {% if mode == 'edit' or mode == 'register' %}
            <button type="button" 
                    class="list-field-add-btn-{{ col.column_key }}"
                    onclick="addWorker_{{ col.column_key }}()">
                {% if list_type == 'company' %}+ ì—…ì²´ ì¶”ê°€{% else %}+ í˜‘ë ¥ì‚¬ ê·¼ë¡œì ì¶”ê°€{% endif %}
            </button>
            {% endif %}
        </div>
        
        <!-- ë°ì´í„° í…Œì´ë¸” -->
        <div class="list-field-table-wrapper-{{ col.column_key }}">
            <table class="list-field-table-{{ col.column_key }}">
                <thead>
                    <tr>
                        <th>No.</th>
                        {% if list_type == 'company' %}
                            <th>ì—…ì²´</th>
                            <th>ì‚¬ì—…ìë²ˆí˜¸</th>
                            {% if mode == 'edit' or mode == 'register' %}
                            <th>ê´€ë¦¬</th>
                            {% endif %}
                        {% else %}
                            <th>ì„±í•¨</th>
                            <th>ID</th>
                            <th>ì†Œì†ì—…ì²´</th>
                            <th>ì‚¬ì—…ìë²ˆí˜¸</th>
                            {% if mode == 'edit' or mode == 'register' %}
                            <th>ê´€ë¦¬</th>
                            {% endif %}
                        {% endif %}
                    </tr>
                </thead>
                <tbody id="{{ col.column_key }}_tbody">
                    {% if list_data and list_data|length > 0 %}
                        {% for item in list_data %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            {% if list_type == 'company' %}
                                <td>{{ item.name or '-' }}</td>
                                <td>{{ item.bizno or '-' }}</td>
                            {% else %}
                                <td>{{ item.name or '-' }}</td>
                                <td>{{ item.id or '-' }}</td>
                                <td>{{ item.company or '-' }}</td>
                                <td>{{ item.bizno or '-' }}</td>
                            {% endif %}
                            {% if mode == 'edit' or mode == 'register' %}
                            <td>
                                <button type="button" 
                                        class="list-field-remove-btn-{{ col.column_key }}"
                                        onclick="removeItem_{{ col.column_key }}({{ loop.index0 }})">
                                    ì‚­ì œ
                                </button>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr id="{{ col.column_key }}_empty_row">
                            <td colspan="{% if list_type == 'company' %}{% if mode == 'edit' or mode == 'register' %}4{% else %}3{% endif %}{% else %}{% if mode == 'edit' or mode == 'register' %}6{% else %}5{% endif %}{% endif %}">
                                {% if list_type == 'company' %}ë“±ë¡ëœ ì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤.{% else %}ë“±ë¡ëœ í˜‘ë ¥ì‚¬ ê·¼ë¡œìê°€ ì—†ìŠµë‹ˆë‹¤.{% endif %}
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        <!-- ì´ ì¸ì›ìˆ˜ -->
        <div class="list-field-count-{{ col.column_key }}">
            ì´ <span id="{{ col.column_key }}_count">{{ list_data|length if list_data else 0 }}</span>{% if list_type == 'company' %}ê°œ{% else %}ëª…{% endif %}
        </div>
    </div>
    
    <style>
    /* ë¦¬ìŠ¤íŠ¸ í•„ë“œ ì»¨í…Œì´ë„ˆ - ê·¸ë¦¬ë“œ í˜¸í™˜ */
    .list-field-container-{{ col.column_key }} {
        grid-column: 1 / -1; /* ì „ì²´ ê·¸ë¦¬ë“œ ì—´ ì‚¬ìš© */
        margin: 20px 0;
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    /* í—¤ë” */
    .list-field-header-{{ col.column_key }} {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 1px solid #dee2e6;
    }
    
    .list-field-title-{{ col.column_key }} {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: #495057;
    }
    
    .list-field-add-btn-{{ col.column_key }} {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0,123,255,0.2);
    }
    
    .list-field-add-btn-{{ col.column_key }}:hover {
        background: #0056b3;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,123,255,0.3);
    }
    
    /* í…Œì´ë¸” ë˜í¼ */
    .list-field-table-wrapper-{{ col.column_key }} {
        overflow-x: auto;
        max-width: 100%;
    }
    
    /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
    .list-field-table-{{ col.column_key }} {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed; /* ê³ ì • ë ˆì´ì•„ì›ƒìœ¼ë¡œ ì»¬ëŸ¼ ë„ˆë¹„ ê°•ì œ ê³ ì • */
        min-width: 800px; /* ìµœì†Œ ë„ˆë¹„ */
    }
    
    .list-field-table-{{ col.column_key }} th {
        background: #f1f3f4;
        padding: 12px 10px;
        text-align: left;
        font-size: 14px;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        white-space: nowrap;
    }
    
    .list-field-table-{{ col.column_key }} th:nth-child(1) { width: 8%; text-align: center; min-width: 50px; } /* No. */
    .list-field-table-{{ col.column_key }} th:nth-child(2) { width: 100px !important; min-width: 100px !important; } /* ì„±í•¨ */
    .list-field-table-{{ col.column_key }} th:nth-child(3) { width: 17%; min-width: 100px; } /* ID */
    .list-field-table-{{ col.column_key }} th:nth-child(4) { width: 40%; min-width: 200px; } /* ì†Œì†ì—…ì²´ */
    .list-field-table-{{ col.column_key }} th:nth-child(5) { width: 140px !important; min-width: 140px !important; } /* ì‚¬ì—…ìë²ˆí˜¸ */
    .list-field-table-{{ col.column_key }} th:nth-child(6) { width: 5%; text-align: center; min-width: 60px; } /* ê´€ë¦¬ */
    
    .list-field-table-{{ col.column_key }} td {
        padding: 12px 8px;
        font-size: 14px;
        color: #495057;
        border-bottom: 1px solid #e9ecef;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .list-field-table-{{ col.column_key }} td:nth-child(1) {
        width: 8%; text-align: center; min-width: 50px;
        font-weight: 600;
    }
    
    .list-field-table-{{ col.column_key }} td:nth-child(2) {
        width: 100px !important; min-width: 100px !important; max-width: 100px;
        overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    
    .list-field-table-{{ col.column_key }} td:nth-child(3) {
        width: 17%; min-width: 100px; max-width: 120px;
        overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    
    .list-field-table-{{ col.column_key }} td:nth-child(4) {
        width: 40%; min-width: 200px; max-width: 300px;
        overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    
    .list-field-table-{{ col.column_key }} td:nth-child(5) {
        width: 140px !important; min-width: 140px !important; max-width: 140px;
        overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    
    .list-field-table-{{ col.column_key }} td:nth-child(6) {
        width: 5%; text-align: center; min-width: 60px;
    }
    
    .list-field-table-{{ col.column_key }} tbody tr:hover {
        background: #f8f9fa;
    }
    
    .list-field-table-{{ col.column_key }} tbody tr:nth-child(even) {
        background: #fdfdfd;
    }
    
    .list-field-table-{{ col.column_key }} tbody tr:nth-child(even):hover {
        background: #f8f9fa;
    }
    
    /* ì‚­ì œ ë²„íŠ¼ */
    .list-field-remove-btn-{{ col.column_key }} {
        background: #dc3545;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .list-field-remove-btn-{{ col.column_key }}:hover {
        background: #c82333;
        transform: scale(1.05);
    }
    
    /* ë¹ˆ ìƒíƒœ */
    .list-field-table-{{ col.column_key }} #{{ col.column_key }}_empty_row td {
        text-align: center;
        padding: 40px;
        color: #6c757d;
        font-style: italic;
        background: #f8f9fa;
    }
    
    /* ì¹´ìš´íŠ¸ */
    .list-field-count-{{ col.column_key }} {
        padding: 10px 20px;
        font-size: 14px;
        color: #6c757d;
        background: #f8f9fa;
        border-top: 1px solid #e9ecef;
        text-align: right;
    }
    
    .list-field-count-{{ col.column_key }} span {
        font-weight: 600;
        color: #007bff;
    }
    </style>
    
    <script>
    (function() {
        // ë¡œì»¬ ìŠ¤ì½”í”„ë¡œ ê²©ë¦¬
        var {{ col.column_key }}_data = [];

        // ë Œë”ë§ í•¨ìˆ˜ë¥¼ ë¨¼ì € ì •ì˜
        function renderTable_{{ col.column_key }}() {
            var tbody = document.getElementById('{{ col.column_key }}_tbody');
            var html = '';
            
            if ({{ col.column_key }}_data.length === 0) {
                html = '<tr id="{{ col.column_key }}_empty_row">' +
                       '<td colspan="{% if list_type == "company" %}{% if mode == "edit" or mode == "register" %}4{% else %}3{% endif %}{% else %}{% if mode == "edit" or mode == "register" %}6{% else %}5{% endif %}{% endif %}">'
                       + ({% if list_type == 'company' %}'ë“±ë¡ëœ ì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤.'{% else %}'ë“±ë¡ëœ í˜‘ë ¥ì‚¬ ê·¼ë¡œìê°€ ì—†ìŠµë‹ˆë‹¤.'{% endif %})
                       + '</td></tr>';
            } else {
                {{ col.column_key }}_data.forEach(function(item, index) {
                    html += '<tr>' +
                           '<td>' + (index + 1) + '</td>' +
                           {% if list_type == 'company' %}
                           '<td>' + (item.name || '-') + '</td>' +
                           '<td>' + (item.bizno || '-') + '</td>' +
                           {% else %}
                           '<td>' + (item.name || '-') + '</td>' +
                           '<td>' + (item.id || '-') + '</td>' +
                           '<td>' + (item.company || '-') + '</td>' +
                           '<td>' + (item.bizno || '-') + '</td>' +
                           {% endif %}
                           {% if mode == 'edit' or mode == 'register' %}
                           '<td>' +
                           '<button type="button" class="list-field-remove-btn-{{ col.column_key }}" ' +
                           'onclick="removeItem_{{ col.column_key }}(' + index + ')">ì‚­ì œ</button>' +
                           '</td>' +
                           {% endif %}
                           '</tr>';
                });
            }
            
            tbody.innerHTML = html;
            
            // Update count
            document.getElementById('{{ col.column_key }}_count').textContent = {{ col.column_key }}_data.length;
            
            // Update hidden input - ì¤‘ìš”! ì „ì²´ ë°ì´í„°ë¥¼ í™•ì‹¤íˆ ì €ì¥
            var jsonData = JSON.stringify({{ col.column_key }}_data);
            var hiddenInput = document.getElementById('{{ col.column_key }}');
            if (hiddenInput) {
                hiddenInput.value = jsonData;
                console.log('{{ col.column_key }} hidden input ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                console.log('  - ë°ì´í„° ê°œìˆ˜:', {{ col.column_key }}_data.length);
                console.log('  - JSON ê¸¸ì´:', jsonData.length);
                console.log('  - hidden input value í™•ì¸:', hiddenInput.value.length, 'ë¬¸ì');
                
                // ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦
                try {
                    var verifyData = JSON.parse(hiddenInput.value);
                    if (verifyData.length !== {{ col.column_key }}_data.length) {
                        console.error('{{ col.column_key }} ë°ì´í„° ë¬´ê²°ì„± ì˜¤ë¥˜! ë©”ëª¨ë¦¬:', {{ col.column_key }}_data.length, ', hidden:', verifyData.length);
                    } else {
                        console.log('{{ col.column_key }} ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦ í†µê³¼');
                    }
                } catch(e) {
                    console.error('{{ col.column_key }} ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦ ì‹¤íŒ¨:', e);
                }
            } else {
                console.error('{{ col.column_key }} hidden inputì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
            }
        }
        
        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ - JavaScript ë³€ìˆ˜ ì‚¬ìš©
        function loadInitialData_{{ col.column_key }}() {
            console.log('ğŸ”„ {{ col.column_key }} ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì‹œì‘');
            try {
                // JavaScript ë³€ìˆ˜ì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ê¸° (HTML íŒŒì‹± ë¬¸ì œ í•´ê²°)
                if (typeof {{ col.column_key }}_initialData !== 'undefined' && Array.isArray({{ col.column_key }}_initialData)) {
                    {{ col.column_key }}_data = [...{{ col.column_key }}_initialData];  // ë³µì‚¬ë³¸ ìƒì„±
                    console.log('âœ… {{ col.column_key }} JavaScript ë³€ìˆ˜ì—ì„œ ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì„±ê³µ');
                    console.log('ğŸ“Š {{ col.column_key }} ì´ˆê¸° ë°ì´í„°:', {{ col.column_key }}_data);
                    console.log('ğŸ“ {{ col.column_key }} ì´ˆê¸° ë°ì´í„° ê¸¸ì´:', {{ col.column_key }}_data.length);
                    
                    // í•­ìƒ í…Œì´ë¸” ë Œë”ë§í•˜ì—¬ ë°ì´í„° ë™ê¸°í™”
                    console.log('ğŸ”„ {{ col.column_key }} ì´ˆê¸° ë°ì´í„°ë¡œ í…Œì´ë¸” ë Œë”ë§ ì‹œì‘ (ë°ì´í„°:', {{ col.column_key }}_data.length, 'ê°œ)');
                    renderTable_{{ col.column_key }}();
                } else {
                    console.log('âš ï¸ {{ col.column_key }} ì´ˆê¸° ë°ì´í„° ì—†ìŒ ë˜ëŠ” ìœ íš¨í•˜ì§€ ì•ŠìŒ');
                    // ê¸°ì¡´ ë©”ëª¨ë¦¬ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìœ ì§€, ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”
                    if (!{{ col.column_key }}_data) {
                        {{ col.column_key }}_data = [];
                        console.log('ğŸ†• {{ col.column_key }} ë©”ëª¨ë¦¬ ë°ì´í„° ìƒˆë¡œ ì´ˆê¸°í™”');
                    } else {
                        console.log('ğŸ’¾ {{ col.column_key }} ê¸°ì¡´ ë©”ëª¨ë¦¬ ë°ì´í„° ìœ ì§€:', {{ col.column_key }}_data.length, 'ê°œ í•­ëª©');
                    }
                }
            } catch(e) {
                console.error('âŒ {{ col.column_key }} ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ê¸°ì¡´ ë©”ëª¨ë¦¬ ë°ì´í„° ìœ ì§€
                if (!{{ col.column_key }}_data) {
                    {{ col.column_key }}_data = [];
                    console.log('ğŸ› ï¸ {{ col.column_key }} ì˜¤ë¥˜ë¡œ ì¸í•œ ë©”ëª¨ë¦¬ ë°ì´í„° ìƒˆë¡œ ì´ˆê¸°í™”');
                } else {
                    console.log('ğŸ›¡ï¸ {{ col.column_key }} ì˜¤ë¥˜ ìƒí™©ì—ì„œë„ ê¸°ì¡´ ë©”ëª¨ë¦¬ ë°ì´í„° ìœ ì§€');
                }
            }
        }
        
        // DOMì´ ì™„ì „íˆ ë¡œë“œëœ í›„ ì´ˆê¸° ë°ì´í„° ë¡œë“œ - ë” ì•ˆì „í•˜ê²Œ
        function safeInitialize_{{ col.column_key }}() {
            // ì—¬ëŸ¬ ë²ˆ ì‹œë„í•˜ì—¬ ì•ˆì „í•˜ê²Œ ì´ˆê¸°í™”
            var retryCount = 0;
            var maxRetries = 5;
            
            function attemptLoad() {
                try {
                    var hiddenInput = document.getElementById('{{ col.column_key }}');
                    if (!hiddenInput) {
                        if (retryCount < maxRetries) {
                            retryCount++;
                            console.log('{{ col.column_key }} hidden input ì°¾ê¸° ì¬ì‹œë„:', retryCount);
                            setTimeout(attemptLoad, 100);
                            return;
                        } else {
                            console.error('{{ col.column_key }} hidden inputì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (ìµœëŒ€ ì¬ì‹œë„ ì´ˆê³¼)');
                            return;
                        }
                    }
                    
                    loadInitialData_{{ col.column_key }}();
                } catch(e) {
                    console.error('{{ col.column_key }} ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
                    if (retryCount < maxRetries) {
                        retryCount++;
                        setTimeout(attemptLoad, 100);
                    }
                }
            }
            
            attemptLoad();
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', safeInitialize_{{ col.column_key }});
        } else if (document.readyState === 'interactive' || document.readyState === 'complete') {
            safeInitialize_{{ col.column_key }}();
        } else {
            // ìµœí›„ì˜ ìˆ˜ë‹¨
            window.addEventListener('load', safeInitialize_{{ col.column_key }});
        }
        
        // í˜„ì¬ ë°ì´í„°ë¥¼ í•­ìƒ ë™ê¸°í™”í•˜ëŠ” í•¨ìˆ˜
        function syncData_{{ col.column_key }}() {
            var hiddenInput = document.getElementById('{{ col.column_key }}');
            if (!hiddenInput) return;
            
            var currentValue = hiddenInput.value;
            if (currentValue && currentValue !== '[]') {
                try {
                    var parsedData = JSON.parse(currentValue);
                    if (Array.isArray(parsedData)) {
                        {{ col.column_key }}_data = parsedData;
                        console.log('{{ col.column_key }} ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ:', {{ col.column_key }}_data.length, 'ê°œ í•­ëª©');
                        return true;
                    }
                } catch(e) {
                    console.error('{{ col.column_key }} ë°ì´í„° ë™ê¸°í™” ì‹¤íŒ¨:', e);
                }
            }
            return false;
        }

        // ë°”ë¡œ ê²€ìƒ‰ íŒì—… ë„ìš°ê¸°
        window.addWorker_{{ col.column_key }} = function() {
            console.log('ğŸš€ {{ col.column_key }} íŒì—… ì—´ê¸° ì‹œì‘');
            console.log('ğŸ“Š {{ col.column_key }} íŒì—… ì—´ê¸° ì „ ë©”ëª¨ë¦¬ ë°ì´í„°:', {
                length: {{ col.column_key }}_data ? {{ col.column_key }}_data.length : 0,
                data: {{ col.column_key }}_data
            });
            
            // hidden input í˜„ì¬ ê°’ í™•ì¸ (ë™ê¸°í™”ëŠ” í•˜ì§€ ì•ŠìŒ)
            var hiddenInput = document.getElementById('{{ col.column_key }}');
            if (hiddenInput) {
                console.log('ğŸ’¾ {{ col.column_key }} hidden input í˜„ì¬ ê°’:', hiddenInput.value);
                console.log('ğŸ’¾ {{ col.column_key }} hidden input ê¸¸ì´:', hiddenInput.value ? hiddenInput.value.length : 0);
            }
            
            // ë™ê¸°í™”ëŠ” í•˜ì§€ ì•Šê³  í˜„ì¬ ë©”ëª¨ë¦¬ ë°ì´í„° ì‹ ë¢°
            console.log('âœ… {{ col.column_key }} í˜„ì¬ ë©”ëª¨ë¦¬ ë°ì´í„°ë¥¼ ì‹ ë¢°í•˜ê³  íŒì—… ì§„í–‰');
            console.log('ğŸ“‹ {{ col.column_key }} ìµœì¢… í™•ì¸ - í˜„ì¬ ë°ì´í„°:', {{ col.column_key }}_data.length, 'ê°œ í•­ëª©');
            
            var callbackName = 'workerCallback_{{ col.column_key }}_' + Date.now();
            console.log('{{ col.column_key }} ê²€ìƒ‰ íŒì—… ì—´ê¸°');
            console.log('í˜„ì¬ {{ col.column_key }}_data:', {{ col.column_key }}_data);
            console.log('í˜„ì¬ {{ col.column_key }}_data ê¸¸ì´:', {{ col.column_key }}_data.length);
            
            window[callbackName] = function(data) {
                console.log('ğŸ¯ {{ col.column_key }} íŒì—…ì—ì„œ ì„ íƒëœ ë°ì´í„°:', data);
                console.log('ğŸ” {{ col.column_key }} ì½œë°± ì‹¤í–‰ ì „ ê¸°ì¡´ ë°ì´í„° ìƒíƒœ:', {
                    length: {{ col.column_key }}_data.length,
                    items: {{ col.column_key }}_data
                });
                
                // ì¤‘ë³µ ì²´í¬
                var isDuplicate = (function(){
                    var t = '{{ list_type }}';
                    if (t === 'company') {
                        return {{ col.column_key }}_data.some(function(item){ return item.bizno && data.business_number && String(item.bizno) === String(data.business_number); });
                    }
                    return {{ col.column_key }}_data.some(function(item){ return item.id && data.worker_id && String(item.id) === String(data.worker_id); });
                })();
                
                if (isDuplicate) {
                    alert('ì´ë¯¸ ì¶”ê°€ëœ ê·¼ë¡œìì…ë‹ˆë‹¤.');
                    delete window[callbackName];
                    return;
                }
                
                console.log('âœ… {{ col.column_key }} ì¤‘ë³µ ì²´í¬ í†µê³¼, ìƒˆ í•­ëª© ì¶”ê°€ ì§„í–‰');
                
                // ë°ì´í„° ì¶”ê°€
                var newItem;
                if ('{{ list_type }}' === 'company') {
                    newItem = {
                        name: data.company_name || '',
                        id: '',
                        company: '',
                        bizno: data.business_number || ''
                    };
                } else {
                    newItem = {
                        name: data.worker_name || data.name || '',
                        id: data.worker_id || data.id || '',
                        company: data.company_name || '',
                        bizno: data.business_number || ''
                    };
                }
                
                console.log('ğŸ“ {{ col.column_key }} ì¶”ê°€í•  ìƒˆ í•­ëª©:', newItem);
                {{ col.column_key }}_data.push(newItem);
                
                console.log('âœ… {{ col.column_key }} ì¶”ê°€ ì™„ë£Œ! ìµœì¢… ë°ì´í„°:', {{ col.column_key }}_data);
                console.log('ğŸ“Š {{ col.column_key }} ìµœì¢… ë°ì´í„° ê¸¸ì´:', {{ col.column_key }}_data.length);
                console.log('ğŸ”„ {{ col.column_key }} í…Œì´ë¸” ë Œë”ë§ ì‹œì‘');
                
                renderTable_{{ col.column_key }}();
                
                console.log('ğŸ’¾ {{ col.column_key }} hidden input ê°’ í™•ì¸:', document.getElementById('{{ col.column_key }}').value);
                
                delete window[callbackName];
            };
            
            // ê²€ìƒ‰ íŒì—… ì—´ê¸°
            var searchType = ('{{ list_type }}' === 'company') ? 'company' : 'contractor';
            window.open('/search-popup?type=' + searchType + '&callback=' + callbackName, 
                       'workerPopup', 'width=900,height=600,scrollbars=yes');
        };
        
        // removeItem í•¨ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
        window.removeItem_{{ col.column_key }} = function(index) {
            console.log('{{ col.column_key }} ì‚­ì œ ì¸ë±ìŠ¤:', index);
            {{ col.column_key }}_data.splice(index, 1);
            console.log('{{ col.column_key }} ì‚­ì œ í›„ ë°ì´í„°:', {{ col.column_key }}_data);
            renderTable_{{ col.column_key }}();
        };
    })();
    </script>
{% endif %}
{% endmacro %}
