{# 리스트 필드 - V3 (CSS 그리드 호환) #}

{% macro render_list_field(col, col_value, section, mode='view') %}
{% if col.column_type == 'list' %}
    {# 리스트 유형 결정: 기본은 협력사 근로자, input_type이 'list_company'이면 업체 리스트 #}
    {% set _list_input_type = (col.input_type or col.list_item_type or '') %}
    {% if _list_input_type == 'list_company' or _list_input_type == 'company' %}
        {% set list_type = 'company' %}
    {% else %}
        {% set list_type = 'partner_worker' %}
    {% endif %}
    {% if col_value %}
        {% if col_value is string %}
            {% set list_data = [] %}
            <!-- 문자열을 JavaScript에서 파싱 -->
        {% else %}
            {% set list_data = col_value %}
        {% endif %}
    {% else %}
        {% set list_data = [] %}
    {% endif %}
    
    <!-- 리스트 필드 전체 컨테이너 -->
    <div class="list-field-container-{{ col.column_key }}">
        <!-- DEBUG: 필드 정보 확인 및 데이터 설정 -->
        <script>
            // 초기 데이터를 JavaScript 변수로 설정
            var {{ col.column_key }}_initialData = {{ col_value | tojson | safe if col_value else '[]' }};
            
            console.log('🏗️ 리스트 필드 생성:', {
                column_key: '{{ col.column_key }}',
                section_key: '{{ section.section_key }}',
                col_value_type: '{{ col_value.__class__.__name__ if col_value else "None" }}',
                col_value_length: {{ col_value|length if col_value else 0 }},
                col_value: {{ col.column_key }}_initialData
            });
            
            // DOM 로드 후 hidden input에 값 설정
            document.addEventListener('DOMContentLoaded', function() {
                var hiddenInput = document.getElementById('{{ col.column_key }}');
                if (hiddenInput && {{ col.column_key }}_initialData) {
                    hiddenInput.value = JSON.stringify({{ col.column_key }}_initialData);
                    console.log('🔧 {{ col.column_key }} hidden input 초기값 설정 완료:', hiddenInput.value.length, '문자');
                }
            });
        </script>
        
        <!-- Hidden input for data storage -->
        <input type="hidden" 
               id="{{ col.column_key }}" 
               name="{{ col.column_key }}"
               class="{{ section.section_key }}-input" 
               data-field="{{ col.column_key }}"
               data-field-type="list"
               data-section="{{ section.section_key }}">
        
        <!-- 제목과 추가 버튼 -->
        <div class="list-field-header-{{ col.column_key }}">
            <h6 class="list-field-title-{{ col.column_key }}">{{ col.column_name }}</h6>
            {% if mode == 'edit' or mode == 'register' %}
            <button type="button" 
                    class="list-field-add-btn-{{ col.column_key }}"
                    onclick="addWorker_{{ col.column_key }}()">
                {% if list_type == 'company' %}+ 업체 추가{% else %}+ 협력사 근로자 추가{% endif %}
            </button>
            {% endif %}
        </div>
        
        <!-- 데이터 테이블 -->
        <div class="list-field-table-wrapper-{{ col.column_key }}">
            <table class="list-field-table-{{ col.column_key }}">
                <thead>
                    <tr>
                        <th>No.</th>
                        {% if list_type == 'company' %}
                            <th>업체</th>
                            <th>사업자번호</th>
                            {% if mode == 'edit' or mode == 'register' %}
                            <th>관리</th>
                            {% endif %}
                        {% else %}
                            <th>성함</th>
                            <th>ID</th>
                            <th>소속업체</th>
                            <th>사업자번호</th>
                            {% if mode == 'edit' or mode == 'register' %}
                            <th>관리</th>
                            {% endif %}
                        {% endif %}
                    </tr>
                </thead>
                <tbody id="{{ col.column_key }}_tbody">
                    {% if list_data and list_data|length > 0 %}
                        {% for item in list_data %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            {% if list_type == 'company' %}
                                <td>{{ item.name or '-' }}</td>
                                <td>{{ item.bizno or '-' }}</td>
                            {% else %}
                                <td>{{ item.name or '-' }}</td>
                                <td>{{ item.id or '-' }}</td>
                                <td>{{ item.company or '-' }}</td>
                                <td>{{ item.bizno or '-' }}</td>
                            {% endif %}
                            {% if mode == 'edit' or mode == 'register' %}
                            <td>
                                <button type="button" 
                                        class="list-field-remove-btn-{{ col.column_key }}"
                                        onclick="removeItem_{{ col.column_key }}({{ loop.index0 }})">
                                    삭제
                                </button>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr id="{{ col.column_key }}_empty_row">
                            <td colspan="{% if list_type == 'company' %}{% if mode == 'edit' or mode == 'register' %}4{% else %}3{% endif %}{% else %}{% if mode == 'edit' or mode == 'register' %}6{% else %}5{% endif %}{% endif %}">
                                {% if list_type == 'company' %}등록된 업체가 없습니다.{% else %}등록된 협력사 근로자가 없습니다.{% endif %}
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        <!-- 총 인원수 -->
        <div class="list-field-count-{{ col.column_key }}">
            총 <span id="{{ col.column_key }}_count">{{ list_data|length if list_data else 0 }}</span>{% if list_type == 'company' %}개{% else %}명{% endif %}
        </div>
    </div>
    
    <style>
    /* 리스트 필드 컨테이너 - 그리드 호환 */
    .list-field-container-{{ col.column_key }} {
        grid-column: 1 / -1; /* 전체 그리드 열 사용 */
        margin: 20px 0;
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    /* 헤더 */
    .list-field-header-{{ col.column_key }} {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 1px solid #dee2e6;
    }
    
    .list-field-title-{{ col.column_key }} {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: #495057;
    }
    
    .list-field-add-btn-{{ col.column_key }} {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0,123,255,0.2);
    }
    
    .list-field-add-btn-{{ col.column_key }}:hover {
        background: #0056b3;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,123,255,0.3);
    }
    
    /* 테이블 래퍼 */
    .list-field-table-wrapper-{{ col.column_key }} {
        overflow-x: auto;
        max-width: 100%;
    }
    
    /* 테이블 스타일 */
    .list-field-table-{{ col.column_key }} {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed; /* 고정 레이아웃으로 컬럼 너비 강제 고정 */
        min-width: 800px; /* 최소 너비 */
    }
    
    .list-field-table-{{ col.column_key }} th {
        background: #f1f3f4;
        padding: 12px 10px;
        text-align: left;
        font-size: 14px;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        white-space: nowrap;
    }
    
    .list-field-table-{{ col.column_key }} th:nth-child(1) { width: 8%; text-align: center; min-width: 50px; } /* No. */
    .list-field-table-{{ col.column_key }} th:nth-child(2) { width: 100px !important; min-width: 100px !important; } /* 성함 */
    .list-field-table-{{ col.column_key }} th:nth-child(3) { width: 17%; min-width: 100px; } /* ID */
    .list-field-table-{{ col.column_key }} th:nth-child(4) { width: 40%; min-width: 200px; } /* 소속업체 */
    .list-field-table-{{ col.column_key }} th:nth-child(5) { width: 140px !important; min-width: 140px !important; } /* 사업자번호 */
    .list-field-table-{{ col.column_key }} th:nth-child(6) { width: 5%; text-align: center; min-width: 60px; } /* 관리 */
    
    .list-field-table-{{ col.column_key }} td {
        padding: 12px 8px;
        font-size: 14px;
        color: #495057;
        border-bottom: 1px solid #e9ecef;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .list-field-table-{{ col.column_key }} td:nth-child(1) {
        width: 8%; text-align: center; min-width: 50px;
        font-weight: 600;
    }
    
    .list-field-table-{{ col.column_key }} td:nth-child(2) {
        width: 100px !important; min-width: 100px !important; max-width: 100px;
        overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    
    .list-field-table-{{ col.column_key }} td:nth-child(3) {
        width: 17%; min-width: 100px; max-width: 120px;
        overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    
    .list-field-table-{{ col.column_key }} td:nth-child(4) {
        width: 40%; min-width: 200px; max-width: 300px;
        overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    
    .list-field-table-{{ col.column_key }} td:nth-child(5) {
        width: 140px !important; min-width: 140px !important; max-width: 140px;
        overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    
    .list-field-table-{{ col.column_key }} td:nth-child(6) {
        width: 5%; text-align: center; min-width: 60px;
    }
    
    .list-field-table-{{ col.column_key }} tbody tr:hover {
        background: #f8f9fa;
    }
    
    .list-field-table-{{ col.column_key }} tbody tr:nth-child(even) {
        background: #fdfdfd;
    }
    
    .list-field-table-{{ col.column_key }} tbody tr:nth-child(even):hover {
        background: #f8f9fa;
    }
    
    /* 삭제 버튼 */
    .list-field-remove-btn-{{ col.column_key }} {
        background: #dc3545;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .list-field-remove-btn-{{ col.column_key }}:hover {
        background: #c82333;
        transform: scale(1.05);
    }
    
    /* 빈 상태 */
    .list-field-table-{{ col.column_key }} #{{ col.column_key }}_empty_row td {
        text-align: center;
        padding: 40px;
        color: #6c757d;
        font-style: italic;
        background: #f8f9fa;
    }
    
    /* 카운트 */
    .list-field-count-{{ col.column_key }} {
        padding: 10px 20px;
        font-size: 14px;
        color: #6c757d;
        background: #f8f9fa;
        border-top: 1px solid #e9ecef;
        text-align: right;
    }
    
    .list-field-count-{{ col.column_key }} span {
        font-weight: 600;
        color: #007bff;
    }
    </style>
    
    <script>
    (function() {
        // 로컬 스코프로 격리
        var {{ col.column_key }}_data = [];

        // 렌더링 함수를 먼저 정의
        function renderTable_{{ col.column_key }}() {
            var tbody = document.getElementById('{{ col.column_key }}_tbody');
            var html = '';
            
            if ({{ col.column_key }}_data.length === 0) {
                html = '<tr id="{{ col.column_key }}_empty_row">' +
                       '<td colspan="{% if list_type == "company" %}{% if mode == "edit" or mode == "register" %}4{% else %}3{% endif %}{% else %}{% if mode == "edit" or mode == "register" %}6{% else %}5{% endif %}{% endif %}">'
                       + ({% if list_type == 'company' %}'등록된 업체가 없습니다.'{% else %}'등록된 협력사 근로자가 없습니다.'{% endif %})
                       + '</td></tr>';
            } else {
                {{ col.column_key }}_data.forEach(function(item, index) {
                    html += '<tr>' +
                           '<td>' + (index + 1) + '</td>' +
                           {% if list_type == 'company' %}
                           '<td>' + (item.name || '-') + '</td>' +
                           '<td>' + (item.bizno || '-') + '</td>' +
                           {% else %}
                           '<td>' + (item.name || '-') + '</td>' +
                           '<td>' + (item.id || '-') + '</td>' +
                           '<td>' + (item.company || '-') + '</td>' +
                           '<td>' + (item.bizno || '-') + '</td>' +
                           {% endif %}
                           {% if mode == 'edit' or mode == 'register' %}
                           '<td>' +
                           '<button type="button" class="list-field-remove-btn-{{ col.column_key }}" ' +
                           'onclick="removeItem_{{ col.column_key }}(' + index + ')">삭제</button>' +
                           '</td>' +
                           {% endif %}
                           '</tr>';
                });
            }
            
            tbody.innerHTML = html;
            
            // Update count
            document.getElementById('{{ col.column_key }}_count').textContent = {{ col.column_key }}_data.length;
            
            // Update hidden input - 중요! 전체 데이터를 확실히 저장
            var jsonData = JSON.stringify({{ col.column_key }}_data);
            var hiddenInput = document.getElementById('{{ col.column_key }}');
            if (hiddenInput) {
                hiddenInput.value = jsonData;
                console.log('{{ col.column_key }} hidden input 업데이트 완료');
                console.log('  - 데이터 개수:', {{ col.column_key }}_data.length);
                console.log('  - JSON 길이:', jsonData.length);
                console.log('  - hidden input value 확인:', hiddenInput.value.length, '문자');
                
                // 데이터 무결성 검증
                try {
                    var verifyData = JSON.parse(hiddenInput.value);
                    if (verifyData.length !== {{ col.column_key }}_data.length) {
                        console.error('{{ col.column_key }} 데이터 무결성 오류! 메모리:', {{ col.column_key }}_data.length, ', hidden:', verifyData.length);
                    } else {
                        console.log('{{ col.column_key }} 데이터 무결성 검증 통과');
                    }
                } catch(e) {
                    console.error('{{ col.column_key }} 데이터 무결성 검증 실패:', e);
                }
            } else {
                console.error('{{ col.column_key }} hidden input을 찾을 수 없습니다!');
            }
        }
        
        // 초기 데이터 로드 - JavaScript 변수 사용
        function loadInitialData_{{ col.column_key }}() {
            console.log('🔄 {{ col.column_key }} 초기 데이터 로드 시작');
            try {
                // JavaScript 변수에서 직접 가져오기 (HTML 파싱 문제 해결)
                if (typeof {{ col.column_key }}_initialData !== 'undefined' && Array.isArray({{ col.column_key }}_initialData)) {
                    {{ col.column_key }}_data = [...{{ col.column_key }}_initialData];  // 복사본 생성
                    console.log('✅ {{ col.column_key }} JavaScript 변수에서 초기 데이터 로드 성공');
                    console.log('📊 {{ col.column_key }} 초기 데이터:', {{ col.column_key }}_data);
                    console.log('📏 {{ col.column_key }} 초기 데이터 길이:', {{ col.column_key }}_data.length);
                    
                    // 항상 테이블 렌더링하여 데이터 동기화
                    console.log('🔄 {{ col.column_key }} 초기 데이터로 테이블 렌더링 시작 (데이터:', {{ col.column_key }}_data.length, '개)');
                    renderTable_{{ col.column_key }}();
                } else {
                    console.log('⚠️ {{ col.column_key }} 초기 데이터 없음 또는 유효하지 않음');
                    // 기존 메모리 데이터가 있으면 유지, 없으면 빈 배열로 초기화
                    if (!{{ col.column_key }}_data) {
                        {{ col.column_key }}_data = [];
                        console.log('🆕 {{ col.column_key }} 메모리 데이터 새로 초기화');
                    } else {
                        console.log('💾 {{ col.column_key }} 기존 메모리 데이터 유지:', {{ col.column_key }}_data.length, '개 항목');
                    }
                }
            } catch(e) {
                console.error('❌ {{ col.column_key }} 초기 데이터 로드 실패:', e);
                // 오류 발생 시에도 기존 메모리 데이터 유지
                if (!{{ col.column_key }}_data) {
                    {{ col.column_key }}_data = [];
                    console.log('🛠️ {{ col.column_key }} 오류로 인한 메모리 데이터 새로 초기화');
                } else {
                    console.log('🛡️ {{ col.column_key }} 오류 상황에서도 기존 메모리 데이터 유지');
                }
            }
        }
        
        // DOM이 완전히 로드된 후 초기 데이터 로드 - 더 안전하게
        function safeInitialize_{{ col.column_key }}() {
            // 여러 번 시도하여 안전하게 초기화
            var retryCount = 0;
            var maxRetries = 5;
            
            function attemptLoad() {
                try {
                    var hiddenInput = document.getElementById('{{ col.column_key }}');
                    if (!hiddenInput) {
                        if (retryCount < maxRetries) {
                            retryCount++;
                            console.log('{{ col.column_key }} hidden input 찾기 재시도:', retryCount);
                            setTimeout(attemptLoad, 100);
                            return;
                        } else {
                            console.error('{{ col.column_key }} hidden input을 찾을 수 없습니다 (최대 재시도 초과)');
                            return;
                        }
                    }
                    
                    loadInitialData_{{ col.column_key }}();
                } catch(e) {
                    console.error('{{ col.column_key }} 초기화 실패:', e);
                    if (retryCount < maxRetries) {
                        retryCount++;
                        setTimeout(attemptLoad, 100);
                    }
                }
            }
            
            attemptLoad();
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', safeInitialize_{{ col.column_key }});
        } else if (document.readyState === 'interactive' || document.readyState === 'complete') {
            safeInitialize_{{ col.column_key }}();
        } else {
            // 최후의 수단
            window.addEventListener('load', safeInitialize_{{ col.column_key }});
        }
        
        // 현재 데이터를 항상 동기화하는 함수
        function syncData_{{ col.column_key }}() {
            var hiddenInput = document.getElementById('{{ col.column_key }}');
            if (!hiddenInput) return;
            
            var currentValue = hiddenInput.value;
            if (currentValue && currentValue !== '[]') {
                try {
                    var parsedData = JSON.parse(currentValue);
                    if (Array.isArray(parsedData)) {
                        {{ col.column_key }}_data = parsedData;
                        console.log('{{ col.column_key }} 데이터 동기화 완료:', {{ col.column_key }}_data.length, '개 항목');
                        return true;
                    }
                } catch(e) {
                    console.error('{{ col.column_key }} 데이터 동기화 실패:', e);
                }
            }
            return false;
        }

        // 바로 검색 팝업 띄우기
        window.addWorker_{{ col.column_key }} = function() {
            console.log('🚀 {{ col.column_key }} 팝업 열기 시작');
            console.log('📊 {{ col.column_key }} 팝업 열기 전 메모리 데이터:', {
                length: {{ col.column_key }}_data ? {{ col.column_key }}_data.length : 0,
                data: {{ col.column_key }}_data
            });
            
            // hidden input 현재 값 확인 (동기화는 하지 않음)
            var hiddenInput = document.getElementById('{{ col.column_key }}');
            if (hiddenInput) {
                console.log('💾 {{ col.column_key }} hidden input 현재 값:', hiddenInput.value);
                console.log('💾 {{ col.column_key }} hidden input 길이:', hiddenInput.value ? hiddenInput.value.length : 0);
            }
            
            // 동기화는 하지 않고 현재 메모리 데이터 신뢰
            console.log('✅ {{ col.column_key }} 현재 메모리 데이터를 신뢰하고 팝업 진행');
            console.log('📋 {{ col.column_key }} 최종 확인 - 현재 데이터:', {{ col.column_key }}_data.length, '개 항목');
            
            var callbackName = 'workerCallback_{{ col.column_key }}_' + Date.now();
            console.log('{{ col.column_key }} 검색 팝업 열기');
            console.log('현재 {{ col.column_key }}_data:', {{ col.column_key }}_data);
            console.log('현재 {{ col.column_key }}_data 길이:', {{ col.column_key }}_data.length);
            
            window[callbackName] = function(data) {
                console.log('🎯 {{ col.column_key }} 팝업에서 선택된 데이터:', data);
                console.log('🔍 {{ col.column_key }} 콜백 실행 전 기존 데이터 상태:', {
                    length: {{ col.column_key }}_data.length,
                    items: {{ col.column_key }}_data
                });
                
                // 중복 체크
                var isDuplicate = (function(){
                    var t = '{{ list_type }}';
                    if (t === 'company') {
                        return {{ col.column_key }}_data.some(function(item){ return item.bizno && data.business_number && String(item.bizno) === String(data.business_number); });
                    }
                    return {{ col.column_key }}_data.some(function(item){ return item.id && data.worker_id && String(item.id) === String(data.worker_id); });
                })();
                
                if (isDuplicate) {
                    alert('이미 추가된 근로자입니다.');
                    delete window[callbackName];
                    return;
                }
                
                console.log('✅ {{ col.column_key }} 중복 체크 통과, 새 항목 추가 진행');
                
                // 데이터 추가
                var newItem;
                if ('{{ list_type }}' === 'company') {
                    newItem = {
                        name: data.company_name || '',
                        id: '',
                        company: '',
                        bizno: data.business_number || ''
                    };
                } else {
                    newItem = {
                        name: data.worker_name || data.name || '',
                        id: data.worker_id || data.id || '',
                        company: data.company_name || '',
                        bizno: data.business_number || ''
                    };
                }
                
                console.log('📝 {{ col.column_key }} 추가할 새 항목:', newItem);
                {{ col.column_key }}_data.push(newItem);
                
                console.log('✅ {{ col.column_key }} 추가 완료! 최종 데이터:', {{ col.column_key }}_data);
                console.log('📊 {{ col.column_key }} 최종 데이터 길이:', {{ col.column_key }}_data.length);
                console.log('🔄 {{ col.column_key }} 테이블 렌더링 시작');
                
                renderTable_{{ col.column_key }}();
                
                console.log('💾 {{ col.column_key }} hidden input 값 확인:', document.getElementById('{{ col.column_key }}').value);
                
                delete window[callbackName];
            };
            
            // 검색 팝업 열기
            var searchType = ('{{ list_type }}' === 'company') ? 'company' : 'contractor';
            window.open('/search-popup?type=' + searchType + '&callback=' + callbackName, 
                       'workerPopup', 'width=900,height=600,scrollbars=yes');
        };
        
        // removeItem 함수를 전역으로 노출
        window.removeItem_{{ col.column_key }} = function(index) {
            console.log('{{ col.column_key }} 삭제 인덱스:', index);
            {{ col.column_key }}_data.splice(index, 1);
            console.log('{{ col.column_key }} 삭제 후 데이터:', {{ col.column_key }}_data);
            renderTable_{{ col.column_key }}();
        };
    })();
    </script>
{% endif %}
{% endmacro %}
