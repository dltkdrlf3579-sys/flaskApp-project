{# 리스트 필드 - V3 (카드형 렌더러) #}

{% macro render_list_field(col, col_value, section, mode='view', payload=None, feature_toggles=None) %}
{% if col.column_type == 'list' %}
    {% set _feature_toggles = feature_toggles or {} %}
    {% set _payload = payload if payload else None %}
    {% set _list_input_type = (col.input_type or col.list_item_type or '') %}
    {% if _list_input_type in ['list_company', 'company'] %}
        {% set list_type = 'company' %}
    {% elif _list_input_type in ['list_custom', 'custom'] %}
        {% set list_type = 'custom' %}
    {% else %}
        {% set list_type = 'partner_worker' %}
    {% endif %}

    {% set schema_data = _payload.schema if _payload and _payload.schema else col.child_schema %}
    {% set child_fields = schema_data.childFields if schema_data and schema_data.childFields else [] %}

    {% set normalized_rows = [] %}
    {% if _payload and _payload.rows %}
        {% set normalized_rows = _payload.rows %}
    {% elif col.list_rows is defined and col.list_rows %}
        {% set normalized_rows = col.list_rows %}
    {% elif col_value and (col_value is sequence) %}
        {% set normalized_rows = col_value %}
    {% endif %}
    {% if normalized_rows is string %}
        {% set normalized_rows = normalized_rows|from_json %}
    {% endif %}
    {% if normalized_rows is none %}
        {% set normalized_rows = [] %}
    {% endif %}

    {% set raw_json = None %}
    {% if _payload and _payload.raw %}
        {% set raw_json = _payload.raw %}
    {% elif col_value is string %}
        {% set raw_json = col_value %}
    {% elif col_value %}
        {% set raw_json = col_value|tojson %}
    {% elif col.list_raw is defined and col.list_raw %}
        {% set raw_json = col.list_raw|tojson %}
    {% else %}
        {% set raw_json = '[]' %}
    {% endif %}
    {% if raw_json is not string %}
        {% set raw_json = raw_json|tojson %}
    {% endif %}
    {% if raw_json is none %}
        {% set raw_json = '[]' %}
    {% endif %}

    {% set warnings = _payload.warnings if _payload and _payload.warnings else [] %}
    {% set errors = _payload.errors if _payload and _payload.errors else [] %}

    <div class="lfc-container" data-list-key="{{ col.column_key }}">
        <input type="hidden"
               id="{{ col.column_key }}"
               name="{{ col.column_key }}"
               class="{{ section.section_key }}-input"
               data-field="{{ col.column_key }}"
               data-field-type="list"
               data-section="{{ section.section_key }}"
               value="{{ raw_json|e }}">

        {% if child_fields %}
        <div class="lfc-card-shell" id="{{ col.column_key }}_wrapper">
            <div class="lfc-header">
                <div class="lfc-header-left">
                    <h6 class="lfc-title">{{ col.column_name }}</h6>
                    <span class="lfc-count-label">총 <span id="{{ col.column_key }}_count">0</span>개 항목</span>
                </div>
                {% if mode in ['edit', 'register'] %}
                <button type="button" class="btn btn-sm btn-primary lfc-add-btn" id="{{ col.column_key }}_addRowBtn">
                    <i class="bi bi-plus-circle"></i> 추가
                </button>
                {% endif %}
            </div>
            <div class="lfc-body" id="{{ col.column_key }}_schemaCards"></div>
            {% if warnings %}
            <div class="lfc-alert lfc-alert-warning">
                <strong>경고</strong>
                <ul>
                    {% for warn in warnings %}
                    <li>{{ warn }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            {% if errors %}
            <div class="lfc-alert lfc-alert-error">
                <strong>오류</strong>
                <ul>
                    {% for err in errors %}
                    <li>{{ err }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        {% else %}
        <div class="lfc-legacy-table">
            <div class="lfc-header">
                <div class="lfc-header-left">
                    <h6 class="lfc-title">{{ col.column_name }}</h6>
                </div>
            </div>
            <div class="lfc-table-wrapper">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th style="width: 60px;">No.</th>
                            <th>성함</th>
                            <th>ID</th>
                            <th>소속업체</th>
                            <th>사업자번호</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set _list_data = normalized_rows if normalized_rows else [] %}
                        {% if _list_data %}
                            {% for item in _list_data %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ item.name or '-' }}</td>
                                <td>{{ item.id or '-' }}</td>
                                <td>{{ item.company or '-' }}</td>
                                <td>{{ item.bizno or '-' }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">등록된 항목이 없습니다.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>

    <script>
    (function() {
        var columnKey = {{ col.column_key|tojson }};
        var mode = {{ mode|tojson }};
        var listType = {{ list_type|tojson }};
        var featureToggles = {{ _feature_toggles|tojson|safe }} || {};
        var childFields = {{ child_fields|tojson|safe }} || [];
        var initialRows = {{ normalized_rows|tojson|safe }} || [];

        var hiddenInput = document.getElementById(columnKey);
        var cardsContainer = document.getElementById(columnKey + '_schemaCards');
        var addBtn = document.getElementById(columnKey + '_addRowBtn');
        var countDisplay = document.getElementById(columnKey + '_count');
        var legacyPopupHandlers = {
            popup_person: { handler: 'openPersonSearch', endpoint: 'person', window: 'personSearch' },
            popup_company: { handler: 'openCompanySearch', endpoint: 'company', window: 'companySearch' },
            popup_department: { handler: 'openDepartmentSearch', endpoint: 'department', window: 'departmentSearch' },
            popup_building: { handler: 'openBuildingSearch', endpoint: 'building', window: 'buildingSearch' },
            popup_contractor: { handler: 'openContractorSearch', endpoint: 'contractor', window: 'contractorSearch' },
            popup_partner_worker: { handler: 'openContractorSearch', endpoint: 'contractor', window: 'contractorSearch' },
            popup_worker: { handler: 'openContractorSearch', endpoint: 'contractor', window: 'contractorSearch' },
            popup_vendor: { handler: 'openContractorSearch', endpoint: 'contractor', window: 'contractorSearch' },
            popup_division: { handler: 'openDivisionSearch', endpoint: 'division', window: 'divisionSearch' }
        };
        var lookupToPopupType = {
            person: 'popup_person',
            employee: 'popup_person',
            contractor: 'popup_contractor',
            contractor_worker: 'popup_partner_worker',
            partner_worker: 'popup_partner_worker',
            worker: 'popup_worker',
            vendor: 'popup_vendor',
            company: 'popup_company',
            organization: 'popup_company',
            department: 'popup_department',
            division: 'popup_division',
            building: 'popup_building',
            facility: 'popup_building'
        };

        if (!hiddenInput || !cardsContainer) {
            return;
        }

        injectCardStyles();

        function injectCardStyles() {
            if (document.getElementById('list-field-card-styles')) {
                return;
            }
            var style = document.createElement('style');
            style.id = 'list-field-card-styles';
            style.textContent = `
.lfc-container { margin: 16px 0; }
.lfc-card-shell { border: 1px solid #dee2e6; border-radius: 12px; background: #ffffff; box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08); overflow: hidden; }
.lfc-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; border-bottom: 1px solid #dee2e6; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); }
.lfc-header-left { display: flex; align-items: center; gap: 12px; }
.lfc-title { margin: 0; font-size: 16px; font-weight: 600; color: #374151; }
.lfc-count-label { font-size: 13px; color: #6b7280; }
.lfc-add-btn i { margin-right: 4px; }
.lfc-body { padding: 16px; display: grid; gap: 16px; }
.lfc-card { border: 1px solid #e5e7eb; border-radius: 12px; background: #ffffff; box-shadow: 0 1px 4px rgba(15, 23, 42, 0.06); }
.lfc-card-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid #e5e7eb; background: #f8fafc; }
.lfc-card-index { display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 999px; background: #e0e7ff; color: #3730a3; font-weight: 600; font-size: 13px; }
.lfc-card-body { padding: 16px; display: grid; grid-template-columns: repeat(8, minmax(0, 1fr)); gap: 14px 18px; }
.lfc-field { display: flex; flex-direction: column; gap: 6px; }
.lfc-field label { font-size: 13px; font-weight: 600; color: #475569; }
.lfc-field input[type="text"],
.lfc-field input[type="number"],
.lfc-field input[type="date"],
.lfc-field input[type="time"],
.lfc-field input[type="email"],
.lfc-field textarea,
.lfc-field select { font-size: 13px; }
.lfc-field textarea { resize: vertical; }
.lfc-input-group { display: flex; gap: 6px; }
.lfc-input-group .btn { white-space: nowrap; }
.lfc-footer { padding: 10px 18px; text-align: right; font-size: 13px; color: #6c757d; border-top: 1px solid #e9ecef; background: #f8f9fa; }
.lfc-empty { padding: 32px; text-align: center; color: #6b7280; border: 1px dashed #d1d5db; border-radius: 8px; background: #f9fafb; }
.lfc-alert { margin: 12px 18px 18px; padding: 12px 16px; border-radius: 8px; font-size: 13px; }
.lfc-alert-warning { background: #fff7ed; border: 1px solid #fcd34d; color: #92400e; }
.lfc-alert-error { background: #fef2f2; border: 1px solid #fca5a5; color: #991b1b; }
.lfc-legacy-table { border: 1px solid #dee2e6; border-radius: 8px; background: #fff; }
.lfc-table-wrapper { padding: 0 18px 18px; }
@media (max-width: 992px) {
  .lfc-card-body { grid-template-columns: repeat(4, minmax(0, 1fr)); }
}
@media (max-width: 768px) {
  .lfc-card-body { grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
@media (max-width: 576px) {
  .lfc-card-body { grid-template-columns: 1fr; }
}
`;
            document.head.appendChild(style);
        }

        function inferLegacyPopupType(popupType) {
            if (!popupType) {
                return null;
            }
            if (legacyPopupHandlers[popupType]) {
                return popupType;
            }
            if (popupType.indexOf('popup_') === 0) {
                var baseKey = 'popup_' + popupType.slice(6).split('_')[0];
                if (legacyPopupHandlers[baseKey]) {
                    return baseKey;
                }
            }
            return null;
        }

        function normalizeLookupKey(value) {
            if (!value) {
                return '';
            }
            var key = String(value).trim().toLowerCase();
            key = key.replace(/[-\s]+/g, '_');
            return key;
        }

        function resolvePopupType(popupType, lookupTypeRaw) {
            var lookupType = normalizeLookupKey(lookupTypeRaw);
            if (popupType && popupType !== 'popup') {
                return popupType;
            }
            if (lookupType && lookupToPopupType[lookupType]) {
                return lookupToPopupType[lookupType];
            }
            if (popupType && popupType.indexOf('popup_') === 0 && popupType.length > 6) {
                return popupType;
            }
            return 'popup_person';
        }

        function openPopupWindow(fieldId, popupType, lookupType) {
            popupType = resolvePopupType(popupType, lookupType);
            if (!popupType) {
                return false;
            }

            var legacyKey = inferLegacyPopupType(popupType);
            var legacyConfig = legacyKey ? legacyPopupHandlers[legacyKey] : null;

            // 1) 기존 전역 함수가 있으면 그대로 사용
            if (legacyConfig && legacyConfig.handler && typeof window[legacyConfig.handler] === 'function') {
                try {
                    window[legacyConfig.handler](fieldId);
                    return true;
                } catch (err) {
                    console.warn('[list-field] legacy popup handler failed, fallback to direct open', legacyConfig.handler, err);
                }
            }

            // 2) 통합 팝업 매니저가 있으면 사용
            if (window.popupManager && typeof window.popupManager.openPopup === 'function') {
                window.popupManager.openPopup(fieldId, popupType);
                return true;
            }

            if (popupType === 'popup_table' && window.popupManager && typeof window.popupManager.openTablePopup === 'function') {
                window.popupManager.openTablePopup(fieldId);
                return true;
            }

            if (typeof window.openUniversalPopup === 'function') {
                window.openUniversalPopup(fieldId, popupType);
                return true;
            }

            // 3) 마지막 수단: 직접 window.open 수행
            var endpoint = '';
            var normalizedLookup = normalizeLookupKey(lookupType);
            if (legacyConfig && legacyConfig.endpoint) {
                endpoint = legacyConfig.endpoint;
            } else if (normalizedLookup) {
                endpoint = normalizedLookup;
            } else {
                endpoint = popupType.replace(/^popup_/, '');
            }
            if (!endpoint) {
                return false;
            }

            var width = 1000;
            var height = 600;
            var left = (window.screen.width - width) / 2;
            var top = (window.screen.height - height) / 2;
            var windowName = (legacyConfig && legacyConfig.window) ? legacyConfig.window : endpoint + 'Search';
            var options = [
                'width=' + width,
                'height=' + height,
                'left=' + left,
                'top=' + top,
                'scrollbars=yes',
                'resizable=yes',
                'toolbar=no',
                'menubar=no',
                'location=no',
                'status=no'
            ].join(',');

            var popupUrl = '/search-popup?type=' + encodeURIComponent(endpoint) + '&field=' + encodeURIComponent(fieldId);
            var popup = window.open(popupUrl, windowName, options);
            if (!popup) {
                console.warn('[list-field] popup blocked', popupUrl);
                return false;
            }
            popup.focus();
            return true;
        }

        function escapeHtml(value) {
            if (value === null || value === undefined) {
                return '';
            }
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function escapeAttr(value) {
            if (value === null || value === undefined) {
                return '';
            }
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        function cloneRow(row) {
            if (!row || typeof row !== 'object') {
                return {};
            }
            try {
                return JSON.parse(JSON.stringify(row));
            } catch (err) {
                var clone = {};
                Object.keys(row).forEach(function(key) {
                    clone[key] = row[key];
                });
                return clone;
            }
        }

        function isNoneString(value) {
            return typeof value === 'string' && value.trim().toLowerCase() === 'none';
        }

        function coerceValue(field, value) {
            var type = (field.type || '').toLowerCase();
            var metadata = field.metadata || {};
            if (type === 'checkbox') {
                return value === true || value === 'true' || value === 1 || value === '1';
            }
            if (type === 'dropdown' && (field.dropdown_multi || metadata.dropdownMulti)) {
                if (Array.isArray(value)) {
                    return value.map(function(item) { return String(item); });
                }
                if (typeof value === 'string' && value.trim()) {
                    try {
                        var parsed = JSON.parse(value);
                        if (Array.isArray(parsed)) {
                            return parsed.map(function(item) { return String(item); });
                        }
                    } catch (err) {
                        return value.split(',').map(function(item) { return item.trim(); }).filter(Boolean);
                    }
                }
                return [];
            }
            if (value === null || value === undefined || isNoneString(value)) {
                return '';
            }
            return String(value);
        }

        function normalizeRow(row) {
            var normalized = {};
            childFields.forEach(function(field) {
                var key = field.key;
                if (!key) {
                    return;
                }
                var current = row && Object.prototype.hasOwnProperty.call(row, key) ? row[key] : '';
                normalized[key] = coerceValue(field, current);
            });
            return normalized;
        }

        function resolveGridSpan(field) {
            if (!field) {
                return 2;
            }
            var metadata = field.metadata || {};
            var candidates = [
                field.gridSpan,
                field.grid_span,
                field.span,
                metadata.gridSpan,
                metadata.grid_span,
                metadata.span
            ];

            for (var i = 0; i < candidates.length; i += 1) {
                var candidate = candidates[i];
                var value = NaN;
                if (typeof candidate === 'number') {
                    value = candidate;
                } else if (typeof candidate === 'string') {
                    var match = candidate.match(/\d+/);
                    if (match) {
                        value = parseInt(match[0], 10);
                    }
                }
                if (value > 0) {
                    if (value > 8) {
                        return 8;
                    }
                    return value;
                }
            }

            return 2;
        }

        var state = {
            rows: Array.isArray(initialRows) ? initialRows.map(normalizeRow) : []
        };

        function syncHiddenInput() {
            if (!hiddenInput) {
                return;
            }
            try {
                hiddenInput.value = JSON.stringify(state.rows);
            } catch (err) {
                console.warn('[list-field] hidden input sync failed', columnKey, err);
            }
        }

        function createEmptyRow() {
            var row = {};
            childFields.forEach(function(field) {
                var type = (field.type || '').toLowerCase();
                var metadata = field.metadata || {};
                if (type === 'checkbox') {
                    row[field.key] = false;
                } else if (type === 'dropdown' && (field.dropdown_multi || metadata.dropdownMulti)) {
                    row[field.key] = [];
                } else {
                    row[field.key] = '';
                }
            });
            return row;
        }

        function ensureRowIndex(rowIndex) {
            if (!Array.isArray(state.rows)) {
                state.rows = [];
            }
            if (rowIndex >= state.rows.length) {
                for (var i = state.rows.length; i <= rowIndex; i += 1) {
                    state.rows.push(createEmptyRow());
                }
            }
        }

        function buildField(field, row, rowIndex) {
            var key = field.key || '';
            var label = field.label || key;
            var type = (field.type || 'text').toLowerCase();
            var metadata = field.metadata || {};
            var span = resolveGridSpan(field);
            var baseId = columnKey + '__' + rowIndex + '__' + key;
            var value = row && Object.prototype.hasOwnProperty.call(row, key) ? row[key] : '';
            var attrs = [
                'id="' + escapeAttr(baseId) + '"',
                'data-field="' + escapeAttr(key) + '"',
                'data-field-type="list_child"',
                'data-list-key="' + escapeAttr(columnKey) + '"',
                'data-row-index="' + rowIndex + '"'
            ];
            if (metadata.tableGroup) {
                attrs.push('data-table-group="' + escapeAttr(metadata.tableGroup) + '"');
            }
            if (metadata.tableType) {
                attrs.push('data-table-type="' + escapeAttr(metadata.tableType) + '"');
            }
            if (metadata.lookupType) {
                attrs.push('data-lookup-type="' + escapeAttr(metadata.lookupType) + '"');
            }
            if (metadata.linkedType) {
                attrs.push('data-linked-type="' + escapeAttr(metadata.linkedType) + '"');
            }
            if (metadata.autocomplete) {
                attrs.push('autocomplete="' + escapeAttr(metadata.autocomplete) + '"');
            }

            var readOnly = metadata.readOnly || mode === 'view';
            if (metadata.tableGroup && metadata.readOnly !== false && type !== 'checkbox' && type !== 'dropdown') {
                readOnly = true;
            }
            var isLinkedText = type === 'linked_text';
            if (isLinkedText) {
                readOnly = true;
            }
            var isPopupType = type.indexOf('popup') === 0 || !!metadata.lookupType;
            var isLinkedField = isLinkedText || !!metadata.linkedField || !!metadata.tableGroup || !!metadata.linkedType;

            var cssClasses = ['form-control', 'form-control-sm'];
            if (metadata.inputClass) {
                cssClasses = cssClasses.concat(String(metadata.inputClass).split(/\s+/).filter(Boolean));
            }
            if (Array.isArray(metadata.classes)) {
                metadata.classes.forEach(function(cls) {
                    if (cls) {
                        cssClasses.push(cls);
                    }
                });
            }
            if (isLinkedField && !isPopupType) {
                cssClasses.push('linked-field');
            }
            if (isPopupType) {
                cssClasses.push('popup-main-field');
            }
            var cssClass = cssClasses.join(' ').trim();

            var dropdownMulti = (type === 'dropdown' && (field.dropdown_multi || metadata.dropdownMulti));
            var placeholderAttr = metadata.placeholder ? ' placeholder="' + escapeAttr(metadata.placeholder) + '"' : '';
            if (!placeholderAttr && isPopupType && mode !== 'view') {
                placeholderAttr = ' placeholder="클릭하여 선택"';
            }
            var maxLengthAttr = metadata.maxLength ? ' maxlength="' + escapeAttr(metadata.maxLength) + '"' : '';
            var minAttr = metadata.min ? ' min="' + escapeAttr(metadata.min) + '"' : '';
            var maxAttr = metadata.max ? ' max="' + escapeAttr(metadata.max) + '"' : '';

            var inputHtml = '';

            if (type === 'textarea') {
                inputHtml = '<textarea ' + attrs.join(' ') + ' class="' + escapeAttr(cssClass) + '" rows="3"' + placeholderAttr + maxLengthAttr + (readOnly ? ' readonly' : '') + '>' + escapeHtml(value) + '</textarea>';
            } else if (type === 'number') {
                inputHtml = '<input type="number" ' + attrs.join(' ') + ' class="' + escapeAttr(cssClass) + '" value="' + escapeAttr(value) + '"' + minAttr + maxAttr + placeholderAttr + (readOnly ? ' readonly' : '') + '>';
            } else if (type === 'date') {
                inputHtml = '<input type="date" ' + attrs.join(' ') + ' class="' + escapeAttr(cssClass) + '" value="' + escapeAttr(value) + '"' + minAttr + maxAttr + placeholderAttr + (readOnly ? ' readonly' : '') + '>';
            } else if (type === 'time') {
                inputHtml = '<input type="time" ' + attrs.join(' ') + ' class="' + escapeAttr(cssClass) + '" value="' + escapeAttr(value) + '"' + placeholderAttr + (readOnly ? ' readonly' : '') + '>';
            } else if (type === 'checkbox') {
                inputHtml = '<div class="form-check"><input type="checkbox" ' + attrs.join(' ') + ' class="form-check-input"' + (value ? ' checked' : '') + (readOnly ? ' disabled' : '') + '></div>';
            } else if (dropdownMulti) {
                attrs.push('data-list-multi="1"');
                inputHtml = '<select ' + attrs.join(' ') + ' class="form-select form-select-sm" multiple' + (readOnly ? ' disabled' : '') + '>';
                var selectedValues = Array.isArray(value) ? value.map(String) : [];
                if (Array.isArray(field.options)) {
                    inputHtml += field.options.map(function(option) {
                        var code = option.code || option.value || '';
                        var optionLabel = option.value || option.label || code;
                        var selected = selectedValues.indexOf(String(code)) !== -1 ? ' selected' : '';
                        return '<option value="' + escapeAttr(code) + '"' + selected + '>' + escapeHtml(optionLabel) + '</option>';
                    }).join('');
                }
                inputHtml += '</select>';
            } else if (type === 'dropdown' && Array.isArray(field.options)) {
                inputHtml = '<select ' + attrs.join(' ') + ' class="form-select form-select-sm"' + (readOnly ? ' disabled' : '') + '>';
                inputHtml += '<option value="">선택하세요</option>';
                inputHtml += field.options.map(function(option) {
                    var code = option.code || option.value || '';
                    var optionLabel = option.value || option.label || code;
                    var selected = String(code) === String(value) ? ' selected' : '';
                    return '<option value="' + escapeAttr(code) + '"' + selected + '>' + escapeHtml(optionLabel) + '</option>';
                }).join('');
                inputHtml += '</select>';
            } else if (isPopupType) {
                var resolvedLookupRaw = metadata.lookupType || metadata.lookup || '';
                var resolvedLookup = normalizeLookupKey(resolvedLookupRaw);
                var popupType = (function() {
                    if (type === 'popup' && resolvedLookup) {
                        return 'popup_' + resolvedLookup;
                    }
                    if (type === 'popup') {
                        return 'popup_person';
                    }
                    if (type.indexOf('popup_') === 0) {
                        return type;
                    }
                    return 'popup_' + (resolvedLookup || 'person');
                })();
                var popupAttrs = attrs.slice();
                popupAttrs.push('style="background-color: #f8f9fa;"');
                inputHtml = '<div class="input-group lfc-input-group">';
                inputHtml += '<input type="text" ' + popupAttrs.join(' ') + ' class="' + escapeAttr(cssClass) + '" value="' + escapeAttr(value) + '"' + placeholderAttr + ' readonly data-input-type="' + escapeAttr(popupType) + '">';
                if (mode !== 'view') {
                    if (resolvedLookup) {
                        inputHtml += '<button type="button" class="btn btn-sm btn-primary" data-action="open-popup" data-target-id="' + escapeAttr(baseId) + '" data-popup-type="' + escapeAttr(popupType) + '" data-popup-lookup="' + escapeAttr(resolvedLookup) + '">검색</button>';
                    } else {
                        inputHtml += '<button type="button" class="btn btn-sm btn-primary" data-action="open-popup" data-target-id="' + escapeAttr(baseId) + '" data-popup-type="' + escapeAttr(popupType) + '">검색</button>';
                    }
                }
                inputHtml += '</div>';
            } else if (isLinkedText) {
                inputHtml = '<input type="text" ' + attrs.join(' ') + ' class="' + escapeAttr(cssClass) + '" value="' + escapeAttr(value) + '"' + placeholderAttr + maxLengthAttr + ' readonly>';
            } else {
                inputHtml = '<input type="text" ' + attrs.join(' ') + ' class="' + escapeAttr(cssClass) + '" value="' + escapeAttr(value) + '"' + placeholderAttr + maxLengthAttr + (readOnly ? ' readonly' : '') + '>';
            }

            var fieldHtml = '<div class="lfc-field" style="grid-column: span ' + span + ';" data-field-key="' + escapeAttr(key) + '">';
            fieldHtml += '<label for="' + escapeAttr(baseId) + '">' + escapeHtml(label) + '</label>';
            fieldHtml += inputHtml;
            fieldHtml += '</div>';
            return fieldHtml;
        }

        function renderCard(row, rowIndex) {
            var fieldsHtml = childFields.map(function(field) {
                return buildField(field, row, rowIndex);
            }).join('');
            var controls = '';
            if (mode !== 'view') {
                controls = '<button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-row" data-row-index="' + rowIndex + '"><i class="bi bi-trash"></i></button>';
            }
            var cardHtml = '<div class="lfc-card" data-row-index="' + rowIndex + '">';
            cardHtml += '<div class="lfc-card-header">';
            cardHtml += '<span class="lfc-card-index">' + (rowIndex + 1) + '</span>';
            cardHtml += controls;
            cardHtml += '</div>';
            cardHtml += '<div class="lfc-card-body">' + fieldsHtml + '</div>';
            cardHtml += '</div>';
            return cardHtml;
        }

        function render() {
            if (!Array.isArray(state.rows) || !state.rows.length) {
                cardsContainer.innerHTML = '<div class="lfc-empty">등록된 항목이 없습니다.</div>';
            } else {
                var html = state.rows.map(function(row, idx) {
                    return renderCard(row, idx);
                }).join('');
                cardsContainer.innerHTML = html;
            }

            if (countDisplay) {
                countDisplay.textContent = Array.isArray(state.rows) ? state.rows.length : 0;
            }

            syncHiddenInput();

            var inputs = cardsContainer.querySelectorAll('[data-field-type="list_child"]');
            inputs.forEach(function(input) {
                input.addEventListener('input', handleInputChange);
                input.addEventListener('change', handleInputChange);
            });

            if (mode !== 'view') {
                var removeButtons = cardsContainer.querySelectorAll('[data-action="remove-row"]');
                removeButtons.forEach(function(btn) {
                    btn.addEventListener('click', function(evt) {
                        var idx = parseInt(btn.getAttribute('data-row-index'), 10);
                        if (Number.isNaN(idx) || idx < 0 || idx >= state.rows.length) {
                            return;
                        }
                        if (!confirm('이 항목을 삭제하시겠습니까?')) {
                            return;
                        }
                        state.rows.splice(idx, 1);
                        render();
                    });
                });

                var popupButtons = cardsContainer.querySelectorAll('[data-action="open-popup"]');
                popupButtons.forEach(function(btn) {
                    btn.addEventListener('click', function(evt) {
                        evt.preventDefault();
                        var targetId = btn.getAttribute('data-target-id');
                        var popupType = btn.getAttribute('data-popup-type');
                        var popupLookup = btn.getAttribute('data-popup-lookup');
                        if (!targetId || !popupType) {
                            return;
                        }
                        if (!openPopupWindow(targetId, popupType, popupLookup)) {
                            alert('팝업을 열 수 없습니다. 브라우저 팝업 차단 설정을 확인해주세요.');
                        }
                    });
                });
            }
        }

        function handleInputChange(evt) {
            var input = evt.currentTarget;
            var idx = parseInt(input.getAttribute('data-row-index'), 10);
            var key = input.getAttribute('data-field');
            if (Number.isNaN(idx) || !key) {
                return;
            }
            ensureRowIndex(idx);
            var field = childFields.find(function(f) { return f.key === key; });
            if (!field) {
                return;
            }
            var type = (field.type || '').toLowerCase();
            var value;
            if (type === 'checkbox') {
                value = input.checked;
            } else if (input.dataset.listMulti === '1') {
                value = Array.from(input.options).filter(function(option) { return option.selected; }).map(function(option) { return option.value; });
            } else {
                value = input.value;
            }
            state.rows[idx][key] = value;
            syncHiddenInput();
        }

        function registerListState() {
            var registry = window.__LIST_FIELD_STATE__ = window.__LIST_FIELD_STATE__ || {};
            registry[columnKey] = {
                getRows: function() {
                    return state.rows.map(function(row) { return cloneRow(row); });
                },
                setRows: function(rows) {
                    if (!Array.isArray(rows)) {
                        return;
                    }
                    state.rows = rows.map(normalizeRow);
                    render();
                },
                addRow: function(row) {
                    if (row && typeof row === 'object') {
                        state.rows.push(normalizeRow(row));
                    } else {
                        state.rows.push(createEmptyRow());
                    }
                    render();
                }
            };
        }

        if (mode !== 'view' && addBtn) {
            addBtn.addEventListener('click', function(evt) {
                evt.preventDefault();
                state.rows.push(createEmptyRow());
                render();
            });
        }

        registerListState();
        render();
    })();
    </script>
{% endif %}
{% endmacro %}
