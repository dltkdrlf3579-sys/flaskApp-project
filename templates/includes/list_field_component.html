{# ë¦¬ìŠ¤íŠ¸ í•„ë“œ ê³µí†µ ì»´í¬ë„ŒíŠ¸ #}
{# ì‚¬ìš©ë²•: {% include 'includes/list_field_component.html' %} #}

{% macro render_list_field(col, col_value, section, mode='view') %}
    {% if col.column_type == 'list' %}
        <!-- ë¦¬ìŠ¤íŠ¸ í•„ë“œ -->
        <div class="list-field-container">
            {% set list_data = col_value | from_json if col_value else [] %}
            
            <!-- í—¤ë” ì˜ì—­ -->
            <div class="list-field-header">
                <div class="list-header-left">
                    <span class="list-field-title">{{ col.column_name }}</span>
                    <span class="list-count">ì´ <span id="{{ col.column_key }}_count">{{ list_data|length if list_data else 0 }}</span>ëª…</span>
                </div>
                {% if mode == 'edit' or mode == 'register' %}
                <div class="list-header-right">
                    <button type="button" class="btn-add-list-item" 
                            onclick="addListItem('{{ col.column_key }}', '{{ col.list_item_type }}')">
                        ì¶”ê°€
                    </button>
                </div>
                {% endif %}
            </div>
            
            <!-- í…Œì´ë¸” ì˜ì—­ -->
            <div class="list-field-table">
                <div class="list-table-header">
                    <div class="list-col-no">No.</div>
                    <div class="list-col-name">ì„±í•¨</div>
                    <div class="list-col-id">ID</div>
                    <div class="list-col-company">ì†Œì†ì—…ì²´</div>
                    <div class="list-col-bizno">ì‚¬ì—…ìë²ˆí˜¸</div>
                    {% if mode == 'edit' or mode == 'register' %}
                    <div class="list-col-action">ê´€ë¦¬</div>
                    {% endif %}
                </div>
                <div class="list-table-body" id="{{ col.column_key }}_items">
                    {% if list_data and list_data|length > 0 %}
                        {% for item in list_data %}
                        <div class="list-table-row" data-index="{{ loop.index0 }}">
                            <div class="list-col-no">{{ loop.index }}</div>
                            <div class="list-col-name">{{ item.name or '-' }}</div>
                            <div class="list-col-id">{{ item.id or '-' }}</div>
                            <div class="list-col-company">{{ item.company or '-' }}</div>
                            <div class="list-col-bizno">{{ item.bizno or '-' }}</div>
                            {% if mode == 'edit' or mode == 'register' %}
                            <div class="list-col-action">
                                <button class="btn-edit-item" onclick="editListItem('{{ col.column_key }}', {{ loop.index0 }})" title="ìˆ˜ì •">âœï¸</button>
                                <button class="btn-delete-item" onclick="removeListItem('{{ col.column_key }}', {{ loop.index0 }})" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="list-table-row no-data">
                            <div class="list-col-full">
                                {% if col.list_item_type == 'partner_worker' %}
                                    ë“±ë¡ëœ í˜‘ë ¥ì‚¬ ê·¼ë¡œìê°€ ì—†ìŠµë‹ˆë‹¤.
                                {% else %}
                                    ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <input type="hidden" 
                   id="{{ col.column_key }}" 
                   class="{{ section.section_key }}-input" 
                   data-field="{{ col.column_key }}"
                   data-section="{{ section.section_key }}"
                   data-list-type="{{ col.list_item_type }}"
                   value="{{ col_value }}">
        </div>
    {% endif %}
{% endmacro %}

{# ë¦¬ìŠ¤íŠ¸ í•„ë“œ ìŠ¤íƒ€ì¼ #}
{% macro list_field_styles() %}
<style>
/* ë¦¬ìŠ¤íŠ¸ í•„ë“œ ì»¨í…Œì´ë„ˆ */
.list-field-container {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 10px;
    width: 100%;
}

/* í—¤ë” ì˜ì—­ */
.list-field-header {
    padding: 12px 16px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #f9fafb;
    border-radius: 8px 8px 0 0;
}

.list-header-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.list-field-title {
    font-size: 14px;
    font-weight: 600;
    color: #374151;
}

.list-count {
    font-size: 13px;
    color: #6b7280;
}

.btn-add-list-item {
    padding: 5px 10px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    transition: background 0.2s;
}

.btn-add-list-item:hover {
    background: #218838;
}

/* í…Œì´ë¸” ì˜ì—­ */
.list-field-table {
    padding: 0;
}

.list-table-header {
    display: flex;
    background: #f3f4f6;
    border-bottom: 1px solid #e5e7eb;
    font-size: 13px;
    font-weight: 600;
    color: #4b5563;
}

.list-table-body {
    max-height: 300px;
    overflow-y: auto;
}

.list-table-row {
    display: flex;
    border-bottom: 1px solid #f3f4f6;
    font-size: 13px;
    background: white;
    transition: background 0.1s;
}

.list-table-row:hover {
    background: #f9fafb;
}

.list-table-row.no-data {
    padding: 20px;
    text-align: center;
    color: #6b7280;
}

/* ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì • */
.list-col-no {
    width: 50px;
    padding: 10px;
    text-align: center;
}

.list-col-name {
    flex: 1;
    min-width: 120px;
    padding: 10px;
}

.list-col-id {
    width: 100px;
    padding: 10px;
}

.list-col-company {
    flex: 1.5;
    min-width: 150px;
    padding: 10px;
}

.list-col-bizno {
    width: 130px;
    padding: 10px;
}

.list-col-action {
    width: 80px;
    padding: 10px;
    text-align: center;
}

.list-col-full {
    width: 100%;
    padding: 10px;
    text-align: center;
    color: #6b7280;
}

/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.btn-edit-item, .btn-delete-item {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    padding: 2px 4px;
    transition: transform 0.1s;
}

.btn-edit-item:hover, .btn-delete-item:hover {
    transform: scale(1.2);
}

/* í¸ì§‘ í¼ ìŠ¤íƒ€ì¼ */
.list-edit-form {
    border: 1px solid #3b82f6;
    background: #eff6ff;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 10px;
}

.list-edit-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 10px;
}

.list-edit-field label {
    display: block;
    font-size: 12px;
    color: #4b5563;
    margin-bottom: 4px;
}

.list-edit-field input {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 13px;
}

.list-edit-field input[readonly] {
    background: #f3f4f6;
    cursor: not-allowed;
}

.list-search-group {
    display: flex;
    gap: 4px;
}

.list-search-group input {
    flex: 1;
}

.list-search-group button {
    padding: 6px 10px;
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    cursor: pointer;
}

.list-search-group button:hover {
    background: #e5e7eb;
}

.list-edit-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
}

.btn-save-item, .btn-cancel-item {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    font-size: 13px;
    cursor: pointer;
}

.btn-save-item {
    background: #3b82f6;
    color: white;
}

.btn-save-item:hover {
    background: #2563eb;
}

.btn-cancel-item {
    background: #6b7280;
    color: white;
}

.btn-cancel-item:hover {
    background: #4b5563;
}
</style>
{% endmacro %}

{# JavaScript í•¨ìˆ˜ë“¤ - í˜ì´ì§€ë‹¹ í•œ ë²ˆë§Œ í¬í•¨ #}
{% macro render_list_scripts() %}
<script>
// ë¦¬ìŠ¤íŠ¸ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
if (typeof listItemCounters === 'undefined') {
    var listItemCounters = {};
}

// ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ì¶”ê°€ í•¨ìˆ˜
function addListItem(fieldKey, itemType) {
    const itemsContainer = document.getElementById(fieldKey + '_items');
    
    // "ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤" ë©”ì‹œì§€ ì œê±°
    const noDataRow = itemsContainer.querySelector('.no-data');
    if (noDataRow) {
        noDataRow.remove();
    }
    
    // ìƒˆ ì¸ë±ìŠ¤ ìƒì„±
    if (!listItemCounters[fieldKey]) {
        listItemCounters[fieldKey] = 0;
    }
    const itemIndex = listItemCounters[fieldKey]++;
    
    // í¸ì§‘ í¼ ì¶”ê°€
    const editFormDiv = document.createElement('div');
    editFormDiv.className = 'list-edit-form';
    editFormDiv.dataset.index = itemIndex;
    
    if (itemType === 'partner_worker') {
        editFormDiv.innerHTML = `
            <div class="list-edit-grid">
                <div class="list-edit-field">
                    <label>ì„±í•¨</label>
                    <div class="list-search-group">
                        <input type="text" id="${fieldKey}_${itemIndex}_name" placeholder="í´ë¦­í•˜ì—¬ ì„ íƒ" readonly>
                        <button type="button" onclick="openContractorPopup('${fieldKey}', ${itemIndex})">
                            ğŸ”
                        </button>
                    </div>
                </div>
                <div class="list-edit-field">
                    <label>ID</label>
                    <input type="text" id="${fieldKey}_${itemIndex}_id" readonly>
                </div>
                <div class="list-edit-field">
                    <label>ì†Œì†ì—…ì²´</label>
                    <input type="text" id="${fieldKey}_${itemIndex}_company" readonly>
                </div>
                <div class="list-edit-field">
                    <label>ì‚¬ì—…ìë²ˆí˜¸</label>
                    <input type="text" id="${fieldKey}_${itemIndex}_bizno" readonly>
                </div>
            </div>
            <div class="list-edit-actions">
                <button type="button" class="btn-cancel-item" onclick="cancelAddItem('${fieldKey}', ${itemIndex})">ì·¨ì†Œ</button>
                <button type="button" class="btn-save-item" onclick="saveListItem('${fieldKey}', ${itemIndex})">ì €ì¥</button>
            </div>
        `;
    }
    
    // í¸ì§‘ í¼ì„ í…Œì´ë¸”ì— ì¶”ê°€
    itemsContainer.insertBefore(editFormDiv, itemsContainer.firstChild);
}

// ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ì €ì¥
function saveListItem(fieldKey, itemIndex) {
    const name = document.getElementById(`${fieldKey}_${itemIndex}_name`).value;
    const id = document.getElementById(`${fieldKey}_${itemIndex}_id`).value;
    const company = document.getElementById(`${fieldKey}_${itemIndex}_company`).value;
    const bizno = document.getElementById(`${fieldKey}_${itemIndex}_bizno`).value;
    
    if (!name) {
        alert('ì„±í•¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const itemsContainer = document.getElementById(fieldKey + '_items');
    const editForm = itemsContainer.querySelector(`[data-index="${itemIndex}"]`);
    
    // í…Œì´ë¸” í–‰ìœ¼ë¡œ ë³€í™˜
    const rowDiv = document.createElement('div');
    rowDiv.className = 'list-table-row';
    rowDiv.dataset.index = itemIndex;
    
    // í˜„ì¬ í–‰ ê°œìˆ˜ ê³„ì‚°
    const rowCount = itemsContainer.querySelectorAll('.list-table-row').length + 1;
    
    rowDiv.innerHTML = `
        <div class="list-col-no">${rowCount}</div>
        <div class="list-col-name">${name}</div>
        <div class="list-col-id">${id}</div>
        <div class="list-col-company">${company}</div>
        <div class="list-col-bizno">${bizno}</div>
        <div class="list-col-action">
            <button class="btn-delete-item" onclick="removeListItem('${fieldKey}', ${itemIndex})" title="ì‚­ì œ">ğŸ—‘ï¸</button>
        </div>
    `;
    
    // í¸ì§‘ í¼ì„ í–‰ìœ¼ë¡œ êµì²´
    itemsContainer.replaceChild(rowDiv, editForm);
    
    // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    updateListCount(fieldKey);
    updateListData(fieldKey);
}

// ì¶”ê°€ ì·¨ì†Œ
function cancelAddItem(fieldKey, itemIndex) {
    const itemsContainer = document.getElementById(fieldKey + '_items');
    const editForm = itemsContainer.querySelector(`[data-index="${itemIndex}"]`);
    if (editForm) {
        editForm.remove();
    }
    
    // í•­ëª©ì´ ì—†ìœ¼ë©´ "ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤" ë©”ì‹œì§€ í‘œì‹œ
    if (itemsContainer.children.length === 0) {
        const noDataRow = document.createElement('div');
        noDataRow.className = 'list-table-row no-data';
        noDataRow.innerHTML = '<div class="list-col-full">ë“±ë¡ëœ í˜‘ë ¥ì‚¬ ê·¼ë¡œìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        itemsContainer.appendChild(noDataRow);
    }
}

// ë¦¬ìŠ¤íŠ¸ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
function updateListCount(fieldKey) {
    const itemsContainer = document.getElementById(fieldKey + '_items');
    const rowCount = itemsContainer.querySelectorAll('.list-table-row:not(.no-data)').length;
    const countElement = document.getElementById(fieldKey + '_count');
    if (countElement) {
        countElement.textContent = rowCount;
    }
}

// ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ì œê±° í•¨ìˆ˜
function removeListItem(fieldKey, itemIndex) {
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    const itemsContainer = document.getElementById(fieldKey + '_items');
    const itemToRemove = itemsContainer.querySelector(`[data-index="${itemIndex}"]`);
    
    if (itemToRemove) {
        itemToRemove.remove();
        
        // í–‰ ë²ˆí˜¸ ì¬ì •ë ¬
        const rows = itemsContainer.querySelectorAll('.list-table-row:not(.no-data)');
        rows.forEach((row, index) => {
            const noCol = row.querySelector('.list-col-no');
            if (noCol) {
                noCol.textContent = index + 1;
            }
        });
        
        // í•­ëª©ì´ ì—†ìœ¼ë©´ "ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤" ë©”ì‹œì§€ í‘œì‹œ
        if (rows.length === 0) {
            const noDataRow = document.createElement('div');
            noDataRow.className = 'list-table-row no-data';
            noDataRow.innerHTML = '<div class="list-col-full">ë“±ë¡ëœ í˜‘ë ¥ì‚¬ ê·¼ë¡œìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            itemsContainer.appendChild(noDataRow);
        }
        
        updateListCount(fieldKey);
        updateListData(fieldKey);
    }
}

// ë¦¬ìŠ¤íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateListData(fieldKey) {
    const itemsContainer = document.getElementById(fieldKey + '_items');
    const rows = itemsContainer.querySelectorAll('.list-table-row:not(.no-data)');
    const data = [];
    
    rows.forEach(row => {
        const name = row.querySelector('.list-col-name')?.textContent || '';
        const id = row.querySelector('.list-col-id')?.textContent || '';
        const company = row.querySelector('.list-col-company')?.textContent || '';
        const bizno = row.querySelector('.list-col-bizno')?.textContent || '';
        
        if (name && name !== '-') {
            data.push({
                name: name,
                id: id,
                company: company,
                bizno: bizno
            });
        }
    });
    
    // hidden inputì— JSON í˜•íƒœë¡œ ì €ì¥
    const hiddenInput = document.getElementById(fieldKey);
    if (hiddenInput) {
        hiddenInput.value = JSON.stringify(data);
    }
}

// í˜‘ë ¥ì‚¬ ê·¼ë¡œì íŒì—… ì—´ê¸° í•¨ìˆ˜
function openContractorPopup(fieldKey, itemIndex) {
    // ê³ ìœ í•œ ì½œë°± í•¨ìˆ˜ëª… ìƒì„±
    const callbackName = `contractorCallback_${fieldKey}_${itemIndex}`;
    
    // íŒì—…ì°½ ì—´ê¸° (contractor íƒ€ì…ê³¼ ì½œë°± ì§€ì •)
    const popup = window.open(`/search-popup?type=contractor&callback=${callbackName}`, 'contractorPopup', 
        'width=900,height=600,scrollbars=yes');
    
    // íŒì—…ì—ì„œ ì„ íƒ ì‹œ ì½œë°± ì²˜ë¦¬
    window[callbackName] = function(data) {
        // ì„ íƒëœ ë°ì´í„°ë¥¼ í•´ë‹¹ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œì˜ í•„ë“œì— ì±„ìš°ê¸°
        const nameInput = document.getElementById(`${fieldKey}_${itemIndex}_name`);
        const idInput = document.getElementById(`${fieldKey}_${itemIndex}_id`);
        const companyInput = document.getElementById(`${fieldKey}_${itemIndex}_company`);
        const biznoInput = document.getElementById(`${fieldKey}_${itemIndex}_bizno`);
        
        if (nameInput) nameInput.value = data.worker_name || '';
        if (idInput) idInput.value = data.worker_id || '';
        if (companyInput) companyInput.value = data.company_name || '';
        if (biznoInput) biznoInput.value = data.business_number || '';
        
        // ì½œë°± í•¨ìˆ˜ ì œê±°
        delete window[callbackName];
    };
}
</script>
{% endmacro %}