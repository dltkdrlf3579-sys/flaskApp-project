{# ë¦¬ìŠ¤íŠ¸ í•„ë“œ ê³µí†µ ì»´í¬ë„ŒíŠ¸ V2 - ê°œì„ ëœ ë²„ì „ #}
{# ì‚¬ìš©ë²•: {% include 'includes/list_field_component_v2.html' %} #}

{% macro render_list_field(col, col_value, section, mode='view') %}
    {% if col.column_type == 'list' %}
        {% set list_data = col_value | from_json if col_value else [] %}
        
        <!-- ë¦¬ìŠ¤íŠ¸ í•„ë“œ ì»¨í…Œì´ë„ˆ -->
        <div class="list-field-wrapper" style="width: 100%;">
            <!-- ìˆ¨ê²¨ì§„ input (ë°ì´í„° ì €ì¥ìš©) -->
            <input type="hidden" 
                   id="{{ col.column_key }}" 
                   class="{{ section.section_key }}-input" 
                   data-field="{{ col.column_key }}"
                   data-section="{{ section.section_key }}"
                   data-list-type="{{ col.list_item_type }}"
                   value="{{ col_value }}">
            
            <!-- í¸ì§‘ ëª¨ë“œì—ì„œë§Œ ì¶”ê°€ ë²„íŠ¼ í‘œì‹œ -->
            {% if mode == 'edit' or mode == 'register' %}
            <div style="margin-bottom: 10px;">
                <button type="button" class="btn btn-sm btn-success" 
                        onclick="showAddForm_{{ col.column_key }}()">
                    <i class="bi bi-plus-circle"></i> í˜‘ë ¥ì‚¬ ê·¼ë¡œì ì¶”ê°€
                </button>
            </div>
            {% endif %}
            
            <!-- ì¶”ê°€ í¼ ì˜ì—­ (ê¸°ë³¸ ìˆ¨ê¹€) -->
            <div id="{{ col.column_key }}_add_form" style="display: none; margin-bottom: 15px;">
                <div style="border: 1px solid #3b82f6; background: #eff6ff; padding: 15px; border-radius: 4px;">
                    <h6 style="margin: 0 0 10px 0; color: #1e40af;">ìƒˆ í˜‘ë ¥ì‚¬ ê·¼ë¡œì ì¶”ê°€</h6>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div>
                            <label style="display: block; font-size: 12px; color: #374151; margin-bottom: 4px;">ì„±í•¨ *</label>
                            <div style="display: flex; gap: 4px;">
                                <input type="text" 
                                       id="{{ col.column_key }}_new_name" 
                                       style="flex: 1; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;"
                                       placeholder="í´ë¦­í•˜ì—¬ ê²€ìƒ‰"
                                       readonly>
                                <button type="button" 
                                        onclick="searchContractor_{{ col.column_key }}()"
                                        style="padding: 6px 10px; background: white; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer;">
                                    ğŸ”
                                </button>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #374151; margin-bottom: 4px;">ID</label>
                            <input type="text" 
                                   id="{{ col.column_key }}_new_id" 
                                   style="width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px; background: #f3f4f6;"
                                   readonly>
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #374151; margin-bottom: 4px;">ì†Œì†ì—…ì²´</label>
                            <input type="text" 
                                   id="{{ col.column_key }}_new_company" 
                                   style="width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px; background: #f3f4f6;"
                                   readonly>
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #374151; margin-bottom: 4px;">ì‚¬ì—…ìë²ˆí˜¸</label>
                            <input type="text" 
                                   id="{{ col.column_key }}_new_bizno" 
                                   style="width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px; background: #f3f4f6;"
                                   readonly>
                        </div>
                    </div>
                    <div style="margin-top: 10px; text-align: right;">
                        <button type="button" 
                                onclick="cancelAdd_{{ col.column_key }}()"
                                style="padding: 6px 12px; background: #6b7280; color: white; border: none; border-radius: 4px; margin-right: 5px; cursor: pointer;">
                            ì·¨ì†Œ
                        </button>
                        <button type="button" 
                                onclick="saveAdd_{{ col.column_key }}()"
                                style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            ì¶”ê°€
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” -->
            <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                <!-- í…Œì´ë¸” í—¤ë” -->
                <div style="display: flex; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-size: 13px; font-weight: 600;">
                    <div style="width: 50px; padding: 10px; text-align: center; border-right: 1px solid #e5e7eb;">No.</div>
                    <div style="flex: 1; padding: 10px; border-right: 1px solid #e5e7eb;">ì„±í•¨</div>
                    <div style="width: 100px; padding: 10px; border-right: 1px solid #e5e7eb;">ID</div>
                    <div style="flex: 1.5; padding: 10px; border-right: 1px solid #e5e7eb;">ì†Œì†ì—…ì²´</div>
                    <div style="width: 130px; padding: 10px; {% if mode == 'edit' or mode == 'register' %}border-right: 1px solid #e5e7eb;{% endif %}">ì‚¬ì—…ìë²ˆí˜¸</div>
                    {% if mode == 'edit' or mode == 'register' %}
                    <div style="width: 60px; padding: 10px; text-align: center;">ì‚­ì œ</div>
                    {% endif %}
                </div>
                
                <!-- í…Œì´ë¸” ë°”ë”” -->
                <div id="{{ col.column_key }}_list_body" style="max-height: 300px; overflow-y: auto; background: white;">
                    {% if list_data and list_data|length > 0 %}
                        {% for item in list_data %}
                        <div class="{{ col.column_key }}_list_row" 
                             data-index="{{ loop.index0 }}"
                             style="display: flex; border-bottom: 1px solid #f3f4f6; font-size: 13px;">
                            <div style="width: 50px; padding: 10px; text-align: center; border-right: 1px solid #f3f4f6;">
                                {{ loop.index }}
                            </div>
                            <div style="flex: 1; padding: 10px; border-right: 1px solid #f3f4f6;">
                                {{ item.name or '-' }}
                            </div>
                            <div style="width: 100px; padding: 10px; border-right: 1px solid #f3f4f6;">
                                {{ item.id or '-' }}
                            </div>
                            <div style="flex: 1.5; padding: 10px; border-right: 1px solid #f3f4f6;">
                                {{ item.company or '-' }}
                            </div>
                            <div style="width: 130px; padding: 10px; {% if mode == 'edit' or mode == 'register' %}border-right: 1px solid #f3f4f6;{% endif %}">
                                {{ item.bizno or '-' }}
                            </div>
                            {% if mode == 'edit' or mode == 'register' %}
                            <div style="width: 60px; padding: 10px; text-align: center;">
                                <button type="button" 
                                        onclick="removeItem_{{ col.column_key }}({{ loop.index0 }})"
                                        style="background: none; border: none; color: #dc2626; cursor: pointer; font-size: 16px;"
                                        title="ì‚­ì œ">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div id="{{ col.column_key }}_empty_message" 
                             style="padding: 30px; text-align: center; color: #6b7280;">
                            ë“±ë¡ëœ í˜‘ë ¥ì‚¬ ê·¼ë¡œìê°€ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- ì¹´ìš´íŠ¸ í‘œì‹œ -->
            <div style="margin-top: 10px; font-size: 13px; color: #6b7280;">
                ì´ <span id="{{ col.column_key }}_count">{{ list_data|length if list_data else 0 }}</span>ëª…
            </div>
        </div>
        
        <!-- í•„ë“œë³„ ìŠ¤í¬ë¦½íŠ¸ -->
        <script>
        // {{ col.column_key }}ìš© ë°ì´í„° ê´€ë¦¬
        var {{ col.column_key }}_data = {{ col_value|default('[]')|safe }};
        
        // ì¶”ê°€ í¼ í‘œì‹œ
        function showAddForm_{{ col.column_key }}() {
            document.getElementById('{{ col.column_key }}_add_form').style.display = 'block';
            // í¼ ì´ˆê¸°í™”
            document.getElementById('{{ col.column_key }}_new_name').value = '';
            document.getElementById('{{ col.column_key }}_new_id').value = '';
            document.getElementById('{{ col.column_key }}_new_company').value = '';
            document.getElementById('{{ col.column_key }}_new_bizno').value = '';
        }
        
        // ì¶”ê°€ ì·¨ì†Œ
        function cancelAdd_{{ col.column_key }}() {
            document.getElementById('{{ col.column_key }}_add_form').style.display = 'none';
        }
        
        // í˜‘ë ¥ì‚¬ ê·¼ë¡œì ê²€ìƒ‰
        function searchContractor_{{ col.column_key }}() {
            const callbackName = 'contractorCallback_{{ col.column_key }}';
            
            // íŒì—… ì—´ê¸°
            const popup = window.open(`/search-popup?type=contractor&callback=${callbackName}`, 
                'contractorPopup', 'width=900,height=600,scrollbars=yes');
            
            // ì½œë°± í•¨ìˆ˜ ì •ì˜
            window[callbackName] = function(data) {
                document.getElementById('{{ col.column_key }}_new_name').value = data.worker_name || '';
                document.getElementById('{{ col.column_key }}_new_id').value = data.worker_id || '';
                document.getElementById('{{ col.column_key }}_new_company').value = data.company_name || '';
                document.getElementById('{{ col.column_key }}_new_bizno').value = data.business_number || '';
                delete window[callbackName];
            };
        }
        
        // ì¶”ê°€ ì €ì¥
        function saveAdd_{{ col.column_key }}() {
            const name = document.getElementById('{{ col.column_key }}_new_name').value;
            const id = document.getElementById('{{ col.column_key }}_new_id').value;
            const company = document.getElementById('{{ col.column_key }}_new_company').value;
            const bizno = document.getElementById('{{ col.column_key }}_new_bizno').value;
            
            if (!name) {
                alert('ì„±í•¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ë°ì´í„° ì¶”ê°€
            const newItem = { name: name, id: id, company: company, bizno: bizno };
            {{ col.column_key }}_data.push(newItem);
            
            // UI ì—…ë°ì´íŠ¸
            renderList_{{ col.column_key }}();
            
            // í¼ ìˆ¨ê¸°ê¸°
            cancelAdd_{{ col.column_key }}();
        }
        
        // í•­ëª© ì œê±°
        function removeItem_{{ col.column_key }}(index) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            {{ col.column_key }}_data.splice(index, 1);
            renderList_{{ col.column_key }}();
        }
        
        // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        function renderList_{{ col.column_key }}() {
            const container = document.getElementById('{{ col.column_key }}_list_body');
            
            if ({{ col.column_key }}_data.length === 0) {
                container.innerHTML = `
                    <div id="{{ col.column_key }}_empty_message" 
                         style="padding: 30px; text-align: center; color: #6b7280;">
                        ë“±ë¡ëœ í˜‘ë ¥ì‚¬ ê·¼ë¡œìê°€ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                `;
            } else {
                let html = '';
                {{ col.column_key }}_data.forEach((item, index) => {
                    html += `
                        <div class="{{ col.column_key }}_list_row" 
                             data-index="${index}"
                             style="display: flex; border-bottom: 1px solid #f3f4f6; font-size: 13px;">
                            <div style="width: 50px; padding: 10px; text-align: center; border-right: 1px solid #f3f4f6;">
                                ${index + 1}
                            </div>
                            <div style="flex: 1; padding: 10px; border-right: 1px solid #f3f4f6;">
                                ${item.name || '-'}
                            </div>
                            <div style="width: 100px; padding: 10px; border-right: 1px solid #f3f4f6;">
                                ${item.id || '-'}
                            </div>
                            <div style="flex: 1.5; padding: 10px; border-right: 1px solid #f3f4f6;">
                                ${item.company || '-'}
                            </div>
                            <div style="width: 130px; padding: 10px; {% if mode == 'edit' or mode == 'register' %}border-right: 1px solid #f3f4f6;{% endif %}">
                                ${item.bizno || '-'}
                            </div>
                            {% if mode == 'edit' or mode == 'register' %}
                            <div style="width: 60px; padding: 10px; text-align: center;">
                                <button type="button" 
                                        onclick="removeItem_{{ col.column_key }}(${index})"
                                        style="background: none; border: none; color: #dc2626; cursor: pointer; font-size: 16px;"
                                        title="ì‚­ì œ">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    `;
                });
                container.innerHTML = html;
            }
            
            // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            document.getElementById('{{ col.column_key }}_count').textContent = {{ col.column_key }}_data.length;
            
            // hidden input ì—…ë°ì´íŠ¸
            document.getElementById('{{ col.column_key }}').value = JSON.stringify({{ col.column_key }}_data);
        }
        </script>
    {% endif %}
{% endmacro %}